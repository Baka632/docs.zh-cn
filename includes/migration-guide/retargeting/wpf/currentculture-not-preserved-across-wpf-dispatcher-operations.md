---
ms.openlocfilehash: bd656478a55856e676853e57f3e7386ea0aa0211
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/01/2020
ms.locfileid: "85614383"
---
### <a name="currentculture-is-not-preserved-across-wpf-dispatcher-operations"></a><span data-ttu-id="e2c86-101">在 WPF 调度程序操作上不保留 CurrentCulture</span><span class="sxs-lookup"><span data-stu-id="e2c86-101">CurrentCulture is not preserved across WPF Dispatcher operations</span></span>

#### <a name="details"></a><span data-ttu-id="e2c86-102">详细信息</span><span class="sxs-lookup"><span data-stu-id="e2c86-102">Details</span></span>

<span data-ttu-id="e2c86-103">从 .NET Framework 4.6 开始，在 <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName> 中对 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 的更改将会在该调度程序操作结束时丢失。</span><span class="sxs-lookup"><span data-stu-id="e2c86-103">Beginning in the .NET Framework 4.6, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made within a <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName> will be lost at the end of that dispatcher operation.</span></span> <span data-ttu-id="e2c86-104">同样，在调度程序操作外对 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 的更改在执行该操作时可能不会反映出来。实际上，这意味着 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 更改可能不会在 WPF UI 回调和 WPF 应用程序中的其他代码之间流动。这是因为，从面向 .NET Framework 4.6 的应用开始，<xref:System.Threading.ExecutionContext?displayProperty=fullName> 中的一项更改使 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 存储在执行上下文中。</span><span class="sxs-lookup"><span data-stu-id="e2c86-104">Similarly, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made outside of a Dispatcher operation may not be reflected when that operation executes.Practically speaking, this means that <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> changes may not flow between WPF UI callbacks and other code in a WPF application.This is due to a change in <xref:System.Threading.ExecutionContext?displayProperty=fullName> that causes <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> to be stored in the execution context beginning with apps targeting the .NET Framework 4.6.</span></span> <span data-ttu-id="e2c86-105">WPF 调度程序操作存储用于启动操作的执行上下文，并在操作完成时还原以前的上下文。</span><span class="sxs-lookup"><span data-stu-id="e2c86-105">WPF dispatcher operations store the execution context used to begin the operation and restore the previous context when the operation is completed.</span></span> <span data-ttu-id="e2c86-106">由于 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 现在属于该上下文，因此，在调度程序操作中对它们所做的更改在操作之外不会保留。</span><span class="sxs-lookup"><span data-stu-id="e2c86-106">Because <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are now part of that context, changes to them within a dispatcher operation are not persisted outside of the operation.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="e2c86-107">建议</span><span class="sxs-lookup"><span data-stu-id="e2c86-107">Suggestion</span></span>

<span data-ttu-id="e2c86-108">受此更改影响的应用可在字段中存储所需的 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 或 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>，并在所有调度程序操作正文（包括 UI 事件回调处理程序）中检查是否设置了正确的 <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> 和 <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>。</span><span class="sxs-lookup"><span data-stu-id="e2c86-108">Apps affected by this change may work around it by storing the desired <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> in a field and checking in all Dispatcher operation bodies (including UI event callback handlers) that the correct <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are set.</span></span> <span data-ttu-id="e2c86-109">或者，因为在此 WPF 更改之下的 ExecutionContext 更改仅影响面向 .NET Framework 4.6 或更高版本的应用，面向 .NET Framework 4.5.2 可避免出现此中断。面向 .NET Framework 4.6 或更高版本的应用也可以通过设置以下兼容性开关解决此问题：</span><span class="sxs-lookup"><span data-stu-id="e2c86-109">Alternatively, because the ExecutionContext change underlying this WPF change only affects apps targeting the .NET Framework 4.6 or newer, this break can be avoided by targeting the .NET Framework 4.5.2.Apps that target .NET Framework 4.6 or later can also work around this by setting the following compatibility switch:</span></span>

<pre><code class="lang-csharp">AppContext.SetSwitch(&quot;Switch.System.Globalization.NoAsyncCurrentCulture&quot;, true);&#13;&#10;</code></pre>

<span data-ttu-id="e2c86-110">.NET Framework 4.6.2 中的 WPF 已修复此问题。</span><span class="sxs-lookup"><span data-stu-id="e2c86-110">This issue has been fixed by WPF in .NET Framework 4.6.2.</span></span> <span data-ttu-id="e2c86-111">.NET Frameworks 4.6、4.6.1 中也通过 [KB 3139549](https://support.microsoft.com/kb/3139549) 修复了此问题。</span><span class="sxs-lookup"><span data-stu-id="e2c86-111">It has also been fixed in .NET Frameworks 4.6, 4.6.1 through [KB 3139549](https://support.microsoft.com/kb/3139549).</span></span> <span data-ttu-id="e2c86-112">面向 .NET Framework 4.6 或更高版本的应用程序将自动在 WPF 应用程序中获取正确行为 - <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> 将在调度程序操作中保留。</span><span class="sxs-lookup"><span data-stu-id="e2c86-112">Applications targeting .NET Framework 4.6 or later will automatically get the right behavior in WPF applications - <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>) would be preserved across Dispatcher operations.</span></span>

| <span data-ttu-id="e2c86-113">“属性”</span><span class="sxs-lookup"><span data-stu-id="e2c86-113">Name</span></span>    | <span data-ttu-id="e2c86-114">“值”</span><span class="sxs-lookup"><span data-stu-id="e2c86-114">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="e2c86-115">范围</span><span class="sxs-lookup"><span data-stu-id="e2c86-115">Scope</span></span>   | <span data-ttu-id="e2c86-116">次要</span><span class="sxs-lookup"><span data-stu-id="e2c86-116">Minor</span></span>       |
| <span data-ttu-id="e2c86-117">Version</span><span class="sxs-lookup"><span data-stu-id="e2c86-117">Version</span></span> | <span data-ttu-id="e2c86-118">4.6</span><span class="sxs-lookup"><span data-stu-id="e2c86-118">4.6</span></span>         |
| <span data-ttu-id="e2c86-119">类型</span><span class="sxs-lookup"><span data-stu-id="e2c86-119">Type</span></span>    | <span data-ttu-id="e2c86-120">重定目标</span><span class="sxs-lookup"><span data-stu-id="e2c86-120">Retargeting</span></span> |

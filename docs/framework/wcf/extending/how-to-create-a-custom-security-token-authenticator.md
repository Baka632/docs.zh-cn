---
title: 如何：创建自定义安全令牌身份验证器
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
ms.assetid: 10e245f7-d31e-42e7-82a2-d5780325d372
ms.openlocfilehash: 667dc82502ba881b067b5588271947f7c18c8810
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96249249"
---
# <a name="how-to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="6498e-102">如何：创建自定义安全令牌身份验证器</span><span class="sxs-lookup"><span data-stu-id="6498e-102">How to: create a custom security token authenticator</span></span>

<span data-ttu-id="6498e-103">本主题演示如何创建自定义安全令牌身份验证器以及如何将其与自定义安全令牌管理器相集成。</span><span class="sxs-lookup"><span data-stu-id="6498e-103">This topic shows how to create a custom security token authenticator and how to integrate it with a custom security token manager.</span></span> <span data-ttu-id="6498e-104">安全令牌身份验证器可验证随传入消息一起提供的安全令牌的内容。</span><span class="sxs-lookup"><span data-stu-id="6498e-104">A security token authenticator validates the content of a security token provided with an incoming message.</span></span> <span data-ttu-id="6498e-105">如果验证成功，身份验证器将返回 <xref:System.IdentityModel.Policy.IAuthorizationPolicy> 实例的集合，该集合经过计算后可返回一组声明。</span><span class="sxs-lookup"><span data-stu-id="6498e-105">If the validation succeeds, the authenticator returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances that, when evaluated, returns a set of claims.</span></span>  
  
 <span data-ttu-id="6498e-106">若要在 Windows Communication Foundation 中使用自定义安全令牌身份验证器 (WCF) ，必须首先创建自定义凭据和安全令牌管理器实现。</span><span class="sxs-lookup"><span data-stu-id="6498e-106">To use a custom security token authenticator in Windows Communication Foundation (WCF), you must first create custom credentials and security token manager implementations.</span></span> <span data-ttu-id="6498e-107">有关创建自定义凭据和安全令牌管理器的详细信息，请参阅 [演练：创建自定义客户端和服务凭据](walkthrough-creating-custom-client-and-service-credentials.md)。</span><span class="sxs-lookup"><span data-stu-id="6498e-107">For more information about creating custom credentials and a security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>
  
## <a name="procedures"></a><span data-ttu-id="6498e-108">过程</span><span class="sxs-lookup"><span data-stu-id="6498e-108">Procedures</span></span>  
  
#### <a name="to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="6498e-109">创建自定义安全令牌身份验证器</span><span class="sxs-lookup"><span data-stu-id="6498e-109">To create a custom security token authenticator</span></span>  
  
1. <span data-ttu-id="6498e-110">定义一个从 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> 类派生的新类。</span><span class="sxs-lookup"><span data-stu-id="6498e-110">Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span>  
  
2. <span data-ttu-id="6498e-111">重写 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="6498e-111">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> method.</span></span> <span data-ttu-id="6498e-112">此方法返回 `true` 或 `false`，具体取决于自定义身份验证器是否可以验证传入的令牌类型。</span><span class="sxs-lookup"><span data-stu-id="6498e-112">The method returns `true` or `false` depending on whether the custom authenticator can validate the incoming token type or not.</span></span>  
  
3. <span data-ttu-id="6498e-113">重写 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="6498e-113">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="6498e-114">此方法需要适当地验证令牌内容。</span><span class="sxs-lookup"><span data-stu-id="6498e-114">This method needs to validate the token contents appropriately.</span></span> <span data-ttu-id="6498e-115">如果此令牌通过验证步骤，它将返回 <xref:System.IdentityModel.Policy.IAuthorizationPolicy> 实例的集合。</span><span class="sxs-lookup"><span data-stu-id="6498e-115">If the token passes the validation step, it returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances.</span></span> <span data-ttu-id="6498e-116">下面的示例使用将在后面的过程中创建的自定义授权策略实现。</span><span class="sxs-lookup"><span data-stu-id="6498e-116">The following example uses a custom authorization policy implementation that will be created in the next procedure.</span></span>  
  
     [!code-csharp[C_CustomTokenAuthenticator#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#1)]
     [!code-vb[C_CustomTokenAuthenticator#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#1)]  
  
 <span data-ttu-id="6498e-117">前面的代码在 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> 方法中返回授权策略的集合。</span><span class="sxs-lookup"><span data-stu-id="6498e-117">The previous code returns a collection of authorization policies in the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="6498e-118">WCF 不提供此接口的公共实现。</span><span class="sxs-lookup"><span data-stu-id="6498e-118">WCF does not provide a public implementation of this interface.</span></span> <span data-ttu-id="6498e-119">下面的过程演示如何针对您自己的需求实现此目的。</span><span class="sxs-lookup"><span data-stu-id="6498e-119">The following procedure shows how to do so for your own requirements.</span></span>  
  
#### <a name="to-create-a-custom-authorization-policy"></a><span data-ttu-id="6498e-120">创建自定义授权策略</span><span class="sxs-lookup"><span data-stu-id="6498e-120">To create a custom authorization policy</span></span>  
  
1. <span data-ttu-id="6498e-121">定义一个实现 <xref:System.IdentityModel.Policy.IAuthorizationPolicy> 接口的新类。</span><span class="sxs-lookup"><span data-stu-id="6498e-121">Define a new class implementing the <xref:System.IdentityModel.Policy.IAuthorizationPolicy> interface.</span></span>  
  
2. <span data-ttu-id="6498e-122">实现 <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> 只读属性。</span><span class="sxs-lookup"><span data-stu-id="6498e-122">Implement the <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> read-only property.</span></span> <span data-ttu-id="6498e-123">实现此属性的一个方法是在类构造函数中生成一个全局唯一标识符 (GUID)，并在每次请求此属性的值时返回该标识符。</span><span class="sxs-lookup"><span data-stu-id="6498e-123">One way to implement this property is to generate a globally unique identifier (GUID) in the class constructor and return it every time the value for this property is requested.</span></span>  
  
3. <span data-ttu-id="6498e-124">实现 <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> 只读属性。</span><span class="sxs-lookup"><span data-stu-id="6498e-124">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> read-only property.</span></span> <span data-ttu-id="6498e-125">此属性需要返回从令牌获取的声明集的颁发者。</span><span class="sxs-lookup"><span data-stu-id="6498e-125">This property needs to return an issuer of the claim sets that are obtained from the token.</span></span> <span data-ttu-id="6498e-126">此颁发者应该与令牌颁发者负责验证令牌内容的颁发机构相对应。</span><span class="sxs-lookup"><span data-stu-id="6498e-126">This issuer should correspond to the issuer of the token or an authority that is responsible for validating the token contents.</span></span> <span data-ttu-id="6498e-127">下面的示例使用了颁发者声明，该声明从前面的过程中创建的自定义安全令牌身份验证器传递给此类。</span><span class="sxs-lookup"><span data-stu-id="6498e-127">The following example uses the issuer claim that passed to this class from the custom security token authenticator created in the previous procedure.</span></span> <span data-ttu-id="6498e-128">自定义安全令牌身份验证器使用系统提供的声明集（由 <xref:System.IdentityModel.Claims.ClaimSet.System%2A> 属性返回）来表示用户名令牌的颁发者。</span><span class="sxs-lookup"><span data-stu-id="6498e-128">The custom security token authenticator uses the system-provided claim set (returned by the <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property) to represent the issuer of the username token.</span></span>  
  
4. <span data-ttu-id="6498e-129">实现 <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="6498e-129">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method.</span></span> <span data-ttu-id="6498e-130">此方法使用基于传入安全令牌内容的声明来填充 <xref:System.IdentityModel.Policy.EvaluationContext> 类的实例（以自变量形式传入）。</span><span class="sxs-lookup"><span data-stu-id="6498e-130">This method populates an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class (passed in as an argument) with claims that are based on the incoming security token content.</span></span> <span data-ttu-id="6498e-131">当此方法完成计算时返回 `true`。</span><span class="sxs-lookup"><span data-stu-id="6498e-131">The method returns `true` when it is done with the evaluation.</span></span> <span data-ttu-id="6498e-132">如果该实现依赖于为计算上下文提供附加信息的其他授权策略，则在计算上下文中不存在所要求的信息时，此方法可返回 `false`。</span><span class="sxs-lookup"><span data-stu-id="6498e-132">In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return `false` if the required information is not present yet in the evaluation context.</span></span> <span data-ttu-id="6498e-133">在这种情况下，如果至少有一个授权策略修改了计算上下文，则在评估为传入消息生成的所有其他授权策略之后，WCF 将再次调用方法。</span><span class="sxs-lookup"><span data-stu-id="6498e-133">In that case, WCF will call the method again after evaluating all other authorization policies generated for the incoming message if at least one of those authorization policies modified the evaluation context.</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#3)]
     [!code-vb[c_CustomTokenAuthenticator#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#3)]  

 <span data-ttu-id="6498e-134">[演练：创建自定义客户端和服务凭据](walkthrough-creating-custom-client-and-service-credentials.md) 介绍了如何创建自定义凭据和自定义安全令牌管理器。</span><span class="sxs-lookup"><span data-stu-id="6498e-134">[Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md) describes how to create custom credentials and a custom security token manager.</span></span> <span data-ttu-id="6498e-135">若要使用此处创建的自定义安全令牌身份验证器，可以修改安全令牌管理器的实现，以便从 <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> 方法返回自定义身份验证器。</span><span class="sxs-lookup"><span data-stu-id="6498e-135">To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method.</span></span> <span data-ttu-id="6498e-136">当传入适当的安全令牌要求时，该方法将返回身份验证器。</span><span class="sxs-lookup"><span data-stu-id="6498e-136">The method returns an authenticator when an appropriate security token requirement is passed in.</span></span>  
  
#### <a name="to-integrate-a-custom-security-token-authenticator-with-a-custom-security-token-manager"></a><span data-ttu-id="6498e-137">使自定义安全令牌身份验证器与自定义安全令牌管理器相集成</span><span class="sxs-lookup"><span data-stu-id="6498e-137">To integrate a custom security token authenticator with a custom security token manager</span></span>  
  
1. <span data-ttu-id="6498e-138">在自定义安全令牌管理器实现中重写 <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="6498e-138">Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method in your custom security token manager implementation.</span></span>  
  
2. <span data-ttu-id="6498e-139">向该方法添加逻辑，使其能够基于 <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> 参数返回您的自定义安全令牌身份验证器。</span><span class="sxs-lookup"><span data-stu-id="6498e-139">Add logic to the method to enable it to return your custom security token authenticator based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter.</span></span> <span data-ttu-id="6498e-140">如果令牌需求的令牌类型为用户名（由 <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> 属性表示），并且正在为其请求安全令牌身份验证器的消息方向为输入（由 <xref:System.ServiceModel.Description.MessageDirection.Input> 字段表示），则下面的示例将返回自定义安全令牌身份验证器。</span><span class="sxs-lookup"><span data-stu-id="6498e-140">The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> property) and the message direction for which the security token authenticator is being requested is input (represented by the <xref:System.ServiceModel.Description.MessageDirection.Input> field).</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#2)]
     [!code-vb[c_CustomTokenAuthenticator#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#2)]  

## <a name="see-also"></a><span data-ttu-id="6498e-141">另请参阅</span><span class="sxs-lookup"><span data-stu-id="6498e-141">See also</span></span>

- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.IdentityModel.Tokens.UserNameSecurityToken>
- [<span data-ttu-id="6498e-142">演练：创建自定义客户端和服务凭据</span><span class="sxs-lookup"><span data-stu-id="6498e-142">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="6498e-143">如何：创建自定义安全令牌提供程序</span><span class="sxs-lookup"><span data-stu-id="6498e-143">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)

---
title: 如何：导人自定义策略断言
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 1f41d787-accb-4a10-bfc6-a807671d1581
ms.openlocfilehash: fb5e3ba5faca1b32eef63ac174bcd7731ee50771
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96249145"
---
# <a name="how-to-import-custom-policy-assertions"></a><span data-ttu-id="a5043-102">如何：导人自定义策略断言</span><span class="sxs-lookup"><span data-stu-id="a5043-102">How to: Import Custom Policy Assertions</span></span>

<span data-ttu-id="a5043-103">策略断言说明服务终结点的功能和要求。</span><span class="sxs-lookup"><span data-stu-id="a5043-103">Policy assertions describe the capabilities and requirements of a service endpoint.</span></span>  <span data-ttu-id="a5043-104">客户端应用程序可以在服务元数据中使用策略断言来配置客户端绑定或自定义服务终结点的服务协定。</span><span class="sxs-lookup"><span data-stu-id="a5043-104">Client applications can use policy assertions in service metadata to configure the client binding or to customize the service contract for a service endpoint.</span></span>  
  
 <span data-ttu-id="a5043-105">自定义策略断言可通过实现 <xref:System.ServiceModel.Description.IPolicyImportExtension?displayProperty=nameWithType> 接口并将该对象传递给元数据系统或通过在应用程序配置文件中注册实现类型来导入。</span><span class="sxs-lookup"><span data-stu-id="a5043-105">Custom policy assertions are imported by implementing the <xref:System.ServiceModel.Description.IPolicyImportExtension?displayProperty=nameWithType> interface and passing that object to the metadata system or by registering the implementation type in your application configuration file.</span></span>  <span data-ttu-id="a5043-106">接口的实现 <xref:System.ServiceModel.Description.IPolicyImportExtension> 必须提供无参数的构造函数。</span><span class="sxs-lookup"><span data-stu-id="a5043-106">Implementations of the <xref:System.ServiceModel.Description.IPolicyImportExtension> interface must provide a parameterless constructor.</span></span>  
  
### <a name="to-import-custom-policy-assertions"></a><span data-ttu-id="a5043-107">导入自定义策略断言</span><span class="sxs-lookup"><span data-stu-id="a5043-107">To import custom policy assertions</span></span>  
  
1. <span data-ttu-id="a5043-108">在类上实现 <xref:System.ServiceModel.Description.IPolicyImportExtension?displayProperty=nameWithType> 接口。</span><span class="sxs-lookup"><span data-stu-id="a5043-108">Implement the <xref:System.ServiceModel.Description.IPolicyImportExtension?displayProperty=nameWithType> interface on a class.</span></span> <span data-ttu-id="a5043-109">请参见下面的过程。</span><span class="sxs-lookup"><span data-stu-id="a5043-109">See the following procedures.</span></span>  
  
2. <span data-ttu-id="a5043-110">通过以下方式之一插入自定义策略导入程序：</span><span class="sxs-lookup"><span data-stu-id="a5043-110">Insert the custom policy importer either by:</span></span>  
  
3. <span data-ttu-id="a5043-111">使用配置文件。</span><span class="sxs-lookup"><span data-stu-id="a5043-111">Using a configuration file.</span></span> <span data-ttu-id="a5043-112">请参见下面的过程。</span><span class="sxs-lookup"><span data-stu-id="a5043-112">See the following procedures.</span></span>  
  
4. <span data-ttu-id="a5043-113">将配置文件与配置的 [元数据实用工具工具一起使用 ( # A0) ](../servicemodel-metadata-utility-tool-svcutil-exe.md)。</span><span class="sxs-lookup"><span data-stu-id="a5043-113">Using a configuration file with [ServiceModel Metadata Utility Tool (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md).</span></span> <span data-ttu-id="a5043-114">请参见下面的过程。</span><span class="sxs-lookup"><span data-stu-id="a5043-114">See the following procedures.</span></span>  
  
5. <span data-ttu-id="a5043-115">以编程方式插入策略导入程序。</span><span class="sxs-lookup"><span data-stu-id="a5043-115">Programmatically inserting the policy importer.</span></span> <span data-ttu-id="a5043-116">请参见下面的过程。</span><span class="sxs-lookup"><span data-stu-id="a5043-116">See the following procedures.</span></span>  
  
### <a name="to-implement-the-systemservicemodeldescriptionipolicyimportextension-interface-on-any-class"></a><span data-ttu-id="a5043-117">在任何类上实现 System.ServiceModel.Description.IPolicyImportExtension 接口</span><span class="sxs-lookup"><span data-stu-id="a5043-117">To implement the System.ServiceModel.Description.IPolicyImportExtension interface on any class</span></span>  
  
1. <span data-ttu-id="a5043-118">在 <xref:System.ServiceModel.Description.IPolicyImportExtension.ImportPolicy%2A?displayProperty=nameWithType> 方法中，对于感兴趣的每个策略主题，通过在传递给该方法的 <xref:System.ServiceModel.Description.PolicyConversionContext?displayProperty=nameWithType> 对象上调用相应方法（具体取决于所需的断言范围），查找要导入的策略断言。</span><span class="sxs-lookup"><span data-stu-id="a5043-118">In the <xref:System.ServiceModel.Description.IPolicyImportExtension.ImportPolicy%2A?displayProperty=nameWithType> method, for each policy subject that you are interested in, find the policy assertions that you want to import by calling the appropriate method (depending upon the scope of the assertion that you want) on the <xref:System.ServiceModel.Description.PolicyConversionContext?displayProperty=nameWithType> object passed to the method.</span></span> <span data-ttu-id="a5043-119">下面的代码示例演示如何使用 <xref:System.ServiceModel.Description.PolicyAssertionCollection.Remove%2A?displayProperty=nameWithType> 方法定位自定义策略断言并在一个步骤中将该断言从集合中删除。</span><span class="sxs-lookup"><span data-stu-id="a5043-119">The following code example shows how to use the <xref:System.ServiceModel.Description.PolicyAssertionCollection.Remove%2A?displayProperty=nameWithType> method to locate the custom policy assertion and remove it from the collection in one step.</span></span> <span data-ttu-id="a5043-120">如果使用删除方法定位并删除断言，则不必执行步骤 4。</span><span class="sxs-lookup"><span data-stu-id="a5043-120">If you use the remove method to locate and remove the assertion, you do not have to perform step 4.</span></span>  
  
     [!code-csharp[CustomPolicySample#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/custompolicysample/cs/policyimporter.cs#9)]
     [!code-vb[CustomPolicySample#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/custompolicysample/vb/policyimporter.vb#9)]  
  
2. <span data-ttu-id="a5043-121">处理策略断言。</span><span class="sxs-lookup"><span data-stu-id="a5043-121">Process the policy assertions.</span></span> <span data-ttu-id="a5043-122">请注意，策略系统不会标准化嵌入的策略和 `wsp:optional`。</span><span class="sxs-lookup"><span data-stu-id="a5043-122">Note that the policy system does not normalize nested policies and `wsp:optional`.</span></span> <span data-ttu-id="a5043-123">您必须在策略导入扩展实现中处理这些结构。</span><span class="sxs-lookup"><span data-stu-id="a5043-123">You must process these constructs in your policy import extension implementation.</span></span>  
  
3. <span data-ttu-id="a5043-124">对支持策略断言指定的功能或需求的绑定或协定执行自定义。</span><span class="sxs-lookup"><span data-stu-id="a5043-124">Perform the customization to the binding or contract that supports the capability or requirement specified by the policy assertion.</span></span> <span data-ttu-id="a5043-125">断言通常指示绑定需要特定配置或特定绑定元素。</span><span class="sxs-lookup"><span data-stu-id="a5043-125">Typically assertions indicate that a binding requires a particular configuration or a specific binding element.</span></span> <span data-ttu-id="a5043-126">可以通过访问 <xref:System.ServiceModel.Description.PolicyConversionContext.BindingElements%2A?displayProperty=nameWithType> 属性来进行这些修改。</span><span class="sxs-lookup"><span data-stu-id="a5043-126">Make these modifications by accessing the <xref:System.ServiceModel.Description.PolicyConversionContext.BindingElements%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="a5043-127">其他断言需要您修改协定。</span><span class="sxs-lookup"><span data-stu-id="a5043-127">Other assertions require that you modify the contract.</span></span>  <span data-ttu-id="a5043-128">可以使用 <xref:System.ServiceModel.Description.PolicyConversionContext.Contract%2A?displayProperty=nameWithType> 属性来访问并修改该协定。</span><span class="sxs-lookup"><span data-stu-id="a5043-128">You can access and modify the contract using the <xref:System.ServiceModel.Description.PolicyConversionContext.Contract%2A?displayProperty=nameWithType> property.</span></span>  <span data-ttu-id="a5043-129">请注意，对于同一个绑定和协定，可能会多次调用策略导入程序，但导入的是不同的替代策略（如果一个替代策略导入失败）。</span><span class="sxs-lookup"><span data-stu-id="a5043-129">Note that your policy importer may get called multiple times for the same binding and contract, but different policy alternatives if importing a policy alternative fails.</span></span> <span data-ttu-id="a5043-130">你的代码应该能够处理这一行为。</span><span class="sxs-lookup"><span data-stu-id="a5043-130">Your code should be resilient to this behavior.</span></span>  
  
4. <span data-ttu-id="a5043-131">从断言集合中删除自定义策略断言。</span><span class="sxs-lookup"><span data-stu-id="a5043-131">Remove the custom policy assertion from the assertion collection.</span></span> <span data-ttu-id="a5043-132">如果不删除断言 Windows Communication Foundation (WCF) 会假定策略导入不成功且不导入关联的绑定。</span><span class="sxs-lookup"><span data-stu-id="a5043-132">If you do not remove the assertion Windows Communication Foundation (WCF) assumes that the policy import was unsuccessful and does not import the associated binding.</span></span> <span data-ttu-id="a5043-133">如果您使用 <xref:System.ServiceModel.Description.PolicyAssertionCollection.Remove%2A?displayProperty=nameWithType> 方法定位自定义策略断言并在一个步骤中将该断言从集合中删除，则不必执行此步骤。</span><span class="sxs-lookup"><span data-stu-id="a5043-133">If you used the <xref:System.ServiceModel.Description.PolicyAssertionCollection.Remove%2A?displayProperty=nameWithType> method to locate the custom policy assertion and remove it from the collection in one step you do not have to perform this step.</span></span>  
  
### <a name="to-insert-the-custom-policy-importer-into-the-metadata-system-using-a-configuration-file"></a><span data-ttu-id="a5043-134">使用配置文件将自定义策略导入程序插入到元数据系统</span><span class="sxs-lookup"><span data-stu-id="a5043-134">To insert the custom policy importer into the metadata System using a configuration file</span></span>  
  
1. <span data-ttu-id="a5043-135">将导入程序类型添加到 `<extensions>` [\<policyImporters>](../../configure-apps/file-schema/wcf/policyimporters.md) 客户端配置文件中元素内的元素中。</span><span class="sxs-lookup"><span data-stu-id="a5043-135">Add the importer type to the `<extensions>` element inside the [\<policyImporters>](../../configure-apps/file-schema/wcf/policyimporters.md) element in the client configuration file.</span></span>  
  
     [!code-xml[CustomPolicySample#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/custompolicysample/cs/client.exe.config#7)]
  
2. <span data-ttu-id="a5043-136">在客户端应用程序中，使用 <xref:System.ServiceModel.Description.MetadataResolver?displayProperty=nameWithType> 或 <xref:System.ServiceModel.Description.WsdlImporter?displayProperty=nameWithType> 解析元数据，这会自动调用导入程序。</span><span class="sxs-lookup"><span data-stu-id="a5043-136">In the client application, use the <xref:System.ServiceModel.Description.MetadataResolver?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.WsdlImporter?displayProperty=nameWithType> to resolve the metadata and the importer is invoked automatically.</span></span>  
  
     [!code-csharp[CustomPolicySample#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/custompolicysample/cs/client.cs#10)]
     [!code-vb[CustomPolicySample#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/custompolicysample/vb/client.vb#10)]  
  
### <a name="to-insert-the-custom-policy-importer-into-the-metadata-system-using-svcutilexe"></a><span data-ttu-id="a5043-137">使用 Svcutil.exe 将自定义策略导入程序插入到元数据系统</span><span class="sxs-lookup"><span data-stu-id="a5043-137">To insert the custom policy importer into the metadata system using Svcutil.exe</span></span>  
  
1. <span data-ttu-id="a5043-138">将导入程序类型添加到 `<extensions>` [\<policyImporters>](../../configure-apps/file-schema/wcf/policyimporters.md) Svcutil.exe.config 配置文件中元素内的元素中。</span><span class="sxs-lookup"><span data-stu-id="a5043-138">Add the importer type to the `<extensions>` element inside the [\<policyImporters>](../../configure-apps/file-schema/wcf/policyimporters.md) element in the Svcutil.exe.config configuration file.</span></span> <span data-ttu-id="a5043-139">也可以通过使用 `/svcutilConfig` 选项指示 Svcutil.exe 加载在其他配置文件中注册的策略导入程序类型。</span><span class="sxs-lookup"><span data-stu-id="a5043-139">You can also point Svcutil.exe to load policy importer types registered in a different configuration file by using the `/svcutilConfig` option.</span></span>  
  
2. <span data-ttu-id="a5043-140">使用工作 [元数据实用工具工具 ( # A0) ](../servicemodel-metadata-utility-tool-svcutil-exe.md) 导入元数据，并自动调用导入程序。</span><span class="sxs-lookup"><span data-stu-id="a5043-140">Use [ServiceModel Metadata Utility Tool (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) to import the metadata and the importer is invoked automatically.</span></span>  
  
### <a name="to-insert-the-custom-policy-importer-into-the-metadata-system-programmatically"></a><span data-ttu-id="a5043-141">以编程方式将自定义策略导入程序插入到元数据系统</span><span class="sxs-lookup"><span data-stu-id="a5043-141">To insert the custom policy importer into the metadata system programmatically</span></span>  
  
1. <span data-ttu-id="a5043-142">导入元数据之前，将导入程序添加到 <xref:System.ServiceModel.Description.MetadataImporter.PolicyImportExtensions%2A?displayProperty=nameWithType> 属性（例如，如果您使用的是 <xref:System.ServiceModel.Description.WsdlImporter?displayProperty=nameWithType>）。</span><span class="sxs-lookup"><span data-stu-id="a5043-142">Add the importer to the <xref:System.ServiceModel.Description.MetadataImporter.PolicyImportExtensions%2A?displayProperty=nameWithType> property (for example, if you are using the <xref:System.ServiceModel.Description.WsdlImporter?displayProperty=nameWithType>) prior to importing the metadata.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a5043-143">另请参阅</span><span class="sxs-lookup"><span data-stu-id="a5043-143">See also</span></span>

- <xref:System.ServiceModel.Description.MetadataResolver?displayProperty=nameWithType>
- <xref:System.ServiceModel.Description.WsdlImporter?displayProperty=nameWithType>
- <xref:System.ServiceModel.Description.MetadataResolver?displayProperty=nameWithType>
- [<span data-ttu-id="a5043-144">扩展元数据系统</span><span class="sxs-lookup"><span data-stu-id="a5043-144">Extending the Metadata System</span></span>](extending-the-metadata-system.md)

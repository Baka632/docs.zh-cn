---
title: 消息安全中的活动跟踪
ms.date: 03/30/2017
ms.assetid: 68862534-3b2e-4270-b097-8121b12a2c97
ms.openlocfilehash: 4ab34e3a3ef8487a747c9f9dac71a22006ea515a
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96265006"
---
# <a name="activity-tracing-in-message-security"></a><span data-ttu-id="6b17e-102">消息安全中的活动跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-102">Activity Tracing in Message Security</span></span>

<span data-ttu-id="6b17e-103">本主题描述用于安全处理的活动跟踪，这些活动跟踪发生在以下三个阶段。</span><span class="sxs-lookup"><span data-stu-id="6b17e-103">This topic describes activity tracing for security processing, which happens in the following three phases.</span></span>  
  
- <span data-ttu-id="6b17e-104">协商/SCT 交换。</span><span class="sxs-lookup"><span data-stu-id="6b17e-104">Negotiation/SCT exchange.</span></span> <span data-ttu-id="6b17e-105">这可能发生在传输层（通过二进制数据交换）或消息层（通过 SOAP 消息交换）。</span><span class="sxs-lookup"><span data-stu-id="6b17e-105">This can happen at the transport later (through binary data exchange) or message layer (through SOAP message exchanges).</span></span>  
  
- <span data-ttu-id="6b17e-106">消息加密/解密（带有签名验证和身份验证）。</span><span class="sxs-lookup"><span data-stu-id="6b17e-106">Message encryption/decryption, with signature verification and authentication.</span></span> <span data-ttu-id="6b17e-107">跟踪出现在环境活动（通常为“进程操作”）中。</span><span class="sxs-lookup"><span data-stu-id="6b17e-107">Traces appear in the ambient activity, typically "Process Action."</span></span>  
  
- <span data-ttu-id="6b17e-108">授权和验证。</span><span class="sxs-lookup"><span data-stu-id="6b17e-108">Authorization and verification.</span></span> <span data-ttu-id="6b17e-109">这可能在本地发生，或是在终结点之间进行通信时发生。</span><span class="sxs-lookup"><span data-stu-id="6b17e-109">This can happen locally or when communicating between endpoints.</span></span>  
  
## <a name="negotiationsct-exchange"></a><span data-ttu-id="6b17e-110">协商/SCT 交换</span><span class="sxs-lookup"><span data-stu-id="6b17e-110">Negotiation/SCT exchange</span></span>  

 <span data-ttu-id="6b17e-111">在协商/SCT 交换阶段，将在客户端上创建两种活动类型：“设置安全会话”和“关闭安全会话”。</span><span class="sxs-lookup"><span data-stu-id="6b17e-111">In the negotiation/SCT exchange phase, two activity types are created on the client: "Set up Secure Session" and "Close Secure Session."</span></span> <span data-ttu-id="6b17e-112">“设置安全会话”包括对 RST/RSTR/SCT 消息交换的跟踪，而“关闭安全会话”包括对“取消”消息的跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-112">"Set up Secure Session" encompasses traces for the RST/RSTR/SCT message exchanges, while "Close Secure Session" includes traces for the Cancel message.</span></span>  
  
 <span data-ttu-id="6b17e-113">在服务器上，RST/RSTR/SCT 的每个请求/答复都出现在它自己的活动中。</span><span class="sxs-lookup"><span data-stu-id="6b17e-113">On the server, each request/reply for the RST/RSTR/SCT appears in its own activity.</span></span> <span data-ttu-id="6b17e-114">如果 `propagateActivity` = `true` 在服务器和客户端上，则服务器上的活动具有相同的 ID，并在通过服务跟踪查看器查看时在 "设置安全会话" 中显示在一起。</span><span class="sxs-lookup"><span data-stu-id="6b17e-114">If `propagateActivity`=`true` on both the server and client, activities on the server have the same ID, and appear together in the "Setup Secure Session" when viewed through Service Trace Viewer.</span></span>  
  
 <span data-ttu-id="6b17e-115">此活动跟踪模型对于用户名/密码身份验证、证书身份验证和 NTLM 身份验证都有效。</span><span class="sxs-lookup"><span data-stu-id="6b17e-115">This activity tracing model is valid for user name/password authentication, certificate authentication, and NTLM authentication.</span></span>  
  
 <span data-ttu-id="6b17e-116">下表列出了用于协商和 SCT 交换的活动和跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-116">The following table lists the activities and traces for negotiation and SCT exchange.</span></span>  
  
||<span data-ttu-id="6b17e-117">发生协商/SCT 交换的时间</span><span class="sxs-lookup"><span data-stu-id="6b17e-117">Time when Negotiation/SCT exchange happens</span></span>|<span data-ttu-id="6b17e-118">活动</span><span class="sxs-lookup"><span data-stu-id="6b17e-118">Activities</span></span>|<span data-ttu-id="6b17e-119">跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-119">Traces</span></span>|  
|-|-------------------------------------------------|----------------|------------|  
|<span data-ttu-id="6b17e-120">安全传输</span><span class="sxs-lookup"><span data-stu-id="6b17e-120">Secure Transport</span></span><br /><br /> <span data-ttu-id="6b17e-121">（HTTPS、SSL）</span><span class="sxs-lookup"><span data-stu-id="6b17e-121">(HTTPS, SSL)</span></span>|<span data-ttu-id="6b17e-122">在接收到第一个消息时。</span><span class="sxs-lookup"><span data-stu-id="6b17e-122">On first message received.</span></span>|<span data-ttu-id="6b17e-123">在环境活动中发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-123">Traces are emitted in the ambient activity.</span></span>|<span data-ttu-id="6b17e-124">-Exchange 跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-124">-   Exchange traces</span></span><br /><span data-ttu-id="6b17e-125">-已建立安全通道</span><span class="sxs-lookup"><span data-stu-id="6b17e-125">-   Secure channel established</span></span><br /><span data-ttu-id="6b17e-126">-共享已获得的机密。</span><span class="sxs-lookup"><span data-stu-id="6b17e-126">-   Share secrets obtained.</span></span>|  
|<span data-ttu-id="6b17e-127">安全消息层</span><span class="sxs-lookup"><span data-stu-id="6b17e-127">Secure Message Layer</span></span><br /><br /> <span data-ttu-id="6b17e-128">(WSHTTP)</span><span class="sxs-lookup"><span data-stu-id="6b17e-128">(WSHTTP)</span></span>|<span data-ttu-id="6b17e-129">在接收到第一个消息时。</span><span class="sxs-lookup"><span data-stu-id="6b17e-129">On first message received.</span></span>|<span data-ttu-id="6b17e-130">在客户端上：</span><span class="sxs-lookup"><span data-stu-id="6b17e-130">On the client:</span></span><br /><br /> <span data-ttu-id="6b17e-131">-针对每个请求/答复 RST/RSTR/SCT，为第一条消息 "设置安全会话"。</span><span class="sxs-lookup"><span data-stu-id="6b17e-131">-   "Setup Secure Session" out of "Process Action" of that first message, for each request/reply for RST/RSTR/SCT.</span></span><br /><span data-ttu-id="6b17e-132">-取消 exchange 的 "关闭安全会话"，即 "关闭代理活动"。</span><span class="sxs-lookup"><span data-stu-id="6b17e-132">-   "Close Secure Session" for the CANCEL exchange, out of the "Close Proxy activity."</span></span> <span data-ttu-id="6b17e-133">此活动可能源自其他某个环境活动，具体取决于关闭安全会话的时间。</span><span class="sxs-lookup"><span data-stu-id="6b17e-133">This activity may happen out of some other ambient activity, depending on when the secure session is closed.</span></span><br /><br /> <span data-ttu-id="6b17e-134">在服务器上：</span><span class="sxs-lookup"><span data-stu-id="6b17e-134">On the server:</span></span><br /><br /> <span data-ttu-id="6b17e-135">-对服务器上的 RST/SCT/Cancel 的每个请求/答复提供一个 "处理操作" 活动。</span><span class="sxs-lookup"><span data-stu-id="6b17e-135">-   One "Process Action" activity for each request/reply for RST/SCT/Cancel on the server.</span></span> <span data-ttu-id="6b17e-136">如果为，则将 `propagateActivity` = `true` RST/RSTR/SCT 活动与 "设置安全会话" 合并，并将 "取消" 与来自客户端的 "关闭" 活动合并。</span><span class="sxs-lookup"><span data-stu-id="6b17e-136">If `propagateActivity`=`true`, RST/RSTR/SCT activities are merged with "Set up Security Session", and Cancel is merged with the "Close" activity from the client.</span></span><br /><br /> <span data-ttu-id="6b17e-137">“设置安全会话”有两个阶段：</span><span class="sxs-lookup"><span data-stu-id="6b17e-137">There are two stages for "Set up Secure Session":</span></span><br /><br /> <span data-ttu-id="6b17e-138">1. 身份验证协商。</span><span class="sxs-lookup"><span data-stu-id="6b17e-138">1.  Authentication negotiation.</span></span> <span data-ttu-id="6b17e-139">如果客户端已拥有正确的凭据，则此阶段是可选的。</span><span class="sxs-lookup"><span data-stu-id="6b17e-139">This is optional if the client already has the proper credentials.</span></span> <span data-ttu-id="6b17e-140">可以通过安全传输或通过消息交换完成此阶段。</span><span class="sxs-lookup"><span data-stu-id="6b17e-140">This phase can be done through secure transport, or through message exchanges.</span></span> <span data-ttu-id="6b17e-141">在后一种情况下，可能发生 1 次或 2 次 RST/RSTR 交换。</span><span class="sxs-lookup"><span data-stu-id="6b17e-141">In the latter case, 1 or 2 RST/RSTR exchanges can happen.</span></span> <span data-ttu-id="6b17e-142">对于这些交换，将在新的请求/答复活动中发出跟踪，如同以前设计的一样。</span><span class="sxs-lookup"><span data-stu-id="6b17e-142">For these exchanges, traces are emitted in new request/reply activities as previously designed.</span></span><br /><span data-ttu-id="6b17e-143">2. 安全会话建立 (SCT) ，这种情况下会发生一个 RST/RSTR 交换。</span><span class="sxs-lookup"><span data-stu-id="6b17e-143">2.  Secure session establishment (SCT), in which one RST/RSTR exchange happens here.</span></span> <span data-ttu-id="6b17e-144">此阶段具有与之前所述相同的环境活动。</span><span class="sxs-lookup"><span data-stu-id="6b17e-144">This has the same ambient activities as described previously.</span></span>|<span data-ttu-id="6b17e-145">-Exchange 跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-145">-   Exchange traces</span></span><br /><span data-ttu-id="6b17e-146">-已建立安全通道</span><span class="sxs-lookup"><span data-stu-id="6b17e-146">-   Secure channel established</span></span><br /><span data-ttu-id="6b17e-147">-共享已获得的机密。</span><span class="sxs-lookup"><span data-stu-id="6b17e-147">-   Share secrets obtained.</span></span>|  
  
> [!NOTE]
> <span data-ttu-id="6b17e-148">在混合安全模式中，协商身份验证发生在二进制交换中，但 SCT 发生在消息交换中。</span><span class="sxs-lookup"><span data-stu-id="6b17e-148">In mixed security mode, negotiation authentication happens in binary exchanges, but SCT happens in message exchange.</span></span> <span data-ttu-id="6b17e-149">在纯粹的传输模式中，协商仅发生在传输中，并且没有其他活动。</span><span class="sxs-lookup"><span data-stu-id="6b17e-149">In pure transport mode, negotiation happens only in transport with no additional activities.</span></span>  
  
## <a name="message-encryption-and-decryption"></a><span data-ttu-id="6b17e-150">消息加密和解密</span><span class="sxs-lookup"><span data-stu-id="6b17e-150">Message Encryption and Decryption</span></span>  

 <span data-ttu-id="6b17e-151">下表列出了消息加密/解密以及签名身份验证的活动和跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-151">The following table lists the activities and traces for message encryption/decryption, as well as signature authentication.</span></span>  
  
||<span data-ttu-id="6b17e-152">安全传输</span><span class="sxs-lookup"><span data-stu-id="6b17e-152">Secure Transport</span></span><br /><br /> <span data-ttu-id="6b17e-153">（HTTPS、SSL）和安全消息层</span><span class="sxs-lookup"><span data-stu-id="6b17e-153">(HTTPS, SSL) and Secure Message Layer</span></span><br /><br /> <span data-ttu-id="6b17e-154">(WSHTTP)</span><span class="sxs-lookup"><span data-stu-id="6b17e-154">(WSHTTP)</span></span>|  
|-|---------------------------------------------------------------------------------|  
|<span data-ttu-id="6b17e-155">发生消息加密/解密以及签名身份验证的时间</span><span class="sxs-lookup"><span data-stu-id="6b17e-155">Time when message encryption/decryption, as well as signature authentication happens</span></span>|<span data-ttu-id="6b17e-156">在接收到消息时</span><span class="sxs-lookup"><span data-stu-id="6b17e-156">On message received</span></span>|  
|<span data-ttu-id="6b17e-157">活动</span><span class="sxs-lookup"><span data-stu-id="6b17e-157">Activities</span></span>|<span data-ttu-id="6b17e-158">在客户端和服务器上的“进程操作”活动中发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-158">Traces are emitted in the ProcessAction activity on the client and server.</span></span>|  
|<span data-ttu-id="6b17e-159">跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-159">Traces</span></span>|<span data-ttu-id="6b17e-160">-sendSecurityHeader (发送方) ：</span><span class="sxs-lookup"><span data-stu-id="6b17e-160">-   sendSecurityHeader (sender):</span></span><br /><span data-ttu-id="6b17e-161">-签名消息</span><span class="sxs-lookup"><span data-stu-id="6b17e-161">-   Sign message</span></span><br /><span data-ttu-id="6b17e-162">-加密请求数据</span><span class="sxs-lookup"><span data-stu-id="6b17e-162">-   Encrypt request data</span></span><br /><span data-ttu-id="6b17e-163">-receiveSecurityHeader (接收方) ：</span><span class="sxs-lookup"><span data-stu-id="6b17e-163">-   receiveSecurityHeader (receiver):</span></span><br /><span data-ttu-id="6b17e-164">-验证签名</span><span class="sxs-lookup"><span data-stu-id="6b17e-164">-   Verify signature</span></span><br /><span data-ttu-id="6b17e-165">-解密响应数据</span><span class="sxs-lookup"><span data-stu-id="6b17e-165">-   Decrypt response data</span></span><br /><span data-ttu-id="6b17e-166">-身份验证</span><span class="sxs-lookup"><span data-stu-id="6b17e-166">-   Authentication</span></span>|  
  
> [!NOTE]
> <span data-ttu-id="6b17e-167">在纯粹的传输模式中，消息加密/解密仅发生在传输中，并且没有其他活动。</span><span class="sxs-lookup"><span data-stu-id="6b17e-167">In pure transport mode, message encryption/decryption happens only in transport with no additional activities.</span></span>  
  
## <a name="authorization-and-verification"></a><span data-ttu-id="6b17e-168">授权和验证</span><span class="sxs-lookup"><span data-stu-id="6b17e-168">Authorization and Verification</span></span>  

 <span data-ttu-id="6b17e-169">下表列出了授权的活动和跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-169">The following table lists the activities and traces for authorization.</span></span>  
  
||<span data-ttu-id="6b17e-170">发生授权的时间</span><span class="sxs-lookup"><span data-stu-id="6b17e-170">Time when authorization happens</span></span>|<span data-ttu-id="6b17e-171">活动</span><span class="sxs-lookup"><span data-stu-id="6b17e-171">Activities</span></span>|<span data-ttu-id="6b17e-172">跟踪</span><span class="sxs-lookup"><span data-stu-id="6b17e-172">Traces</span></span>|  
|-|-------------------------------------|----------------|------------|  
|<span data-ttu-id="6b17e-173">本地（默认）</span><span class="sxs-lookup"><span data-stu-id="6b17e-173">Local (default)</span></span>|<span data-ttu-id="6b17e-174">在服务器上对消息进行解密之后</span><span class="sxs-lookup"><span data-stu-id="6b17e-174">After the message is decrypted on the server</span></span>|<span data-ttu-id="6b17e-175">在服务器上的“进程操作”活动中发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-175">Traces are emitted in the ProcessAction activity at the server.</span></span>|<span data-ttu-id="6b17e-176">已授权用户。</span><span class="sxs-lookup"><span data-stu-id="6b17e-176">User authorized.</span></span>|  
|<span data-ttu-id="6b17e-177">Remote</span><span class="sxs-lookup"><span data-stu-id="6b17e-177">Remote</span></span>|<span data-ttu-id="6b17e-178">在服务器上对消息进行解密之后</span><span class="sxs-lookup"><span data-stu-id="6b17e-178">After the message is decrypted on the server</span></span>|<span data-ttu-id="6b17e-179">在由“进程操作”活动调用的新活动中发出跟踪。</span><span class="sxs-lookup"><span data-stu-id="6b17e-179">Traces are emitted in a new activity invoked by the ProcessAction activity.</span></span>|<span data-ttu-id="6b17e-180">已授权用户。</span><span class="sxs-lookup"><span data-stu-id="6b17e-180">User authorized.</span></span>|

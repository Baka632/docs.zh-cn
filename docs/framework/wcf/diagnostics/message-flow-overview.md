---
title: 消息流概述
ms.date: 03/30/2017
ms.assetid: fb0899e1-84cc-4d90-b45b-dc5a50063943
ms.openlocfilehash: cb2924b62fce62620b664efa34208deb12dd34b7
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96285533"
---
# <a name="message-flow-overview"></a><span data-ttu-id="a19e3-102">消息流概述</span><span class="sxs-lookup"><span data-stu-id="a19e3-102">Message Flow Overview</span></span>

<span data-ttu-id="a19e3-103">在包含相互连接的服务的分布式系统中，必须确定服务之间的因果关系。</span><span class="sxs-lookup"><span data-stu-id="a19e3-103">In a distributed system containing interconnected services, it is necessary to determine causal relationships between the services.</span></span> <span data-ttu-id="a19e3-104">了解作为请求流的一部分的各种组件对于支持关键方案（如运行状况监视、疑难解答和根本原因分析）非常重要。</span><span class="sxs-lookup"><span data-stu-id="a19e3-104">It is important to understand the various components that were part of a request flow to support critical scenarios such as health monitoring, troubleshooting, and root cause analysis.</span></span> <span data-ttu-id="a19e3-105">为了在各种服务之间启用跟踪相关性，我们通过以下功能在 .NET Framework 4 中添加了相关支持：</span><span class="sxs-lookup"><span data-stu-id="a19e3-105">To enable the correlation of traces between various services, in the .NET Framework 4 we added support through the following features:</span></span>

- <span data-ttu-id="a19e3-106">分析跟踪：采用 Windows 事件跟踪 (ETW) 的高性能、低详细级别的跟踪功能。</span><span class="sxs-lookup"><span data-stu-id="a19e3-106">Analytic tracing: A high performance and low verbosity tracing feature using Event Tracing for Windows (ETW).</span></span>

- <span data-ttu-id="a19e3-107">WCF/WF 服务的端到端活动模型：此功能支持由 <xref:System.ServiceModel> 和 <xref:System.Workflow.ComponentModel> 命名空间生成的跟踪相关性。</span><span class="sxs-lookup"><span data-stu-id="a19e3-107">End-to-end activity model for WCF/WF services: This feature supports correlation of traces generated by the <xref:System.ServiceModel> and <xref:System.Workflow.ComponentModel> namespaces.</span></span>

- <span data-ttu-id="a19e3-108">WF 的 ETW 跟踪：此功能使用由 WF 服务生成的跟踪记录来查看工作流的当前状态和进度。</span><span class="sxs-lookup"><span data-stu-id="a19e3-108">ETW tracking for WF: This feature uses tracking records generated by WF services to provide visibility into the workflow’s current state and progress.</span></span>

 <span data-ttu-id="a19e3-109">可使用跟踪或跟踪记录中记录的错误来查找代码缺陷或格式不正确的消息。</span><span class="sxs-lookup"><span data-stu-id="a19e3-109">Errors logged in a tracking or tracing record can be used to find code defects or incorrectly formed messages.</span></span> <span data-ttu-id="a19e3-110">可使用事件的邮件头中的“相关性”节点的 ActivityId 属性来确定出错的活动。</span><span class="sxs-lookup"><span data-stu-id="a19e3-110">The ActivityId property of the Correlation node in the event’s message header can be used to determine the faulting activity.</span></span> <span data-ttu-id="a19e3-111">若要按活动 ID 启用消息流跟踪，请参阅 [配置消息流跟踪](./etw/configuring-message-flow-tracing.md)。</span><span class="sxs-lookup"><span data-stu-id="a19e3-111">To enable message flow tracing by activity ID, see [Configuring Message Flow Tracing](./etw/configuring-message-flow-tracing.md).</span></span> <span data-ttu-id="a19e3-112">本主题演示如何在入门教程中创建的项目中启用消息流跟踪。</span><span class="sxs-lookup"><span data-stu-id="a19e3-112">This topic demonstrates how to enable message flow tracing in the project created in the Getting Started tutorial.</span></span>

### <a name="to-enable-message-flow-tracing-in-the-getting-started-tutorial"></a><span data-ttu-id="a19e3-113">在入门教程中启用消息流跟踪</span><span class="sxs-lookup"><span data-stu-id="a19e3-113">To enable message flow tracing in the Getting Started tutorial</span></span>

1. <span data-ttu-id="a19e3-114">通过单击 " **开始**"、" **运行**" 和 "输入" 打开事件查看器 `eventvwr.exe` 。</span><span class="sxs-lookup"><span data-stu-id="a19e3-114">Open Event Viewer by clicking **Start**, **Run**, and entering `eventvwr.exe`.</span></span>

2. <span data-ttu-id="a19e3-115">如果尚未启用分析跟踪，请展开 " **应用程序和服务日志**"、" **Microsoft**"、" **Windows**"、" **应用程序服务器应用程序**"。</span><span class="sxs-lookup"><span data-stu-id="a19e3-115">If you haven’t enabled analytic tracing, expand **Applications and Services Logs**, **Microsoft**, **Windows**, **Application Server-Applications**.</span></span> <span data-ttu-id="a19e3-116">选择 " **查看**"、" **显示分析和调试日志**"。</span><span class="sxs-lookup"><span data-stu-id="a19e3-116">Select **View**, **Show Analytic and Debug Logs**.</span></span> <span data-ttu-id="a19e3-117">右键单击 " **分析** "，然后选择 " **启用日志**"。</span><span class="sxs-lookup"><span data-stu-id="a19e3-117">Right-click **Analytic** and select **Enable Log**.</span></span> <span data-ttu-id="a19e3-118">将事件查看器保持打开状态，以便查看跟踪。</span><span class="sxs-lookup"><span data-stu-id="a19e3-118">Leave Event Viewer open so that traces can be viewed.</span></span>

3. <span data-ttu-id="a19e3-119">打开在 Visual Studio 2012 的 [入门教程](../getting-started-tutorial.md) 中创建的示例。</span><span class="sxs-lookup"><span data-stu-id="a19e3-119">Open the sample created in the [Getting Started Tutorial](../getting-started-tutorial.md) in Visual Studio 2012.</span></span> <span data-ttu-id="a19e3-120">请注意，必须以管理员身份运行 Visual Studio 2012，才能创建该服务。</span><span class="sxs-lookup"><span data-stu-id="a19e3-120">Note that you must run Visual Studio 2012 as an administrator so that the service can be created.</span></span> <span data-ttu-id="a19e3-121">如果已安装 WCF 示例，则可以打开 " [入门](../samples/getting-started-sample.md)"，其中包含本教程中创建的已完成项目。</span><span class="sxs-lookup"><span data-stu-id="a19e3-121">If you have the WCF samples installed, you can open the [Getting Started](../samples/getting-started-sample.md), which contains the completed project created in the tutorial.</span></span>

4. <span data-ttu-id="a19e3-122">右键单击 **服务** 项目，然后选择 " **添加**"、" **新建项**"。</span><span class="sxs-lookup"><span data-stu-id="a19e3-122">Right-click the **Service** project and select **Add**, **New Item**.</span></span> <span data-ttu-id="a19e3-123">选择 " **应用程序配置文件** "，然后单击 **"确定"**。</span><span class="sxs-lookup"><span data-stu-id="a19e3-123">Select **Application Configuration File** and click **OK**.</span></span>

5. <span data-ttu-id="a19e3-124">将下面的代码添加到上一步中创建的 App.Config 文件。</span><span class="sxs-lookup"><span data-stu-id="a19e3-124">Add the following code to the App.Config file created in the previous step.</span></span>

    ```xml
    <system.serviceModel>
      <diagnostics>
        <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
      </diagnostics>
    </system.serviceModel>
    ```

6. <span data-ttu-id="a19e3-125">通过按 Ctrl+F5 来执行该服务器应用程序而不进行调试。</span><span class="sxs-lookup"><span data-stu-id="a19e3-125">Execute the server application without debugging by pressing CTRL+F5.</span></span> <span data-ttu-id="a19e3-126">右键单击 **客户端** 项目，然后选择 " **调试**"、" **启动新实例**"，以执行客户端项目。</span><span class="sxs-lookup"><span data-stu-id="a19e3-126">Execute the client project by right-clicking the **Client** project and selecting **Debug**, **Start New Instance**.</span></span>

7. <span data-ttu-id="a19e3-127">若要跟踪从客户端到服务器的事件，请将以下内容添加到“客户端”项目中的应用程序配置文件。</span><span class="sxs-lookup"><span data-stu-id="a19e3-127">To trace the events from the client to the server, add the following to the application configuration file in the Client project.</span></span>

    ```xml
    <diagnostics>
      <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
    </diagnostics>
    ```

8. <span data-ttu-id="a19e3-128">在客户端的 Program.cs 中，添加以下 Using 语句。</span><span class="sxs-lookup"><span data-stu-id="a19e3-128">In Program.cs in the client, add the following Using statement.</span></span>

    ```csharp
    using System.Diagnostics;
    ```

9. <span data-ttu-id="a19e3-129">在客户端项目的 program.cs 文件中的 Main 方法中，将跟踪 GUID 设置为在事件日志中传播。</span><span class="sxs-lookup"><span data-stu-id="a19e3-129">In the Main method in the program.cs file in the client project, set the Trace GUID to be propagated in the event log.</span></span>

    ```csharp
    Guid guid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = guid;
    ```

10. <span data-ttu-id="a19e3-130">刷新并查看 **分析**  日志。</span><span class="sxs-lookup"><span data-stu-id="a19e3-130">Refresh and examine the **Analytic**  log.</span></span>  <span data-ttu-id="a19e3-131">查找事件 ID 为 220 的事件。</span><span class="sxs-lookup"><span data-stu-id="a19e3-131">Look for an event with Event ID 220.</span></span>  <span data-ttu-id="a19e3-132">选择该事件，并单击预览窗格中的 " **详细信息** " 选项卡。</span><span class="sxs-lookup"><span data-stu-id="a19e3-132">Select the event, and click the **Details** tab in the preview pane.</span></span> <span data-ttu-id="a19e3-133">此事件将包含调用活动的相关 ID。</span><span class="sxs-lookup"><span data-stu-id="a19e3-133">This event will contain the correlation ID for the calling activity.</span></span>

    ```xml
    <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" />
    ```

    > [!NOTE]
    > <span data-ttu-id="a19e3-134">ActivityID 中具有相同 GUID 的所有事件都与一个请求相关。</span><span class="sxs-lookup"><span data-stu-id="a19e3-134">All events with the same GUID in the ActivityID are related to one request.</span></span> <span data-ttu-id="a19e3-135">这可用于关联从特定客户端到特定服务的消息。</span><span class="sxs-lookup"><span data-stu-id="a19e3-135">This can be used to correlate messages from a specific client to a specific service.</span></span> <span data-ttu-id="a19e3-136">如果客户端调用另一个服务，则 ActivityID 可标识相同的客户端。</span><span class="sxs-lookup"><span data-stu-id="a19e3-136">If the client called another service, then the same client could be identified by ActivityID.</span></span>

11. <span data-ttu-id="a19e3-137">在某些情况下，ActivityID 可从原始 GUID 变为新 ActivityID。</span><span class="sxs-lookup"><span data-stu-id="a19e3-137">In some cases, the ActivityID can change from the original GUID to a new ActivityID.</span></span> <span data-ttu-id="a19e3-138">在此情况下，会发出一个传输事件。</span><span class="sxs-lookup"><span data-stu-id="a19e3-138">In that case, a transfer event is emitted.</span></span> <span data-ttu-id="a19e3-139">此事件 ID 为 499，并且此事件的标头中将包含以下数据。</span><span class="sxs-lookup"><span data-stu-id="a19e3-139">This event ID is 499, and the event will contain the following data in the header.</span></span>

    ```xml
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
        <System>
            <Provider Name="Microsoft-Windows-Application Server-Applications" Guid="{c651f5f6-1c0d-492e-8ae1-b4efd7c9d503}" />
            <EventID>499</EventID>
            ...
            <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" RelatedActivityID="{85FC0930-9C49-42DA-804B-A7368104BD1B}" />
            ...
       </System>
    </Event>
    ```

    > [!NOTE]
    > <span data-ttu-id="a19e3-140">此传输事件记录了活动 ActivityID 从指定为 ActivityID 的 GUID 到指定为 RelatedActivityID 的 GUID 的更改。</span><span class="sxs-lookup"><span data-stu-id="a19e3-140">The transfer event records the change of the active ActivityID from the GUID specified as the ActivityID to the GUID specified as RelatedActivityID.</span></span> <span data-ttu-id="a19e3-141">在发出此传输事件后，所有事件都将包含指定为 ActivityID 的新 GUID。</span><span class="sxs-lookup"><span data-stu-id="a19e3-141">After the transfer event is emitted, all events will contain the new GUID as the ActivityID.</span></span>

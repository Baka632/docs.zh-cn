---
title: 承载排队应用程序的 Web
ms.date: 03/30/2017
ms.assetid: c7a539fa-e442-4c08-a7f1-17b7f5a03e88
ms.openlocfilehash: c2b41ee1d0a82693760bc3e1b6144d2190153f24
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96249769"
---
# <a name="web-hosting-a-queued-application"></a><span data-ttu-id="88c45-102">承载排队应用程序的 Web</span><span class="sxs-lookup"><span data-stu-id="88c45-102">Web Hosting a Queued Application</span></span>

<span data-ttu-id="88c45-103">Windows 进程激活服务 (WAS) 管理辅助进程的激活和生命周期，这些进程包含托管 Windows Communication Foundation (WCF) 服务的应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-103">The Windows Process Activation Service (WAS) manages the activation and lifetime of the worker processes that contain applications that host Windows Communication Foundation (WCF) services.</span></span> <span data-ttu-id="88c45-104">WAS 进程模型通过删除对 HTTP 的依赖，将 HTTP 服务器的 IIS 6.0 进程模型通用化。</span><span class="sxs-lookup"><span data-stu-id="88c45-104">The WAS process model generalizes the IIS 6.0 process model for the HTTP server by removing the dependency on HTTP.</span></span> <span data-ttu-id="88c45-105">这使 WCF 服务可以在支持基于消息的激活的宿主环境中同时使用 HTTP 和非 HTTP 协议（如 msmq.formatname 和 msmq），并提供在给定计算机上托管大量应用程序的功能。</span><span class="sxs-lookup"><span data-stu-id="88c45-105">This allows WCF services to use both HTTP and non-HTTP protocols, such as net.msmq and msmq.formatname, in a hosting environment that supports message-based activation and offers the ability to host a large number of applications on a given computer.</span></span>  
  
 <span data-ttu-id="88c45-106">WAS 中包含一项消息队列 (MSMQ) 激活服务，当有一条或多条消息放入某排队的应用程序所使用的某个队列时，该服务将激活该应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-106">WAS includes a Message Queuing (MSMQ) activation service that activates a queued application when one or more messages are placed in one of the queues used by the application.</span></span> <span data-ttu-id="88c45-107">MSMQ 激活服务是默认情况下自动启动的 NT 服务。</span><span class="sxs-lookup"><span data-stu-id="88c45-107">The MSMQ activation service is an NT service that is automatically started by default.</span></span>  
  
 <span data-ttu-id="88c45-108">有关 WAS 及其优点的详细信息，请参阅 [在 Windows 进程激活服务中托管](hosting-in-windows-process-activation-service.md)。</span><span class="sxs-lookup"><span data-stu-id="88c45-108">For more information about WAS and its benefits, see [Hosting in Windows Process Activation Service](hosting-in-windows-process-activation-service.md).</span></span> <span data-ttu-id="88c45-109">有关 MSMQ 的详细信息，请参阅 [队列概述](queues-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="88c45-109">For more information about MSMQ, see [Queues Overview](queues-overview.md).</span></span>
  
## <a name="queue-addressing-in-was"></a><span data-ttu-id="88c45-110">WAS 中的队列寻址</span><span class="sxs-lookup"><span data-stu-id="88c45-110">Queue Addressing in WAS</span></span>  

 <span data-ttu-id="88c45-111">WAS 应用程序具有统一资源标识符 (URI) 地址。</span><span class="sxs-lookup"><span data-stu-id="88c45-111">WAS applications have Uniform Resource Identifier (URI) addresses.</span></span> <span data-ttu-id="88c45-112">应用程序地址有两部分：基本 URI 前缀和应用程序特定的相关地址（路径）。</span><span class="sxs-lookup"><span data-stu-id="88c45-112">Application addresses have two parts: a base URI prefix and an application-specific, relative address (path).</span></span> <span data-ttu-id="88c45-113">这两部分连接在一起时可提供应用程序的外部地址。</span><span class="sxs-lookup"><span data-stu-id="88c45-113">These two parts provide the external address for an application when joined together.</span></span> <span data-ttu-id="88c45-114">基本 URI 前缀是从站点绑定构造的，并用于站点下的所有应用程序，例如 "net.tcp：//localhost"、"msmq.formatname：//localhost" 或 "net.tcp：//localhost"。</span><span class="sxs-lookup"><span data-stu-id="88c45-114">The base URI prefix is constructed from the site binding and is used for all the applications under the site, for example, "net.msmq://localhost", "msmq.formatname://localhost", or "net.tcp://localhost".</span></span> <span data-ttu-id="88c45-115">然后，将使用应用程序特定的路径片段 (如 "/applicationOne ) "）构造应用程序地址，并将其追加到基 URI 前缀，以到达完整的应用程序 URI，例如 "//localhost/applicationOne"。</span><span class="sxs-lookup"><span data-stu-id="88c45-115">Application addresses are then constructed by taking application-specific path fragments (such as "/applicationOne") and appending them to the base URI prefix to arrive at the full application URI, for example, "net.msmq://localhost/applicationOne".</span></span>  
  
 <span data-ttu-id="88c45-116">MSMQ 激活服务使用应用程序 URI 来匹配 MSMQ 激活服务必须监视其消息的队列。</span><span class="sxs-lookup"><span data-stu-id="88c45-116">The MSMQ activation service uses the application URI to match the queue that the MSMQ activation service must monitor for messages.</span></span> <span data-ttu-id="88c45-117">MSMQ 激活服务启动时，它将枚举配置为从其中接收消息的计算机上所有的公共队列和专用队列，以及监视消息的公共队列和专用队列。</span><span class="sxs-lookup"><span data-stu-id="88c45-117">When the MSMQ activation service starts, it enumerates all public and private queues on the computer it is configured to receive from and monitors them for messages.</span></span> <span data-ttu-id="88c45-118">每隔 10 分钟，MSMQ 激活服务就刷新一次要监视的队列列表。</span><span class="sxs-lookup"><span data-stu-id="88c45-118">Every 10 minutes, the MSMQ activation service refreshes the list of queues to monitor.</span></span> <span data-ttu-id="88c45-119">在队列中找到消息时，激活服务将队列名称与 net.msmq 绑定的最长匹配应用程序 URI 进行匹配，并激活该应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-119">When a message is found in a queue, the activation service matches the queue name to the longest matching application URI for the net.msmq binding and activates the application.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="88c45-120">被激活的应用程序必须与队列名称的前缀匹配（最长的匹配）。</span><span class="sxs-lookup"><span data-stu-id="88c45-120">The application being activated must match (longest match) the prefix of the queue name.</span></span>  
  
 <span data-ttu-id="88c45-121">例如，队列名称为：msmqWebHost/orderProcessing/service.svc。</span><span class="sxs-lookup"><span data-stu-id="88c45-121">For example, a queue name is: msmqWebHost/orderProcessing/service.svc.</span></span> <span data-ttu-id="88c45-122">如果应用程序 1 的下面有一个带有 service.svc 的虚拟目录 /msmqWebHost/orderProcessing，应用程序 2 的下面有一个带有 orderProcessing.svc 的虚拟目录 /msmqWebHost，则将激活应用程序 1。</span><span class="sxs-lookup"><span data-stu-id="88c45-122">If Application 1 has a virtual directory /msmqWebHost/orderProcessing with a service.svc under it, and Application 2 has a virtual directory /msmqWebHost with an orderProcessing.svc under it, Application 1 is activated.</span></span> <span data-ttu-id="88c45-123">如果应用程序 1 已删除，则将激活应用程序 2。</span><span class="sxs-lookup"><span data-stu-id="88c45-123">If Application 1 is deleted, Application 2 is activated.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="88c45-124">创建队列后，在 MSMQ 激活服务刷新队列列表（自创建该队列时起最多 10 分钟）之前，发送到该队列的任何消息都不会激活应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-124">When a queue is created, any messages sent to it do not activate an application until the MSMQ activation service refreshes the queue list, which is, at most, 10 minutes from the time the queue was created.</span></span> <span data-ttu-id="88c45-125">重新启动激活服务也会刷新队列列表。</span><span class="sxs-lookup"><span data-stu-id="88c45-125">Restarting the activation service refreshes the queue list as well.</span></span>  
  
### <a name="the-effect-of-private-and-public-queues-on-addressing"></a><span data-ttu-id="88c45-126">专用队列和公共队列对寻址的影响</span><span class="sxs-lookup"><span data-stu-id="88c45-126">The Effect of Private and Public Queues on Addressing</span></span>  

 <span data-ttu-id="88c45-127">MSMQ 激活服务并不区分专用队列和公共队列监视。</span><span class="sxs-lookup"><span data-stu-id="88c45-127">The MSMQ activation service does not distinguish between private and public queue monitoring.</span></span> <span data-ttu-id="88c45-128">因此，您不能拥有名称相同的公共队列和专用队列。</span><span class="sxs-lookup"><span data-stu-id="88c45-128">As such, you cannot have public and private queues with the same name.</span></span> <span data-ttu-id="88c45-129">如果有，则 Web 承载的应用程序可能被激活，从这两个队列之一中进行读取。</span><span class="sxs-lookup"><span data-stu-id="88c45-129">If you do, a Web-hosted application may get activated reading from either of the queues.</span></span>  
  
### <a name="queue-configuration-for-activation"></a><span data-ttu-id="88c45-130">用于激活的队列配置</span><span class="sxs-lookup"><span data-stu-id="88c45-130">Queue Configuration for Activation</span></span>  

 <span data-ttu-id="88c45-131">MSMQ 激活服务将作为 NETWORK SERVICE 运行。</span><span class="sxs-lookup"><span data-stu-id="88c45-131">The MSMQ activation service runs as NETWORK SERVICE.</span></span> <span data-ttu-id="88c45-132">这是监视要激活应用程序的队列的服务。</span><span class="sxs-lookup"><span data-stu-id="88c45-132">It is the service that monitors queues to activate applications.</span></span> <span data-ttu-id="88c45-133">由于它将从队列激活应用程序，因此该队列必须提供 NETWORK SERVICE 访问权限以查看其访问控制列表 (ACL) 中的消息。</span><span class="sxs-lookup"><span data-stu-id="88c45-133">For it to activate applications from the queue, the queue must provide for NETWORK SERVICE access to peek for messages in its access control list (ACL).</span></span>  
  
### <a name="poison-messaging"></a><span data-ttu-id="88c45-134">病毒消息</span><span class="sxs-lookup"><span data-stu-id="88c45-134">Poison Messaging</span></span>  

 <span data-ttu-id="88c45-135">WCF 中的有害消息处理由通道进行处理，该通道不仅检测到消息是中毒的，还会根据用户配置选择一个处置。</span><span class="sxs-lookup"><span data-stu-id="88c45-135">Poison message handling in WCF is handled by the channel, which not only detects that a message is poisoned but selects a disposition based on user configuration.</span></span> <span data-ttu-id="88c45-136">因此，队列中仅有一条消息。</span><span class="sxs-lookup"><span data-stu-id="88c45-136">As a result, there is a single message in the queue.</span></span> <span data-ttu-id="88c45-137">Web 承载的应用程序可连续多次中止并将该消息移到重试队列中。</span><span class="sxs-lookup"><span data-stu-id="88c45-137">The Web-hosted application aborts successive times and the message is moved to a retry queue.</span></span> <span data-ttu-id="88c45-138">在重试周期延迟确定的点，消息从重试队列中移到主队列以便进行重试。</span><span class="sxs-lookup"><span data-stu-id="88c45-138">At a point dictated by the retry cycle delay, the message is moved from the retry queue to the main queue to try again.</span></span> <span data-ttu-id="88c45-139">但是这要求排队通道应是活动的。</span><span class="sxs-lookup"><span data-stu-id="88c45-139">But this requires the queued channel to be active.</span></span> <span data-ttu-id="88c45-140">如果 WAS 回收了该应用程序，则在另一条消息到达主队列以激活排队应用程序之前，此消息仍保留在重试队列中。</span><span class="sxs-lookup"><span data-stu-id="88c45-140">If the application is recycled by WAS, then the message remains in the retry queue until another message arrives in the main queue to activate the queued application.</span></span> <span data-ttu-id="88c45-141">本例中的解决方法就是手动将消息从重试队列移回主队列，以便重新激活应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-141">The workaround in this case is to move the message manually from the retry queue back to the main queue to reactivate the application.</span></span>  
  
### <a name="subqueue-and-system-queue-caveat"></a><span data-ttu-id="88c45-142">子队列和系统队列注意事项</span><span class="sxs-lookup"><span data-stu-id="88c45-142">Subqueue and System Queue Caveat</span></span>  

 <span data-ttu-id="88c45-143">不能基于系统队列（如系统级死信队列）或子队列（如病毒子队列）中的消息激活 WAS 承载的应用程序。</span><span class="sxs-lookup"><span data-stu-id="88c45-143">A WAS-hosted application cannot be activated based on messages in a system queue, such as the system-wide dead-letter queue, or sub-queues, such as poison sub-queues.</span></span> <span data-ttu-id="88c45-144">这是此版本产品的一个限制。</span><span class="sxs-lookup"><span data-stu-id="88c45-144">This is a limitation for this version of the product.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="88c45-145">另请参阅</span><span class="sxs-lookup"><span data-stu-id="88c45-145">See also</span></span>

- [<span data-ttu-id="88c45-146">病毒消息处理</span><span class="sxs-lookup"><span data-stu-id="88c45-146">Poison Message Handling</span></span>](poison-message-handling.md)
- [<span data-ttu-id="88c45-147">服务终结点和队列寻址</span><span class="sxs-lookup"><span data-stu-id="88c45-147">Service Endpoints and Queue Addressing</span></span>](service-endpoints-and-queue-addressing.md)

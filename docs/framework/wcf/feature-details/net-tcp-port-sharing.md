---
title: Net.TCP 端口共享
description: 了解用于高性能通信的基于 TCP 的协议，以及允许在 WCF 中的多个用户进程之间共享端口的服务。
ms.date: 03/30/2017
helpviewer_keywords:
- port activation [WCF]
- port sharing [WCF]
ms.assetid: f13692ee-a179-4439-ae72-50db9534eded
ms.openlocfilehash: 37e2c1de4516cbde58970db685422c5c65e25fb3
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96248092"
---
# <a name="nettcp-port-sharing"></a><span data-ttu-id="e3f33-103">Net.TCP 端口共享</span><span class="sxs-lookup"><span data-stu-id="e3f33-103">Net.TCP Port Sharing</span></span>

<span data-ttu-id="e3f33-104">Windows Communication Foundation (WCF) 提供了一个新的基于 TCP 的网络协议 (net.tcp：//) 以实现高性能通信。</span><span class="sxs-lookup"><span data-stu-id="e3f33-104">Windows Communication Foundation (WCF) provides a new TCP-based network protocol (net.tcp://) for high-performance communication.</span></span> <span data-ttu-id="e3f33-105">WCF 还引入了一个新的系统组件，即 Net.tcp 端口共享服务，该服务允许在多个用户进程之间共享 net.tcp 端口。</span><span class="sxs-lookup"><span data-stu-id="e3f33-105">WCF also introduces a new system component, the Net.TCP Port Sharing Service that enables net.tcp ports to be shared across multiple user processes.</span></span>  
  
## <a name="background-and-motivation"></a><span data-ttu-id="e3f33-106">背景和动机</span><span class="sxs-lookup"><span data-stu-id="e3f33-106">Background and Motivation</span></span>  

 <span data-ttu-id="e3f33-107">刚开始引入 TCP/IP 协议时，只有少量应用程序协议使用它。</span><span class="sxs-lookup"><span data-stu-id="e3f33-107">When the TCP/IP protocol was first introduced, only a small number of application protocols made use of it.</span></span> <span data-ttu-id="e3f33-108">TCP/IP 通过为每一个应用程序协议分配一个唯一的 16 位端口号，从而使用端口号来区分应用程序。</span><span class="sxs-lookup"><span data-stu-id="e3f33-108">TCP/IP used port numbers to differentiate between applications by assigning a unique 16-bit port number to each application protocol.</span></span> <span data-ttu-id="e3f33-109">例如，HTTP 通信现在已经统一为使用 TCP 端口 80，SMTP 使用 TCP 端口 25，FTP 使用 TCP 端口 20 和 21。</span><span class="sxs-lookup"><span data-stu-id="e3f33-109">For example, HTTP traffic today is standardized to use TCP port 80, SMTP uses TCP port 25, and FTP uses TCP ports 20 and 21.</span></span> <span data-ttu-id="e3f33-110">其他使用 TCP 作为传输协议的应用程序可以按习惯或遵循正式标准选择其他可用的端口号。</span><span class="sxs-lookup"><span data-stu-id="e3f33-110">Other applications using TCP as a transport can choose another available port number, either by convention or through formal standardization.</span></span>  
  
 <span data-ttu-id="e3f33-111">可使用端口号区分存在安全问题的应用程序。</span><span class="sxs-lookup"><span data-stu-id="e3f33-111">Using port numbers to distinguish between applications had security problems.</span></span> <span data-ttu-id="e3f33-112">除少数几个已知的入口点之外，防火墙通常会配置为阻塞 TCP 通信，因此，部署使用非标准端口的应用程序经常会因为存在公司防火墙和个人防火墙而变得复杂或者甚至无法实现。</span><span class="sxs-lookup"><span data-stu-id="e3f33-112">Firewalls are generally configured to block TCP traffic on all ports except for a few well-known entry points, so deploying an application that uses a non-standard port is often complicated or even impossible due to the presence of corporate and personal firewalls.</span></span> <span data-ttu-id="e3f33-113">通过已得到允许的标准已知端口进行通信的应用程序可减少外部攻击面。</span><span class="sxs-lookup"><span data-stu-id="e3f33-113">Applications that can communicate over standard, well-known ports that are already permitted, reduce the external attack surface.</span></span> <span data-ttu-id="e3f33-114">许多网络应用程序使用 HTTP 协议，这是因为大多数防火墙在默认情况下会配置为允许 TCP 端口 80 上的通信。</span><span class="sxs-lookup"><span data-stu-id="e3f33-114">Many network applications make use of the HTTP protocol because most firewalls are configured by default to allow traffic on TCP port 80.</span></span>  
  
 <span data-ttu-id="e3f33-115">在 HTTP.SYS 模型中，许多不同的 HTTP 应用程序的通信中将多路复用到单个 TCP 端口。此模型已经成为 Windows 平台上的标准。</span><span class="sxs-lookup"><span data-stu-id="e3f33-115">The HTTP.SYS model in which traffic for many different HTTP applications is multiplexed onto a single TCP port has become standard on the Windows platform.</span></span> <span data-ttu-id="e3f33-116">这为防火墙管理员提供了一个公共控制点，同时可以让应用程序开发人员尽可能降低生成可利用网络的新应用程序的部署成本。</span><span class="sxs-lookup"><span data-stu-id="e3f33-116">This provides a common point of control for firewall administrators while allowing application developers to minimize the deployment cost of building new applications that can make use of the network.</span></span>  
  
 <span data-ttu-id="e3f33-117">在多个 HTTP 应用程序之间共享端口的能力早已成为 Internet 信息服务 (IIS) 的一个功能。</span><span class="sxs-lookup"><span data-stu-id="e3f33-117">The ability to share ports across multiple HTTP applications has long been a feature of Internet Information Services (IIS).</span></span> <span data-ttu-id="e3f33-118">但是，它只是引入了 HTTP.SYS (内核模式 HTTP 协议侦听器) ，IIS 6.0，此基础结构已完全通用化。</span><span class="sxs-lookup"><span data-stu-id="e3f33-118">However, it was only with the introduction of HTTP.SYS (the kernel-mode HTTP protocol listener) with IIS 6.0 that this infrastructure was fully generalized.</span></span> <span data-ttu-id="e3f33-119">实际上，HTTP.SYS 允许任意用户进程共享专用于 HTTP 通信的 TCP 端口。</span><span class="sxs-lookup"><span data-stu-id="e3f33-119">In effect, HTTP.SYS allows arbitrary user processes to share the TCP ports dedicated to HTTP traffic.</span></span> <span data-ttu-id="e3f33-120">此功能可以让许多 HTTP 应用程序在同一台计算机上共存于不同的独立进程中，同时共享通过 TCP 端口 80 发送和接收通信所需要的网络基础结构。</span><span class="sxs-lookup"><span data-stu-id="e3f33-120">This capability allows many HTTP applications to coexist on the same physical machine in separate, isolated processes while sharing the network infrastructure required to send and receive traffic over TCP port 80.</span></span> <span data-ttu-id="e3f33-121">Net.TCP Port Sharing Service 支持为 net.tcp 应用程序共享相同类型的端口。</span><span class="sxs-lookup"><span data-stu-id="e3f33-121">The Net.TCP Port Sharing Service enables the same type of port sharing for net.tcp applications.</span></span>  
  
## <a name="port-sharing-architecture"></a><span data-ttu-id="e3f33-122">端口共享结构</span><span class="sxs-lookup"><span data-stu-id="e3f33-122">Port Sharing Architecture</span></span>  

 <span data-ttu-id="e3f33-123">WCF 中的端口共享体系结构有三个主要组件：</span><span class="sxs-lookup"><span data-stu-id="e3f33-123">The Port Sharing architecture in WCF has three main components:</span></span>  
  
- <span data-ttu-id="e3f33-124">辅助进程：任何使用共享端口通过 net.tcp:// 通信的进程。</span><span class="sxs-lookup"><span data-stu-id="e3f33-124">A Worker Process: Any process communicating over net.tcp:// using shared ports.</span></span>  
  
- <span data-ttu-id="e3f33-125">WCF TCP 传输：实现 net.tcp：//协议。</span><span class="sxs-lookup"><span data-stu-id="e3f33-125">The WCF TCP transport: Implements the net.tcp:// protocol.</span></span>  
  
- <span data-ttu-id="e3f33-126">Net.TCP Port Sharing Service：允许许多辅助进程共享同一 TCP 端口。</span><span class="sxs-lookup"><span data-stu-id="e3f33-126">The Net.TCP Port Sharing Service: Allows many worker processes to share the same TCP port.</span></span>  
  
 <span data-ttu-id="e3f33-127">Net.TCP Port Sharing Service 是用户模式的 Windows 服务，可代表通过其连接的辅助进程接受 net.tcp:// 连接。</span><span class="sxs-lookup"><span data-stu-id="e3f33-127">The Net.TCP Port Sharing Service is a user-mode Windows service that accepts net.tcp:// connections on behalf of the worker processes that connect through it.</span></span> <span data-ttu-id="e3f33-128">当套接字连接到达时，端口共享服务将检查传入消息流以获取其目标地址。</span><span class="sxs-lookup"><span data-stu-id="e3f33-128">When a socket connection arrives, the port sharing service inspects the incoming message stream to obtain its destination address.</span></span> <span data-ttu-id="e3f33-129">基于此地址，端口共享服务可以将数据流路由到最终处理它的应用程序。</span><span class="sxs-lookup"><span data-stu-id="e3f33-129">Based on this address, the port sharing service can route the data stream to the application that ultimately processes it.</span></span>  
  
 <span data-ttu-id="e3f33-130">当打开使用 net.tcp:// 端口共享的 WCF 服务时，WCF TCP 传输基础结构不会在应用程序进程中直接打开 TCP 套接字。</span><span class="sxs-lookup"><span data-stu-id="e3f33-130">When a WCF service that uses net.tcp:// port sharing opens, the WCF TCP transport infrastructure does not directly open a TCP socket in the application process.</span></span> <span data-ttu-id="e3f33-131">传输协议基础结构而是向 Net.TCP Port Sharing Service 注册服务的基址统一资源标识符 (URI)，并且等待端口共享服务代表它侦听消息。</span><span class="sxs-lookup"><span data-stu-id="e3f33-131">Instead, the transport infrastructure registers the service’s base address Uniform Resource Identifier (URI) with the Net.TCP Port Sharing Service and waits for the port sharing service to listen for messages on its behalf.</span></span>  <span data-ttu-id="e3f33-132">端口共享服务将对到达的发送给该应用程序服务的消息进行调度。</span><span class="sxs-lookup"><span data-stu-id="e3f33-132">The port sharing service dispatches messages addressed to the application service as they arrive.</span></span>  
  
## <a name="installing-port-sharing"></a><span data-ttu-id="e3f33-133">安装端口共享</span><span class="sxs-lookup"><span data-stu-id="e3f33-133">Installing Port Sharing</span></span>  

 <span data-ttu-id="e3f33-134">Net.tcp 端口共享服务在支持 WinFX 的所有操作系统上可用，但默认情况下未启用此服务。</span><span class="sxs-lookup"><span data-stu-id="e3f33-134">The Net.TCP Port Sharing Service is available on all operating systems that support WinFX, but the service is not enabled by default.</span></span> <span data-ttu-id="e3f33-135">作为一项安全预防措施，管理员必须在第一次使用前手动启用 Net.TCP Port Sharing Service。</span><span class="sxs-lookup"><span data-stu-id="e3f33-135">As a security precaution, an administrator must manually enable the Net.TCP Port Sharing Service prior to first use.</span></span> <span data-ttu-id="e3f33-136">Net.TCP Port Sharing Service 会公开一些配置选项，从而让您可以操作端口共享服务所拥有的网络套接字的若干特性。</span><span class="sxs-lookup"><span data-stu-id="e3f33-136">The Net.TCP Port Sharing Service exposes configuration options that allow you to manipulate several characteristics of the network sockets owned by the port sharing service.</span></span> <span data-ttu-id="e3f33-137">有关详细信息，请参阅 [如何：启用 Net.tcp 端口共享服务](how-to-enable-the-net-tcp-port-sharing-service.md)。</span><span class="sxs-lookup"><span data-stu-id="e3f33-137">For more information, see [How to: Enable the Net.TCP Port Sharing Service](how-to-enable-the-net-tcp-port-sharing-service.md).</span></span>  
  
## <a name="using-nettcp-port-sharing-in-an-application"></a><span data-ttu-id="e3f33-138">在应用程序中使用 Net.tcp 端口共享</span><span class="sxs-lookup"><span data-stu-id="e3f33-138">Using Net.tcp Port Sharing in an Application</span></span>  

 <span data-ttu-id="e3f33-139">在 WCF 应用程序中使用 net.tcp：//端口共享的最简单方法是使用公开服务 <xref:System.ServiceModel.NetTcpBinding> ，然后使用属性启用 Net.tcp 端口共享服务 <xref:System.ServiceModel.NetTcpBinding.PortSharingEnabled%2A> 。</span><span class="sxs-lookup"><span data-stu-id="e3f33-139">The easiest way to use net.tcp:// port sharing in your WCF application is to expose a service using the <xref:System.ServiceModel.NetTcpBinding> and then to enable Net.TCP Port Sharing Service using the <xref:System.ServiceModel.NetTcpBinding.PortSharingEnabled%2A> property.</span></span>  
  
 <span data-ttu-id="e3f33-140">有关如何执行此操作的详细信息，请参阅 [如何：配置 WCF 服务以使用端口共享](how-to-configure-a-wcf-service-to-use-port-sharing.md)。</span><span class="sxs-lookup"><span data-stu-id="e3f33-140">For more information about how to do this, see [How to: Configure a WCF Service to Use Port Sharing](how-to-configure-a-wcf-service-to-use-port-sharing.md).</span></span>  
  
## <a name="security-implications-of-port-sharing"></a><span data-ttu-id="e3f33-141">端口共享的安全性影响</span><span class="sxs-lookup"><span data-stu-id="e3f33-141">Security Implications of Port Sharing</span></span>  

 <span data-ttu-id="e3f33-142">虽然 Net.TCP Port Sharing Service 在应用程序和网络之间提供了一个处理层，但是仍应对使用端口共享的应用程序进行保护，就好像这些应用程序直接在网络上进行侦听一样。</span><span class="sxs-lookup"><span data-stu-id="e3f33-142">Although the Net.TCP Port Sharing Service provides a layer of processing between applications and the network, applications that use port sharing should still be secured as if they were directly listening on the network.</span></span> <span data-ttu-id="e3f33-143">具体来说，使用端口共享的应用程序应评估运行它们所依据的进程特权。</span><span class="sxs-lookup"><span data-stu-id="e3f33-143">Specifically, applications that use port sharing should evaluate the process privileges under which they run.</span></span> <span data-ttu-id="e3f33-144">请考虑使用内置网络服务帐户运行应用程序，该内置服务帐户将以网络通信要求的最小进程特权集运行。</span><span class="sxs-lookup"><span data-stu-id="e3f33-144">Consider running your application using the built-in Network Service account, which runs with the minimal set of process privileges required for network communication.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e3f33-145">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e3f33-145">See also</span></span>

- [<span data-ttu-id="e3f33-146">配置 Net.TCP 端口共享服务</span><span class="sxs-lookup"><span data-stu-id="e3f33-146">Configuring the Net.TCP Port Sharing Service</span></span>](configuring-the-net-tcp-port-sharing-service.md)
- [<span data-ttu-id="e3f33-147">承载</span><span class="sxs-lookup"><span data-stu-id="e3f33-147">Hosting</span></span>](hosting.md)
- [<span data-ttu-id="e3f33-148">如何：配置 WCF 服务以使用端口共享</span><span class="sxs-lookup"><span data-stu-id="e3f33-148">How to: Configure a WCF Service to Use Port Sharing</span></span>](how-to-configure-a-wcf-service-to-use-port-sharing.md)
- [<span data-ttu-id="e3f33-149">如何：启用 Net.TCP 端口共享服务</span><span class="sxs-lookup"><span data-stu-id="e3f33-149">How to: Enable the Net.TCP Port Sharing Service</span></span>](how-to-enable-the-net-tcp-port-sharing-service.md)

---
title: 服务器端 UI 自动化提供程序的实现
description: 了解如何在 .NET 中实现自定义控件的服务器端 UI 自动化提供程序。 WPF 和非 WPF 元素的实现不同。
ms.date: 03/30/2017
helpviewer_keywords:
- server-side UI Automation provider implementation
- UI Automation, server-side provider implementation
- provider implementation, UI Automation
ms.assetid: 6acc6d08-bd67-4e2e-915c-9c1d34eb86fe
ms.openlocfilehash: ee9fe5b3180abcc9ecbc4515e0af1e1c4b2e8b87
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/15/2020
ms.locfileid: "90555427"
---
# <a name="server-side-ui-automation-provider-implementation"></a><span data-ttu-id="0a6b0-104">服务器端 UI 自动化提供程序的实现</span><span class="sxs-lookup"><span data-stu-id="0a6b0-104">Server-Side UI Automation Provider Implementation</span></span>

> [!NOTE]
> <span data-ttu-id="0a6b0-105">本文档适用于想要使用 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 命名空间中定义的托管 <xref:System.Windows.Automation> 类的 .NET Framework 开发人员。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-105">This documentation is intended for .NET Framework developers who want to use the managed [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] classes defined in the <xref:System.Windows.Automation> namespace.</span></span> <span data-ttu-id="0a6b0-106">有关 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]的最新信息，请参阅 [Windows 自动化 API：UI 自动化](/windows/win32/winauto/entry-uiauto-win32)。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-106">For the latest information about [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)], see [Windows Automation API: UI Automation](/windows/win32/winauto/entry-uiauto-win32).</span></span>

<span data-ttu-id="0a6b0-107">本部分将介绍如何实现自定义控件的服务器端 UI 自动化提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-107">This section describes how to implement a server-side UI Automation provider for a custom control.</span></span>

<span data-ttu-id="0a6b0-108">Windows Presentation Foundation (WPF) 元素和非 WPF Windows 窗体 (元素的实现在本质上是不同的。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-108">The implementation for Windows Presentation Foundation (WPF) elements and non-WPF elements (such as those designed for Windows Forms) is fundamentally different.</span></span> <span data-ttu-id="0a6b0-109">WPF 元素通过从派生的类提供对的支持 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <xref:System.Windows.Automation.Peers.AutomationPeer> 。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-109">WPF elements provide support for [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] through a class derived from <xref:System.Windows.Automation.Peers.AutomationPeer>.</span></span> <span data-ttu-id="0a6b0-110">非 WPF 元素通过提供程序接口的实现提供支持。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-110">Non-WPF elements provide support through implementations of provider interfaces.</span></span>

<a name="Security_Considerations"></a>

## <a name="security-considerations"></a><span data-ttu-id="0a6b0-111">安全注意事项</span><span class="sxs-lookup"><span data-stu-id="0a6b0-111">Security Considerations</span></span>

<span data-ttu-id="0a6b0-112">应编写提供程序，使它们能够在部分信任环境中的工作。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-112">Providers should be written so that they can work in a partial-trust environment.</span></span> <span data-ttu-id="0a6b0-113">因为 UIAutomationClient.dll 未配置为在部分信任下运行，所以提供程序代码不应引用该程序集。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-113">Because UIAutomationClient.dll is not configured to run under partial trust, your provider code should not reference that assembly.</span></span> <span data-ttu-id="0a6b0-114">如果情况如此，则代码可以在完全信任环境中运行，但无法在部分信任环境中运行。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-114">If it does so, the code may run in a full-trust environment but then fail in a partial-trust environment.</span></span>

<span data-ttu-id="0a6b0-115">特别是，不要使用 UIAutomationClient.dll 中类的字段，例如 <xref:System.Windows.Automation.AutomationElement>中的字段。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-115">In particular, do not use fields from classes in UIAutomationClient.dll such as those in <xref:System.Windows.Automation.AutomationElement>.</span></span> <span data-ttu-id="0a6b0-116">请改用 UIAutomationTypes.dll 中类的等效字段，如 <xref:System.Windows.Automation.AutomationElementIdentifiers>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-116">Instead, use the equivalent fields from classes in UIAutomationTypes.dll, such as <xref:System.Windows.Automation.AutomationElementIdentifiers>.</span></span>

<a name="Provider_Implementation_by_WPF_Elements"></a>

## <a name="provider-implementation-by-windows-presentation-foundation-elements"></a><span data-ttu-id="0a6b0-117">通过 Windows Presentation Foundation 元素实现的提供程序实现</span><span class="sxs-lookup"><span data-stu-id="0a6b0-117">Provider Implementation by Windows Presentation Foundation Elements</span></span>

<span data-ttu-id="0a6b0-118">有关本主题的详细信息，请参阅 [WPF 自定义控件的 UI 自动化](/dotnet/desktop/wpf/controls/ui-automation-of-a-wpf-custom-control)。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-118">For more information on this topic, please see [UI Automation of a WPF Custom Control](/dotnet/desktop/wpf/controls/ui-automation-of-a-wpf-custom-control).</span></span>

<a name="Provider_Implementation_by_non_WPF_Elements"></a>

## <a name="provider-implementation-by-non-wpf-elements"></a><span data-ttu-id="0a6b0-119">通过非 WPF 元素实现的提供程序实现</span><span class="sxs-lookup"><span data-stu-id="0a6b0-119">Provider Implementation by non-WPF Elements</span></span>

<span data-ttu-id="0a6b0-120">不属于 WPF 框架但以托管代码编写的自定义控件 (最常见的是 Windows 窗体控件) ， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 通过实现接口为提供支持。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-120">Custom controls that are not part of the WPF framework, but that are written in managed code (most often these are Windows Forms controls), provide support for [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] by implementing interfaces.</span></span> <span data-ttu-id="0a6b0-121">每个元素必须实现至少一个下一部分中第一个表中列出的接口。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-121">Every element must implement at least one of the interfaces listed in the first table in the next section.</span></span> <span data-ttu-id="0a6b0-122">此外，如果该元素支持一个或多个控件模式，它必须实现每个控件模式的相应接口。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-122">In addition, if the element supports one or more control patterns, it must implement the appropriate interface for each control pattern.</span></span>

<span data-ttu-id="0a6b0-123">你的 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供程序项目必须引用以下程序集：</span><span class="sxs-lookup"><span data-stu-id="0a6b0-123">Your [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] provider project must reference the following assemblies:</span></span>

- <span data-ttu-id="0a6b0-124">UIAutomationProviders.dll</span><span class="sxs-lookup"><span data-stu-id="0a6b0-124">UIAutomationProviders.dll</span></span>

- <span data-ttu-id="0a6b0-125">UIAutomationTypes.dll</span><span class="sxs-lookup"><span data-stu-id="0a6b0-125">UIAutomationTypes.dll</span></span>

- <span data-ttu-id="0a6b0-126">WindowsBase.dll</span><span class="sxs-lookup"><span data-stu-id="0a6b0-126">WindowsBase.dll</span></span>

<a name="Provider_Interfaces"></a>

### <a name="provider-interfaces"></a><span data-ttu-id="0a6b0-127">提供程序接口</span><span class="sxs-lookup"><span data-stu-id="0a6b0-127">Provider Interfaces</span></span>

<span data-ttu-id="0a6b0-128">每个 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供程序必须实现以下的一个接口。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-128">Every [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] provider must implement one of the following interfaces.</span></span>

|<span data-ttu-id="0a6b0-129">接口</span><span class="sxs-lookup"><span data-stu-id="0a6b0-129">Interface</span></span>|<span data-ttu-id="0a6b0-130">说明</span><span class="sxs-lookup"><span data-stu-id="0a6b0-130">Description</span></span>|
|---------------|-----------------|
|<xref:System.Windows.Automation.Provider.IRawElementProviderSimple>|<span data-ttu-id="0a6b0-131">为承载在窗口中的简单控件提供功能，包括支持控件模式和属性。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-131">Provides functionality for a simple control hosted in a window, including support for control patterns and properties.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderFragment>|<span data-ttu-id="0a6b0-132">继承自 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-132">Inherits from <xref:System.Windows.Automation.Provider.IRawElementProviderSimple>.</span></span> <span data-ttu-id="0a6b0-133">为复杂控件中的元素添加功能，包括在片段中导航、设置焦点并返回该元素的边框。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-133">Adds functionality for an element in a complex control, including navigation within the fragment, setting focus, and returning the bounding rectangle of the element.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>|<span data-ttu-id="0a6b0-134">继承自 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-134">Inherits from <xref:System.Windows.Automation.Provider.IRawElementProviderFragment>.</span></span> <span data-ttu-id="0a6b0-135">为复杂控件中的根元素添加功能，包括找到指定坐标处的子元素和设置整个控件的焦点状态。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-135">Adds functionality for the root element in a complex control, including locating a child element at specified coordinates and setting the focus state for the entire control.</span></span>|

<span data-ttu-id="0a6b0-136">以下接口可提供额外的功能，但并不需要实现。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-136">The following interfaces provide added functionality but are not required to be implemented.</span></span>

|<span data-ttu-id="0a6b0-137">接口</span><span class="sxs-lookup"><span data-stu-id="0a6b0-137">Interface</span></span>|<span data-ttu-id="0a6b0-138">说明</span><span class="sxs-lookup"><span data-stu-id="0a6b0-138">Description</span></span>|
|---------------|-----------------|
|<xref:System.Windows.Automation.Provider.IRawElementProviderAdviseEvents>|<span data-ttu-id="0a6b0-139">启用提供程序跟踪事件请求。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-139">Enables the provider to track requests for events.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride>|<span data-ttu-id="0a6b0-140">启用对片段的 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 树内的基于窗口的元素的重定位。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-140">Enables repositioning of window-based elements within the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree of a fragment.</span></span>|

<span data-ttu-id="0a6b0-141"><xref:System.Windows.Automation.Provider> 命名空间中的所有其他接口用于控件模式支持。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-141">All other interfaces in the <xref:System.Windows.Automation.Provider> namespace are for control pattern support.</span></span>

<a name="Requirements_for_Non_WPF_Providers"></a>

### <a name="requirements-for-non-wpf-providers"></a><span data-ttu-id="0a6b0-142">非 WPF 提供程序的要求</span><span class="sxs-lookup"><span data-stu-id="0a6b0-142">Requirements for Non-WPF Providers</span></span>

<span data-ttu-id="0a6b0-143">为了与 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]进行通信，你的控件必须实现以下主要领域的功能：</span><span class="sxs-lookup"><span data-stu-id="0a6b0-143">In order to communicate with [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)], your control must implement the following main areas of functionality:</span></span>

|<span data-ttu-id="0a6b0-144">功能</span><span class="sxs-lookup"><span data-stu-id="0a6b0-144">Functionality</span></span>|<span data-ttu-id="0a6b0-145">实现</span><span class="sxs-lookup"><span data-stu-id="0a6b0-145">Implementation</span></span>|
|-------------------|--------------------|
|<span data-ttu-id="0a6b0-146">向 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]公开提供程序</span><span class="sxs-lookup"><span data-stu-id="0a6b0-146">Expose the provider to [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)]</span></span>|<span data-ttu-id="0a6b0-147">为响应发送到控制窗口的 WM_GETOBJECT 消息，返回实现 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple> （或派生接口）的对象。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-147">In response to a WM_GETOBJECT message sent to the control window, return the object that implements <xref:System.Windows.Automation.Provider.IRawElementProviderSimple> (or a derived interface).</span></span> <span data-ttu-id="0a6b0-148">对于片段，这必须是片段根的提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-148">For fragments, this must be the provider for the fragment root.</span></span>|
|<span data-ttu-id="0a6b0-149">提供属性值</span><span class="sxs-lookup"><span data-stu-id="0a6b0-149">Provide property values</span></span>|<span data-ttu-id="0a6b0-150">实现 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPropertyValue%2A> 以提供或重写值。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-150">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPropertyValue%2A> to provide or override values.</span></span>|
|<span data-ttu-id="0a6b0-151">启用客户端从而与控件交互</span><span class="sxs-lookup"><span data-stu-id="0a6b0-151">Enable the client to interact with the control</span></span>|<span data-ttu-id="0a6b0-152">实现支持控件模式的接口，如 <xref:System.Windows.Automation.Provider.IInvokeProvider>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-152">Implement interfaces that support control patterns, such as <xref:System.Windows.Automation.Provider.IInvokeProvider>.</span></span> <span data-ttu-id="0a6b0-153">在你的 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPatternProvider%2A>实现中返回这些模式提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-153">Return these pattern providers in your implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.GetPatternProvider%2A>.</span></span>|
|<span data-ttu-id="0a6b0-154">引发事件</span><span class="sxs-lookup"><span data-stu-id="0a6b0-154">Raise events</span></span>|<span data-ttu-id="0a6b0-155">调用 <xref:System.Windows.Automation.Provider.AutomationInteropProvider> 的静态方法之一，以引发客户端可以侦听的一个事件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-155">Call one of the static methods of <xref:System.Windows.Automation.Provider.AutomationInteropProvider> to raise an event that a client can listen for.</span></span>|
|<span data-ttu-id="0a6b0-156">启用导航并将在片段中设置焦点</span><span class="sxs-lookup"><span data-stu-id="0a6b0-156">Enable navigation and focusing within a fragment</span></span>|<span data-ttu-id="0a6b0-157">为片段中的每个元素实现 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment> 。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-157">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragment> for each element within the fragment.</span></span> <span data-ttu-id="0a6b0-158">（对于并非为片段的一部分的元素，此操作并不必要。）</span><span class="sxs-lookup"><span data-stu-id="0a6b0-158">(Not necessary for elements that are not part of a fragment.)</span></span>|
|<span data-ttu-id="0a6b0-159">启用设置焦点，以及查找片段中的子元素</span><span class="sxs-lookup"><span data-stu-id="0a6b0-159">Enable focusing and location of child element in a fragment</span></span>|<span data-ttu-id="0a6b0-160">实现 <xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-160">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragmentRoot>.</span></span> <span data-ttu-id="0a6b0-161">（对于并非片段根的元素，此操作并不必要。）</span><span class="sxs-lookup"><span data-stu-id="0a6b0-161">(Not necessary for elements that are not fragment roots.)</span></span>|

<a name="Property_Values_in_Non_WPF_Providers"></a>

### <a name="property-values-in-non-wpf-providers"></a><span data-ttu-id="0a6b0-162">非 WPF 提供程序中的属性值</span><span class="sxs-lookup"><span data-stu-id="0a6b0-162">Property Values in Non-WPF Providers</span></span>

<span data-ttu-id="0a6b0-163">自定义控件的[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 提供程序必须支持特定属性，这些属性可由自动化系统以及客户端应用程序使用。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-163">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] providers for custom controls must support certain properties that can be used by the automation system as well as by client applications.</span></span> <span data-ttu-id="0a6b0-164">对于窗口 (HWND) 中承载的元素， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 可以从默认窗口提供程序检索某些属性，但必须从自定义提供程序获取其他属性。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-164">For elements that are hosted in windows (HWNDs), [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] can retrieve some properties from the default window provider, but must obtain others from the custom provider.</span></span>

<span data-ttu-id="0a6b0-165">基于 HWND 控件的提供程序通常不需要提供以下属性（由字段值标识）：</span><span class="sxs-lookup"><span data-stu-id="0a6b0-165">Providers for HWND based controls do not usually need to provide the following properties (identified by field values):</span></span>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.BoundingRectangleProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ClickablePointProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ProcessIdProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.ClassNameProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.HasKeyboardFocusProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsEnabledProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.IsPasswordProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty>

- <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty>

> [!NOTE]
> <span data-ttu-id="0a6b0-166">承载在窗口的简单元素或片段根的 <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty> 是从窗口中获取的；但是，根下的片段元素（如列表框中的列表项）必须提供自己的标识符。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-166">The <xref:System.Windows.Automation.AutomationElementIdentifiers.RuntimeIdProperty> of a simple element or fragment root hosted in a window is obtained from the window; however, fragment elements below the root (such as list items in a list box) must provide their own identifiers.</span></span> <span data-ttu-id="0a6b0-167">有关详细信息，请参阅 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.GetRuntimeId%2A>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-167">For more information, see <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.GetRuntimeId%2A>.</span></span>
>
> <span data-ttu-id="0a6b0-168"><xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty>应为 Windows 窗体控件中承载的提供程序返回。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-168">The <xref:System.Windows.Automation.AutomationElementIdentifiers.IsKeyboardFocusableProperty> should be returned for providers hosted in a Windows Forms control.</span></span> <span data-ttu-id="0a6b0-169">在这种情况下，默认的窗口提供程序可能无法检索正确值。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-169">In this case, the default window provider may be unable to retrieve the correct value.</span></span>
>
> <span data-ttu-id="0a6b0-170"><xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty> 通常由宿主提供程序提供。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-170">The <xref:System.Windows.Automation.AutomationElementIdentifiers.NameProperty> is usually supplied by the host provider.</span></span> <span data-ttu-id="0a6b0-171">例如，如果自定义控件从 <xref:System.Windows.Forms.Control>派生，则名称从控件的 `Text` 属性派生。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-171">For example, if a custom control is derived from <xref:System.Windows.Forms.Control>, the name is derived from the `Text` property of the control.</span></span>

<span data-ttu-id="0a6b0-172">有关示例代码，请参阅 [Return Properties from a UI Automation Provider](return-properties-from-a-ui-automation-provider.md)。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-172">For example code, see [Return Properties from a UI Automation Provider](return-properties-from-a-ui-automation-provider.md).</span></span>

<a name="Events_in_Non_WPF_Providers"></a>

### <a name="events-in-non-wpf-providers"></a><span data-ttu-id="0a6b0-173">非 WPF 提供程序中的事件</span><span class="sxs-lookup"><span data-stu-id="0a6b0-173">Events in Non-WPF Providers</span></span>

[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="0a6b0-174">提供程序应引发事件以通知客户端应用程序有关 UI 状态的变化。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-174">providers should raise events to notify client applications of changes in the state of the UI.</span></span> <span data-ttu-id="0a6b0-175">以下方法用于引发事件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-175">The following methods are used to raise events.</span></span>

|<span data-ttu-id="0a6b0-176">方法</span><span class="sxs-lookup"><span data-stu-id="0a6b0-176">Method</span></span>|<span data-ttu-id="0a6b0-177">说明</span><span class="sxs-lookup"><span data-stu-id="0a6b0-177">Description</span></span>|
|------------|-----------------|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseAutomationEvent%2A>|<span data-ttu-id="0a6b0-178">引发各种事件，包括由控件模式触发的事件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-178">Raises various events, including events triggered by control patterns.</span></span>|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseAutomationPropertyChangedEvent%2A>|<span data-ttu-id="0a6b0-179">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 属性更改时引发事件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-179">Raises an event when a [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] property has changed.</span></span>|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.RaiseStructureChangedEvent%2A>|<span data-ttu-id="0a6b0-180">[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 树的结构更改时引发事件；例如，通过删除或添加一个元素。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-180">Raises an event when the structure of the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree has changed; for example, by the removal or addition of an element.</span></span>|

<span data-ttu-id="0a6b0-181">事件的目的是通知客户端 [!INCLUDE[TLA#tla_ui](../../../includes/tlasharptla-ui-md.md)]中发生的情况，该活动是否由 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 系统本身触发。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-181">The purpose of an event is to notify the client of something taking place in the [!INCLUDE[TLA#tla_ui](../../../includes/tlasharptla-ui-md.md)], whether or not the activity is triggered by the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] system itself.</span></span> <span data-ttu-id="0a6b0-182">例如，由 <xref:System.Windows.Automation.InvokePatternIdentifiers.InvokedEvent> 标识的事件应当在每次调用该控件时引发，或通过直接用户输入或通过客户端应用程序调用 <xref:System.Windows.Automation.InvokePattern.Invoke%2A>。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-182">For example, the event identified by <xref:System.Windows.Automation.InvokePatternIdentifiers.InvokedEvent> should be raised whenever the control is invoked, either through direct user input or by the client application calling <xref:System.Windows.Automation.InvokePattern.Invoke%2A>.</span></span>

<span data-ttu-id="0a6b0-183">若要优化性能，提供程序可以有选择地引发事件，或者，如果没有注册任何接收事件的客户端应用程序，则不引发任何事件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-183">To optimize performance, a provider can selectively raise events, or raise no events at all if no client application is registered to receive them.</span></span> <span data-ttu-id="0a6b0-184">以下方法用于进行优化。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-184">The following methods are used for optimization.</span></span>

|<span data-ttu-id="0a6b0-185">方法</span><span class="sxs-lookup"><span data-stu-id="0a6b0-185">Method</span></span>|<span data-ttu-id="0a6b0-186">说明</span><span class="sxs-lookup"><span data-stu-id="0a6b0-186">Description</span></span>|
|------------|-----------------|
|<xref:System.Windows.Automation.Provider.AutomationInteropProvider.ClientsAreListening%2A>|<span data-ttu-id="0a6b0-187">此静态属性指定是否存在已订阅 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 事件的客户端应用程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-187">This static property specifies whether any client applications have subscribed to [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] events.</span></span>|
|<xref:System.Windows.Automation.Provider.IRawElementProviderAdviseEvents>|<span data-ttu-id="0a6b0-188">提供程序在片段根上对此接口的实现使其能够在当客户端在片段上注册和注销事件处理程序时接收到通知。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-188">The provider's implementation of this interface on a fragment root enables it to be advised when clients register and unregister event handlers for events on the fragment.</span></span>|

<a name="Non_WPF_Provider_Navigation"></a>

### <a name="non-wpf-provider-navigation"></a><span data-ttu-id="0a6b0-189">非 WPF 提供程序导航</span><span class="sxs-lookup"><span data-stu-id="0a6b0-189">Non-WPF Provider Navigation</span></span>

<span data-ttu-id="0a6b0-190">简单控件的提供程序，例如窗口 (HWND) 中承载的自定义按钮，无需支持 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 树中的导航。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-190">Providers for simple controls such as a custom button hosted in a window (HWND) do not need to support navigation within the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree.</span></span> <span data-ttu-id="0a6b0-191">导航到元素和从元素导航由主机窗口的默认提供程序处理，此程序在 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>的实现中指定。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-191">Navigation to and from the element is handled by the default provider for the host window, which is specified in the implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>.</span></span> <span data-ttu-id="0a6b0-192">但是，在实现复杂自定义控件的提供程序时，必须支持片段及其子代的根节点之间的导航，以及同级节点之间的导航。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-192">When you implement a provider for a complex custom control, however, you must support navigation between the root node of the fragment and its descendants, and between sibling nodes.</span></span>

> [!NOTE]
> <span data-ttu-id="0a6b0-193">与根不同，片段的元素必须从 `null` 返回 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>引用，因为它们没有直接承载在窗口中，并且没有默认的提供程序可以支持往返它们的导航。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-193">Elements of a fragment other than the root must return a `null` reference  from <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>, because they are not directly hosted in a window, and no default provider can support navigation to and from them.</span></span>

<span data-ttu-id="0a6b0-194">片段的结构由你的 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A>的实现决定。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-194">The structure of the fragment is determined by your implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A>.</span></span> <span data-ttu-id="0a6b0-195">对于自每个片段的每个可能的方向，此方法返回该方向的元素的提供程序对象。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-195">For each possible direction from each fragment, this method returns the provider object for the element in that direction.</span></span> <span data-ttu-id="0a6b0-196">如果该方向没有任何元素，则方法将返回 `null` 引用。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-196">If there is no element in that direction, the method returns a `null` reference.</span></span>

<span data-ttu-id="0a6b0-197">片段根仅支持子元素的导航。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-197">The fragment root supports navigation only to child elements.</span></span> <span data-ttu-id="0a6b0-198">例如，方向是 <xref:System.Windows.Automation.Provider.NavigateDirection.FirstChild>时，列表框将返回列表中的第一项，当方向是 <xref:System.Windows.Automation.Provider.NavigateDirection.LastChild>时，将返回最后一项。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-198">For example, a list box returns the first item in the list when the direction is <xref:System.Windows.Automation.Provider.NavigateDirection.FirstChild>, and the last item when the direction is <xref:System.Windows.Automation.Provider.NavigateDirection.LastChild>.</span></span> <span data-ttu-id="0a6b0-199">片段根不支持导航到父级或同级；这由宿主窗口提供程序进行处理。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-199">The fragment root does not support navigation to a parent or siblings; this is handled by the host window provider.</span></span>

<span data-ttu-id="0a6b0-200">不是根的片段元素必须支持导航到父级、所有同级及其子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-200">Elements of a fragment that are not the root must support navigation to the parent, and to any siblings and children they have.</span></span>

<a name="Non_WPF_Provider_Reparenting"></a>

### <a name="non-wpf-provider-reparenting"></a><span data-ttu-id="0a6b0-201">非 WPF 提供程序重新设置父级</span><span class="sxs-lookup"><span data-stu-id="0a6b0-201">Non-WPF Provider Reparenting</span></span>

<span data-ttu-id="0a6b0-202">弹出窗口实际是顶级窗口，所以默认情况下会作为桌面的子级显示在 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 树中。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-202">Pop-up windows are actually top-level windows, and so by default appear in the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree as children of the desktop.</span></span> <span data-ttu-id="0a6b0-203">但是，在许多情况下，弹出式窗口在逻辑上是一些其他控件的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-203">In many cases, however, pop-up windows are logically children of some other control.</span></span> <span data-ttu-id="0a6b0-204">例如，组合框的下拉列表在逻辑上是组合框的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-204">For example, the drop-down list of a combo box is logically a child of the combo box.</span></span> <span data-ttu-id="0a6b0-205">同样，菜单弹出窗口在逻辑上是菜单的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-205">Similarly, a menu pop-up window is logically a child of the menu.</span></span> [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="0a6b0-206">支持重新设置弹出窗口的父级，以便它们显示为关联控件的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-206">provides support to reparent pop-up windows so that they appear to be children of the associated control.</span></span>

<span data-ttu-id="0a6b0-207">若要重新设置弹出窗口的父级：</span><span class="sxs-lookup"><span data-stu-id="0a6b0-207">To reparent a pop-up window:</span></span>

1. <span data-ttu-id="0a6b0-208">为弹出窗口的创建一个提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-208">Create a provider for the pop-up window.</span></span> <span data-ttu-id="0a6b0-209">这要求预先知道弹出窗口的类。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-209">This requires that the class of the pop-up window is known in advance.</span></span>

2. <span data-ttu-id="0a6b0-210">照常实现弹出窗口的所有属性和模式，就像它是独立的控件一样。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-210">Implement all properties and patterns as usual for that pop-up, as though it were a control in its own right.</span></span>

3. <span data-ttu-id="0a6b0-211">实现 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A> 属性，以便其返回从 <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>获取的值，其中该参数是弹出窗口的窗口句柄。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-211">Implement the <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A> property so that it returns the value obtained from <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>, where the parameter is the window handle of the pop-up window.</span></span>

4. <span data-ttu-id="0a6b0-212">实现弹出窗口和其父级的 <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A> ，以便正确处理从逻辑父级到逻辑子级以及同级子级之间的导航。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-212">Implement <xref:System.Windows.Automation.Provider.IRawElementProviderFragment.Navigate%2A> for the pop-up window and its parent so that navigation is handled properly from the logical parent to the logical children, and between sibling children.</span></span>

<span data-ttu-id="0a6b0-213">当 [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 遇到弹出窗口，它可以识别导航正从默认进行重写，并会跳过作为桌面子级出现的弹出窗口。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-213">When [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] encounters the pop-up window, it recognizes that navigation is being overridden from the default, and skips over the pop-up window when it is encountered as a child of the desktop.</span></span> <span data-ttu-id="0a6b0-214">而节点将只能通过片段到达。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-214">Instead, the node will only be reachable through the fragment.</span></span>

<span data-ttu-id="0a6b0-215">重新设置父级不适合控件可以承载任何类窗口的情况。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-215">Reparenting is not suitable for cases where a control can host a window of any class.</span></span> <span data-ttu-id="0a6b0-216">例如，rebar 在其带区中可承载任何类型的 HWND。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-216">For example, a rebar can host any type of HWND in its bands.</span></span> <span data-ttu-id="0a6b0-217">为了处理这些情况， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 支持 HWND 重定位的替代形式，如下节中所述。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-217">To handle these cases, [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] supports an alternative form of HWND relocation, as described in the next section.</span></span>

<a name="Non_WPF_Provider_Repositioning"></a>

### <a name="non-wpf-provider-repositioning"></a><span data-ttu-id="0a6b0-218">非 WPF 提供程序重定位</span><span class="sxs-lookup"><span data-stu-id="0a6b0-218">Non-WPF Provider Repositioning</span></span>

[!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] <span data-ttu-id="0a6b0-219">片段可能包含两个或多个元素，其中每个元素都包含在一个窗口 (HWND) 中。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-219">fragments may contain two or more elements that are each contained in a window (HWND).</span></span> <span data-ttu-id="0a6b0-220">因为每个 HWND 都有自己的默认提供程序，该提供程序将 HWND 视为作为容器的 HWND 的子级，默认情况下， [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] 树将在片段中将 HWND 显示为父窗口的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-220">Because each HWND has its own default provider that considers the HWND to be a child of a containing HWND, the [!INCLUDE[TLA2#tla_uiautomation](../../../includes/tla2sharptla-uiautomation-md.md)] tree will, by default, show the HWNDs in the fragment as children of the parent window.</span></span> <span data-ttu-id="0a6b0-221">在大多数情况下，这是所需的行为，但有时这可能会导致混淆，因为它不匹配 [!INCLUDE[TLA2#tla_ui](../../../includes/tla2sharptla-ui-md.md)]的逻辑结构。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-221">In most cases this is desirable behavior, but sometimes it can lead to confusion because it does not match the logical structure of the [!INCLUDE[TLA2#tla_ui](../../../includes/tla2sharptla-ui-md.md)].</span></span>

<span data-ttu-id="0a6b0-222">一个很好的示例则是 rebar 控件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-222">A good example of this is a rebar control.</span></span> <span data-ttu-id="0a6b0-223">Rebar 控件包含带区，其中每个带区又可以包含如工具栏、编辑框或组合框等基于 HWND 的控件。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-223">A rebar contains bands, each of which can in turn contain an HWND-based control such as a toolbar, an edit box, or a combo box.</span></span> <span data-ttu-id="0a6b0-224">Rebar HWND 的默认窗口提供程序将带区控件 HWND 视为子级，而 rebar 提供程序将带区视为子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-224">The default window provider for the rebar HWND sees the band control HWNDs as children, and the rebar provider sees the bands as children.</span></span> <span data-ttu-id="0a6b0-225">因为 HWND 提供程序和 rebar 提供程序是协同工作，并且合并其子级，所以带区和基于 HWND 的控件都将显示为 rebar 的子级。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-225">Because the HWND provider and the rebar provider are working in tandem and combining their children, both the bands and the HWND-based controls appear as children of the rebar.</span></span> <span data-ttu-id="0a6b0-226">但是，在逻辑上，只有带区应显示为 rebar 的子级，并且每个带区提供程序应与它所包含控件的默认 HWND 提供程序结合使用。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-226">Logically, however, only the bands should appear as children of the rebar, and each band provider should be coupled with the default HWND provider for the control it contains.</span></span>

<span data-ttu-id="0a6b0-227">为此，rebar 的片段根提供程序公开表示带区的子级集。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-227">To accomplish this, the fragment root provider for the rebar exposes a set of children representing the bands.</span></span> <span data-ttu-id="0a6b0-228">每个带区包含可能会公开属性和模式的单个提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-228">Each band has a single provider that may expose properties and patterns.</span></span> <span data-ttu-id="0a6b0-229">在其实现 <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>的过程中，带区提供程序将返回控件 HWND的默认窗口提供程序，它通过调用 <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>获取此提供程序，并传入控件的窗口句柄。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-229">In its implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderSimple.HostRawElementProvider%2A>, the band provider returns the default window provider for the control HWND, which it obtains by calling <xref:System.Windows.Automation.Provider.AutomationInteropProvider.HostProviderFromHandle%2A>, passing in the control's window handle.</span></span> <span data-ttu-id="0a6b0-230">最后，rebar 的片段根提供程序将实现 <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride> 接口，并在其实现 <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride.GetOverrideProviderForHwnd%2A> 的过程中返回包含在指定 HWND 中的控件的相应带区提供程序。</span><span class="sxs-lookup"><span data-stu-id="0a6b0-230">Finally, the fragment root provider for the rebar implements the <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride> interface, and in its implementation of <xref:System.Windows.Automation.Provider.IRawElementProviderHwndOverride.GetOverrideProviderForHwnd%2A> it returns the appropriate band provider for the control contained in the specified HWND.</span></span>

## <a name="see-also"></a><span data-ttu-id="0a6b0-231">请参阅</span><span class="sxs-lookup"><span data-stu-id="0a6b0-231">See also</span></span>

- [<span data-ttu-id="0a6b0-232">UI 自动化提供程序概述</span><span class="sxs-lookup"><span data-stu-id="0a6b0-232">UI Automation Providers Overview</span></span>](ui-automation-providers-overview.md)
- [<span data-ttu-id="0a6b0-233">公开服务器端 UI 自动化提供程序</span><span class="sxs-lookup"><span data-stu-id="0a6b0-233">Expose a Server-side UI Automation Provider</span></span>](expose-a-server-side-ui-automation-provider.md)
- [<span data-ttu-id="0a6b0-234">从 UI 自动化提供程序返回属性</span><span class="sxs-lookup"><span data-stu-id="0a6b0-234">Return Properties from a UI Automation Provider</span></span>](return-properties-from-a-ui-automation-provider.md)
- [<span data-ttu-id="0a6b0-235">从 UI 自动化提供程序中引发事件</span><span class="sxs-lookup"><span data-stu-id="0a6b0-235">Raise Events from a UI Automation Provider</span></span>](raise-events-from-a-ui-automation-provider.md)
- [<span data-ttu-id="0a6b0-236">在 UI 自动化片段提供程序中启用导航</span><span class="sxs-lookup"><span data-stu-id="0a6b0-236">Enable Navigation in a UI Automation Fragment Provider</span></span>](enable-navigation-in-a-ui-automation-fragment-provider.md)
- [<span data-ttu-id="0a6b0-237">在 UI 自动化提供程序中支持控件模式</span><span class="sxs-lookup"><span data-stu-id="0a6b0-237">Support Control Patterns in a UI Automation Provider</span></span>](support-control-patterns-in-a-ui-automation-provider.md)

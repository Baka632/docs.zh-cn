---
title: 持久性参与者
ms.date: 03/30/2017
ms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3
ms.openlocfilehash: 0bff6cc8fafb1832dc4d0e33b754fe3adb81dcf6
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96246103"
---
# <a name="persistence-participants"></a><span data-ttu-id="b8d00-102">持久性参与者</span><span class="sxs-lookup"><span data-stu-id="b8d00-102">Persistence Participants</span></span>

<span data-ttu-id="b8d00-103">持久性参与者可以参与应用程序宿主触发的持久性操作（保存或加载）。</span><span class="sxs-lookup"><span data-stu-id="b8d00-103">A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.</span></span> <span data-ttu-id="b8d00-104">[!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)]附带了两个抽象类 **PersistenceParticipant** 和 **PersistenceIOParticipant**，可用于创建持久性参与者。</span><span class="sxs-lookup"><span data-stu-id="b8d00-104">The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant.</span></span> <span data-ttu-id="b8d00-105">持久性参与者派生自这些类之一，它实现所需的方法，然后将该类的实例添加到 <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> 上的 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 集合。</span><span class="sxs-lookup"><span data-stu-id="b8d00-105">A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> .</span></span> <span data-ttu-id="b8d00-106">应用程序宿主可在持久保存工作流实例时查找此类工作流扩展，并在适当时对持久性参与者调用适当的方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-106">The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.</span></span>  
  
 <span data-ttu-id="b8d00-107">下面的列表介绍持久性子系统在持久保存（保存）操作的不同阶段执行的任务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-107">The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.</span></span> <span data-ttu-id="b8d00-108">持久性参与者用在第三和第四个阶段。</span><span class="sxs-lookup"><span data-stu-id="b8d00-108">The persistence participants are used in the third and fourth stages.</span></span> <span data-ttu-id="b8d00-109">如果参与者是 (仍参与 i/o 操作) 的持久性参与者的 i/o 参与者，则还会在第六个阶段使用该参与者。</span><span class="sxs-lookup"><span data-stu-id="b8d00-109">If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.</span></span>  
  
1. <span data-ttu-id="b8d00-110">收集内置值，包括工作流状态、书签、映射变量和时间戳。</span><span class="sxs-lookup"><span data-stu-id="b8d00-110">Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.</span></span>  
  
2. <span data-ttu-id="b8d00-111">收集已添加到与工作流实例关联的扩展集合中的所有持久性参与者。</span><span class="sxs-lookup"><span data-stu-id="b8d00-111">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
3. <span data-ttu-id="b8d00-112">调用由所有持久性参与者实现的 <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-112">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.</span></span>  
  
4. <span data-ttu-id="b8d00-113">调用由所有持久性参与者实现的 <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-113">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.</span></span>  
  
5. <span data-ttu-id="b8d00-114">将工作流持久保存或保存到持久性存储区。</span><span class="sxs-lookup"><span data-stu-id="b8d00-114">Persist or save the workflow into the persistence store.</span></span>  
  
6. <span data-ttu-id="b8d00-115"><xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A>对所有持久性 i/o 参与者调用方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-115">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants.</span></span> <span data-ttu-id="b8d00-116">如果参与者不是 i/o 参与者，将跳过此任务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-116">If the participant is not an I/O participant, this task is skipped.</span></span> <span data-ttu-id="b8d00-117">如果持久性段是事务性的，则在 Transaction.Current 属性中提供事务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-117">If the persistence episode is transactional, the transaction is provided in Transaction.Current property.</span></span>  
  
7. <span data-ttu-id="b8d00-118">等待所有持久性参与者完成。</span><span class="sxs-lookup"><span data-stu-id="b8d00-118">Waits for all persistence participants to complete.</span></span> <span data-ttu-id="b8d00-119">如果所有参与者在持久保存实例数据时都成功，则提交事务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-119">If all the participants succeed in persisting instance data, commits the transaction.</span></span>  
  
 <span data-ttu-id="b8d00-120">持久性参与者派生自 **PersistenceParticipant** 类，可以实现 **CollectValues** 和 **MapValues** 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-120">A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods.</span></span> <span data-ttu-id="b8d00-121">持久性 i/o 参与者派生自 **PersistenceIOParticipant** 类，除了实现 **CollectValues** 和 **MapValues** 方法外，还可以实现 **BeginOnSave** 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-121">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.</span></span>  
  
 <span data-ttu-id="b8d00-122">一个阶段完成之后才开始下一个阶段。</span><span class="sxs-lookup"><span data-stu-id="b8d00-122">Each stage is completed before the next stage begins.</span></span> <span data-ttu-id="b8d00-123">例如，从第一个阶段中的 **所有** 持久性参与者收集值。</span><span class="sxs-lookup"><span data-stu-id="b8d00-123">For example, values are collected from **all** persistence participants in the first stage.</span></span> <span data-ttu-id="b8d00-124">然后，将在第一个阶段中收集的所有值提供给第二个阶段中的所有持久性参与者进行映射。</span><span class="sxs-lookup"><span data-stu-id="b8d00-124">Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.</span></span> <span data-ttu-id="b8d00-125">接下来，将在第一个阶段中收集的和在第二个阶段中映射的所有值提供给第三个阶段中的持久性提供程序，依此类推。</span><span class="sxs-lookup"><span data-stu-id="b8d00-125">Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.</span></span>  
  
 <span data-ttu-id="b8d00-126">下面的列表介绍持久性子系统在加载操作的不同阶段执行的任务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-126">The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.</span></span> <span data-ttu-id="b8d00-127">持久性参与者用在第四个阶段中。</span><span class="sxs-lookup"><span data-stu-id="b8d00-127">The persistence participants are used in the fourth stage.</span></span> <span data-ttu-id="b8d00-128">此外，还在第三个阶段使用持久性 i/o 参与者 (还参与 i/o 操作) 的持久性参与者。</span><span class="sxs-lookup"><span data-stu-id="b8d00-128">The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.</span></span>  
  
1. <span data-ttu-id="b8d00-129">收集已添加到与工作流实例关联的扩展集合中的所有持久性参与者。</span><span class="sxs-lookup"><span data-stu-id="b8d00-129">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
2. <span data-ttu-id="b8d00-130">从持久性存储区加载工作流。</span><span class="sxs-lookup"><span data-stu-id="b8d00-130">Loads the workflow from the persistence store.</span></span>  
  
3. <span data-ttu-id="b8d00-131"><xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A>在所有持久性 i/o 参与者上调用，并等待所有持久性参与者完成。</span><span class="sxs-lookup"><span data-stu-id="b8d00-131">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete.</span></span> <span data-ttu-id="b8d00-132">如果持久性段是事务性的，则在 Transaction.Current 中提供事务。</span><span class="sxs-lookup"><span data-stu-id="b8d00-132">If the persistence episode is transactional, the transaction is provided in Transaction.Current.</span></span>  
  
4. <span data-ttu-id="b8d00-133">基于从持久性存储区检索的数据将工作流实例加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="b8d00-133">Loads the workflow instance in memory based on the data retrieved from the persistence store.</span></span>  
  
5. <span data-ttu-id="b8d00-134">对每个持久性参与者调用 <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A>。</span><span class="sxs-lookup"><span data-stu-id="b8d00-134">Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.</span></span>  
  
 <span data-ttu-id="b8d00-135">持久性参与者派生自 **PersistenceParticipant** 类，可以实现 **PublishValues** 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-135">A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method.</span></span> <span data-ttu-id="b8d00-136">持久性 i/o 参与者派生自 **PersistenceIOParticipant** 类，除了实现 **PublishValues** 方法外，还可以实现 **BeginOnLoad** 方法。</span><span class="sxs-lookup"><span data-stu-id="b8d00-136">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.</span></span>  
  
 <span data-ttu-id="b8d00-137">在加载工作流实例时，持久性提供程序将在该实例上创建锁。</span><span class="sxs-lookup"><span data-stu-id="b8d00-137">When loading a workflow instance the persistence provider creates a lock on that instance.</span></span> <span data-ttu-id="b8d00-138">这避免该实例在多节点方案中被多个主机加载。</span><span class="sxs-lookup"><span data-stu-id="b8d00-138">This prevents the instance from being loaded by more than one host in a multi-node scenario.</span></span> <span data-ttu-id="b8d00-139">如果您尝试加载已锁定的工作流实例，将会看到如下异常：异常“ System.ServiceModel.Persistence.InstanceLockException: 请求的操作无法完成，因为无法获取实例‘00000000-0000-0000-0000-000000000000’的锁”。</span><span class="sxs-lookup"><span data-stu-id="b8d00-139">If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception " System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired".</span></span> <span data-ttu-id="b8d00-140">在发生下列情况之一时将会导致该错误：</span><span class="sxs-lookup"><span data-stu-id="b8d00-140">This error is caused when one of the following occurs:</span></span>  
  
- <span data-ttu-id="b8d00-141">在多节点方案中，另一个主机加载了该实例。</span><span class="sxs-lookup"><span data-stu-id="b8d00-141">In a multi-node scenario the instance is loaded by another host.</span></span>  <span data-ttu-id="b8d00-142">有几种不同的方法可以解决这些类型的冲突：转移对拥有锁和重试的节点的处理，或者强制将导致其他主机无法保存其工作的负载。</span><span class="sxs-lookup"><span data-stu-id="b8d00-142">There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.</span></span>  
  
- <span data-ttu-id="b8d00-143">在单节点方案中并且主机出现崩溃。</span><span class="sxs-lookup"><span data-stu-id="b8d00-143">In a single-node scenario and the host crashed.</span></span>  <span data-ttu-id="b8d00-144">在主机再次启动时（进程回收或者创建新的持久性提供程序工厂），新主机将尝试加载由于锁尚未到期而仍被旧主机锁定的实例。</span><span class="sxs-lookup"><span data-stu-id="b8d00-144">When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.</span></span>  
  
- <span data-ttu-id="b8d00-145">在单节点方案中并且有关实例在某个点上已中止并且创建具有不同主机 ID 的新的持久性提供程序实例。</span><span class="sxs-lookup"><span data-stu-id="b8d00-145">In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.</span></span>  
  
 <span data-ttu-id="b8d00-146">锁定超时时间值默认为 5 分钟，您可以在调用 <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A> 时指定其他超时时间值。</span><span class="sxs-lookup"><span data-stu-id="b8d00-146">The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="b8d00-147">本节内容</span><span class="sxs-lookup"><span data-stu-id="b8d00-147">In This Section</span></span>  
  
- [<span data-ttu-id="b8d00-148">如何：创建自定义持久性参与者</span><span class="sxs-lookup"><span data-stu-id="b8d00-148">How to: Create a Custom Persistence Participant</span></span>](how-to-create-a-custom-persistence-participant.md)  
  
## <a name="see-also"></a><span data-ttu-id="b8d00-149">另请参阅</span><span class="sxs-lookup"><span data-stu-id="b8d00-149">See also</span></span>

- [<span data-ttu-id="b8d00-150">存储扩展性</span><span class="sxs-lookup"><span data-stu-id="b8d00-150">Store Extensibility</span></span>](store-extensibility.md)

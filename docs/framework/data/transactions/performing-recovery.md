---
title: 执行恢复
description: 在 .NET 中执行恢复。 资源管理器可在资源失败后通过重新登记事务参与者来帮助解决持久事务登记。
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: 23ee6cb194dbafb08ef7acf17aad25a57b57045e
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/24/2020
ms.locfileid: "91186726"
---
# <a name="performing-recovery"></a><span data-ttu-id="7502b-104">执行恢复</span><span class="sxs-lookup"><span data-stu-id="7502b-104">Performing Recovery</span></span>

<span data-ttu-id="7502b-105">资源管理器通过在资源失败之后重新登记事务参与者来促进事务中的持久登记的解决。</span><span class="sxs-lookup"><span data-stu-id="7502b-105">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="7502b-106">恢复过程</span><span class="sxs-lookup"><span data-stu-id="7502b-106">The Recovery Process</span></span>  

 <span data-ttu-id="7502b-107">若要持久登记以后可恢复的资源（由 <xref:System.Transactions.IEnlistmentNotification> 接口的实现描述），应调用 <xref:System.Transactions.Transaction.EnlistDurable%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="7502b-107">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="7502b-108">此外，还必须使用资源管理器标识符 (<xref:System.Transactions.Transaction.EnlistDurable%2A>) 提供 <xref:System.Guid> 方法，资源管理器标识符可用于在资源失败时统一标记事务参与者。</span><span class="sxs-lookup"><span data-stu-id="7502b-108">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="7502b-109">出于此原因，在 <xref:System.Guid> 恢复过程中提供给初始登记调用的将应与调用中的*resourceManagerIdentifier*参数相同。 <xref:System.Transactions.TransactionManager.Reenlist%2A></span><span class="sxs-lookup"><span data-stu-id="7502b-109">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="7502b-110">否则，会引发 <xref:System.Transactions.TransactionException>。</span><span class="sxs-lookup"><span data-stu-id="7502b-110">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="7502b-111">有关持久登记的详细信息，请参阅 [在事务中将资源登记为参与者](enlisting-resources-as-participants-in-a-transaction.md) 。</span><span class="sxs-lookup"><span data-stu-id="7502b-111">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="7502b-112">在 2PC 协议的准备阶段（第 1 阶段），当持久资源管理器的实现接收到 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 通知时，它应记录其在此阶段中的准备记录。</span><span class="sxs-lookup"><span data-stu-id="7502b-112">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="7502b-113">该记录应包含提交时完成事务所需的所有信息。</span><span class="sxs-lookup"><span data-stu-id="7502b-113">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="7502b-114">稍后可通过检索 PreparingEnlistment 回调的属性，在恢复期间访问准备记录 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 。 *preparingEnlistment*</span><span class="sxs-lookup"><span data-stu-id="7502b-114">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="7502b-115">无需在 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 方法中执行记录，因为 RM 可在辅助线程上执行此操作。</span><span class="sxs-lookup"><span data-stu-id="7502b-115">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="7502b-116">恢复过程分为以下两步：</span><span class="sxs-lookup"><span data-stu-id="7502b-116">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="7502b-117">第 1 步 – 重新登记</span><span class="sxs-lookup"><span data-stu-id="7502b-117">Step 1 - ReEnlist</span></span>  

 <span data-ttu-id="7502b-118">资源管理器检查状态不确定的每个登记的准备信息记录。</span><span class="sxs-lookup"><span data-stu-id="7502b-118">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="7502b-119">通过检查 <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 回调的 <xref:System.Transactions.PreparingEnlistment> 属性来执行该操作，该回调在第 1 阶段用 <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 通知传递给资源管理器。</span><span class="sxs-lookup"><span data-stu-id="7502b-119">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="7502b-120">对于所检查的每个此类登记，它都会对事务管理器调用 <xref:System.Transactions.TransactionManager.Reenlist%2A>。</span><span class="sxs-lookup"><span data-stu-id="7502b-120">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="7502b-121">此方法会传递一个唯一的标识资源管理器的 <xref:System.Guid>，还会在字节数组中传递登记信息。</span><span class="sxs-lookup"><span data-stu-id="7502b-121">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="7502b-122">此时，将返回一个新的 <xref:System.Transactions.Enlistment> 对象。</span><span class="sxs-lookup"><span data-stu-id="7502b-122">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="7502b-123">如果重新登记失败并引发异常，则资源管理器将需要在以后重试。</span><span class="sxs-lookup"><span data-stu-id="7502b-123">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="7502b-124">当资源管理器从故障中重新启动时，只应调用 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="7502b-124">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="7502b-125">此外，应该仅重新登记在两阶段提交的初始准备阶段中由资源管理器记录的未解决事务。</span><span class="sxs-lookup"><span data-stu-id="7502b-125">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="7502b-126">在无效的时间调用此方法的任何尝试都可能产生错误的结果。</span><span class="sxs-lookup"><span data-stu-id="7502b-126">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="7502b-127">当使用此方法重新登记参与者时，将相应地调用对应于事务结果的 <xref:System.Transactions.IEnlistmentNotification> 的第 2 阶段方法（即 <xref:System.Transactions.IEnlistmentNotification.Commit%2A>、<xref:System.Transactions.IEnlistmentNotification.Rollback%2A> 或 <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A>）。</span><span class="sxs-lookup"><span data-stu-id="7502b-127">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="7502b-128">第 2 步 – 完成恢复</span><span class="sxs-lookup"><span data-stu-id="7502b-128">Step 2 - Completing the recovery</span></span>  

 <span data-ttu-id="7502b-129">完成所有重新登记后，资源管理器会调用 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="7502b-129">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="7502b-130">此方法将完成恢复，并向事务管理器通知资源管理器不再有状态不确定的事务。</span><span class="sxs-lookup"><span data-stu-id="7502b-130">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="7502b-131">通过这样做，资源管理器可保证它不会再次调用 <xref:System.Transactions.TransactionManager.Reenlist%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="7502b-131">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="7502b-132">资源管理器在新事务中进行登记之前，无需解决所有状态不确定的事务。</span><span class="sxs-lookup"><span data-stu-id="7502b-132">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="7502b-133">在资源管理器与事务管理器建立关系之后，可以随时执行第一步，但在 <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> (步骤 2) 调用之后，不能再次执行步骤1。</span><span class="sxs-lookup"><span data-stu-id="7502b-133">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="7502b-134">可多次执行第 2 步，并且不会影响事务的结果。</span><span class="sxs-lookup"><span data-stu-id="7502b-134">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>

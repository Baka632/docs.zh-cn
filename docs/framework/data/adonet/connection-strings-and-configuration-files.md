---
title: 连接字符串和配置文件
description: 了解如何在应用程序配置文件中存储 ADO.NET 应用程序的连接字符串，作为安全和维护的最佳方案。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 37df2641-661e-407a-a3fb-7bf9540f01e8
ms.openlocfilehash: 2148aa984f8289b82b8efcee2404f08cab25c797
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/15/2020
ms.locfileid: "90556546"
---
# <a name="connection-strings-and-configuration-files"></a><span data-ttu-id="eaef9-103">连接字符串和配置文件</span><span class="sxs-lookup"><span data-stu-id="eaef9-103">Connection Strings and Configuration Files</span></span>

<span data-ttu-id="eaef9-104">在应用程序代码中嵌入连接字符串可能导致安全漏洞和维护问题。</span><span class="sxs-lookup"><span data-stu-id="eaef9-104">Embedding connection strings in your application's code can lead to security vulnerabilities and maintenance problems.</span></span> <span data-ttu-id="eaef9-105">使用 [Ildasm.exe（IL 反汇编程序）](../../tools/ildasm-exe-il-disassembler.md)工具可以查看编译到应用程序源代码中的未加密连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-105">Unencrypted connection strings compiled into an application's source code can be viewed using the [Ildasm.exe (IL Disassembler)](../../tools/ildasm-exe-il-disassembler.md) tool.</span></span> <span data-ttu-id="eaef9-106">此外，如果连接字符串发生更改，则必须重新编译应用程序。</span><span class="sxs-lookup"><span data-stu-id="eaef9-106">Moreover, if the connection string ever changes, your application must be recompiled.</span></span> <span data-ttu-id="eaef9-107">因此，我们建议您将连接字符串存储在应用程序配置文件中。</span><span class="sxs-lookup"><span data-stu-id="eaef9-107">For these reasons, we recommend storing connection strings in an application configuration file.</span></span>  
  
## <a name="working-with-application-configuration-files"></a><span data-ttu-id="eaef9-108">使用应用程序配置文件</span><span class="sxs-lookup"><span data-stu-id="eaef9-108">Working with Application Configuration Files</span></span>  
 <span data-ttu-id="eaef9-109">应用程序配置文件包含特定应用程序特有的设置。</span><span class="sxs-lookup"><span data-stu-id="eaef9-109">Application configuration files contain settings that are specific to a particular application.</span></span> <span data-ttu-id="eaef9-110">例如，ASP.NET 应用程序能包含一个或多个 web.config 文件，Windows 应用程序可能包含一个可选 app.config 文件\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-110">For example, an ASP.NET application can have one or more **web.config** files, and a Windows application can have an optional **app.config** file.</span></span> <span data-ttu-id="eaef9-111">虽然配置文件的名称和位置会因应用程序宿主的不同而有所不同，但配置文件可以有相同的元素。</span><span class="sxs-lookup"><span data-stu-id="eaef9-111">Configuration files share common elements, although the name and location of a configuration file vary depending on the application's host.</span></span>  
  
### <a name="the-connectionstrings-section"></a><span data-ttu-id="eaef9-112">connectionStrings 节</span><span class="sxs-lookup"><span data-stu-id="eaef9-112">The connectionStrings Section</span></span>  
 <span data-ttu-id="eaef9-113">连接字符串可作为键/值对存储在应用程序配置文件 configuration 元素的 connectionStrings 节中\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-113">Connection strings can be stored as key/value pairs in the **connectionStrings** section of the **configuration** element of an application configuration file.</span></span> <span data-ttu-id="eaef9-114">子元素包括 add、clear 和 remove\*\*\*\*\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-114">Child elements include **add**, **clear**, and **remove**.</span></span>  
  
 <span data-ttu-id="eaef9-115">下面的配置文件片段演示用于存储连接字符串的架构和语法。</span><span class="sxs-lookup"><span data-stu-id="eaef9-115">The following configuration file fragment demonstrates the schema and syntax for storing a connection string.</span></span> <span data-ttu-id="eaef9-116">name 属性是你提供用来唯一标识连接字符串的名称，以便在运行时可以检索到该字符串\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-116">The **name** attribute is a name that you provide to uniquely identify a connection string so that it can be retrieved at run time.</span></span> <span data-ttu-id="eaef9-117">providerName 是 .NET Framework 数据提供程序的固定名称，此名称登入 machine.config 文件中\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-117">The **providerName** is the invariant name of the .NET Framework data provider, which is registered in the machine.config file.</span></span>  
  
```xml  
<?xml version='1.0' encoding='utf-8'?>  
  <configuration>  
    <connectionStrings>  
      <clear />  
      <add name="Name"
       providerName="System.Data.ProviderName"
       connectionString="Valid Connection String;" />  
    </connectionStrings>  
  </configuration>  
```  
  
> [!NOTE]
> <span data-ttu-id="eaef9-118">您可以将连接字符串的一部分保存在配置文件中，并使用 <xref:System.Data.Common.DbConnectionStringBuilder> 类在运行时将该字符串补充完整。</span><span class="sxs-lookup"><span data-stu-id="eaef9-118">You can save part of a connection string in a configuration file and use the <xref:System.Data.Common.DbConnectionStringBuilder> class to complete it at run time.</span></span> <span data-ttu-id="eaef9-119">如果您预先不知道连接字符串的元素，或者不希望将敏感信息保存到配置文件中，这一方法会很有用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-119">This is useful in scenarios where you do not know elements of the connection string ahead of time, or when you do not want to save sensitive information in a configuration file.</span></span> <span data-ttu-id="eaef9-120">有关详细信息，请参阅[连接字符串生成器](connection-string-builders.md)。</span><span class="sxs-lookup"><span data-stu-id="eaef9-120">For more information, see [Connection String Builders](connection-string-builders.md).</span></span>  
  
### <a name="using-external-configuration-files"></a><span data-ttu-id="eaef9-121">使用外部配置文件</span><span class="sxs-lookup"><span data-stu-id="eaef9-121">Using External Configuration Files</span></span>  
 <span data-ttu-id="eaef9-122">外部配置文件是单独的文件，此类文件包含由一部分组成的配置文件的片段。</span><span class="sxs-lookup"><span data-stu-id="eaef9-122">External configuration files are separate files that contain a fragment of a configuration file consisting of a single section.</span></span> <span data-ttu-id="eaef9-123">外部配置文件由主配置文件引用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-123">The external configuration file is then referenced by the main configuration file.</span></span> <span data-ttu-id="eaef9-124">如果在部署完应用程序后连接字符串可能会被编辑，那么将 connectionStrings 节存储在物理上独立的文件中会很有用\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-124">Storing the **connectionStrings** section in a physically separate file is useful in situations where connection strings may be edited after the application is deployed.</span></span> <span data-ttu-id="eaef9-125">例如，标准 ASP.NET 行为是在修改配置文件后重新启动应用程序域，这将导致状态信息丢失。</span><span class="sxs-lookup"><span data-stu-id="eaef9-125">For example, the standard ASP.NET behavior is to restart an application domain when configuration files are modified, which results in state information being lost.</span></span> <span data-ttu-id="eaef9-126">然而，修改外部配置文件不会导致重新启动应用程序。</span><span class="sxs-lookup"><span data-stu-id="eaef9-126">However, modifying an external configuration file does not cause an application restart.</span></span> <span data-ttu-id="eaef9-127">外部配置文件并不局限于由 ASP.NET 使用，Windows 应用程序也可以使用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-127">External configuration files are not limited to ASP.NET; they can also be used by Windows applications.</span></span> <span data-ttu-id="eaef9-128">此外，文件访问安全性和权限也可以用于限制对外部配置文件的访问。</span><span class="sxs-lookup"><span data-stu-id="eaef9-128">In addition, file access security and permissions can be used to restrict access to external configuration files.</span></span> <span data-ttu-id="eaef9-129">运行时使用外部配置文件是透明的，且不需要特殊编码。</span><span class="sxs-lookup"><span data-stu-id="eaef9-129">Working with external configuration files at run time is transparent, and requires no special coding.</span></span>  
  
 <span data-ttu-id="eaef9-130">若要将连接字符串存储在外部配置文件中，请创建一个只包含 connectionStrings 节的单独的文件\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-130">To store connection strings in an external configuration file, create a separate file that contains only the **connectionStrings** section.</span></span> <span data-ttu-id="eaef9-131">不要包含任何其他的元素、节或属性。</span><span class="sxs-lookup"><span data-stu-id="eaef9-131">Do not include any additional elements, sections, or attributes.</span></span> <span data-ttu-id="eaef9-132">此示例演示外部配置文件的语法。</span><span class="sxs-lookup"><span data-stu-id="eaef9-132">This example shows the syntax for an external configuration file.</span></span>  
  
```xml  
<connectionStrings>  
  <add name="Name"
   providerName="System.Data.ProviderName"
   connectionString="Valid Connection String;" />  
</connectionStrings>  
```  
  
 <span data-ttu-id="eaef9-133">在主应用程序配置文件中，可以使用 configSource 属性指定外部文件的完全限定名和位置\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-133">In the main application configuration file, you use the **configSource** attribute to specify the fully qualified name and location of the external file.</span></span> <span data-ttu-id="eaef9-134">此示例引用名为 `connections.config` 的外部配置文件。</span><span class="sxs-lookup"><span data-stu-id="eaef9-134">This example refers to an external configuration file named `connections.config`.</span></span>  
  
```xml  
<?xml version='1.0' encoding='utf-8'?>  
<configuration>  
    <connectionStrings configSource="connections.config"/>  
</configuration>  
```  
  
## <a name="retrieving-connection-strings-at-run-time"></a><span data-ttu-id="eaef9-135">运行时检索连接字符串</span><span class="sxs-lookup"><span data-stu-id="eaef9-135">Retrieving Connection Strings at Run Time</span></span>  
 <span data-ttu-id="eaef9-136">.NET Framework 2.0 在 <xref:System.Configuration> 命名空间中引入了新类，以简化在运行时从配置文件检索连接字符串的操作。</span><span class="sxs-lookup"><span data-stu-id="eaef9-136">The .NET Framework 2.0 introduced new classes in the <xref:System.Configuration> namespace to simplify retrieving connection strings from configuration files at run time.</span></span> <span data-ttu-id="eaef9-137">您可以以编程方式按名称或提供程序名称检索连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-137">You can programmatically retrieve a connection string by name or by provider name.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-138">machine.config 文件还包含 connectionStrings 节，此节包含 Visual Studio 使用的连接字符串\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-138">The **machine.config** file also contains a **connectionStrings** section, which contains connection strings used by Visual Studio.</span></span> <span data-ttu-id="eaef9-139">在从 Windows 应用程序中的**app.config**文件检索按提供程序名称的连接字符串时，将首先加载**machine.config**中的连接字符串，然后加载**app.config**中的条目。如果在**connectionStrings**元素后立即添加**clear** ，则会从内存中的数据结构中删除所有继承的引用，以便只考虑本地**app.config**文件中定义的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-139">When retrieving connection strings by provider name from the **app.config** file in a Windows application, the connection strings in **machine.config** get loaded first, and then the entries from **app.config**. Adding **clear** immediately after the **connectionStrings** element removes all inherited references from the data structure in memory, so that only the connection strings defined in the local **app.config** file are considered.</span></span>  
  
### <a name="working-with-the-configuration-classes"></a><span data-ttu-id="eaef9-140">使用配置类</span><span class="sxs-lookup"><span data-stu-id="eaef9-140">Working with the Configuration Classes</span></span>  
 <span data-ttu-id="eaef9-141">从 .NET Framework 2.0 开始，当使用本地计算机上的配置文件时，将使用 <xref:System.Configuration.ConfigurationManager>，从而替换已不推荐使用的 <xref:System.Configuration.ConfigurationSettings>。</span><span class="sxs-lookup"><span data-stu-id="eaef9-141">Starting with the .NET Framework 2.0, <xref:System.Configuration.ConfigurationManager> is used when working with configuration files on the local computer, replacing the deprecated <xref:System.Configuration.ConfigurationSettings>.</span></span> <span data-ttu-id="eaef9-142"><xref:System.Web.Configuration.WebConfigurationManager> 与 ASP.NET 配置文件一起使用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-142"><xref:System.Web.Configuration.WebConfigurationManager> is used to work with ASP.NET configuration files.</span></span> <span data-ttu-id="eaef9-143">该管理器可以使用 Web 服务器上的配置文件，并允许以编程方式访问配置文件节（如 system.web）\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-143">It is designed to work with configuration files on a Web server, and allows programmatic access to configuration file sections such as **system.web**.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-144">在运行时访问配置文件需要对调用方授予权限，根据应用程序类型、配置文件和位置确定所需的权限。</span><span class="sxs-lookup"><span data-stu-id="eaef9-144">Accessing configuration files at run time requires granting permissions to the caller; the required permissions depend on the type of application, configuration file, and location.</span></span> <span data-ttu-id="eaef9-145">有关详细信息，请参阅[使用配置类](/previous-versions/aspnet/ms228063(v=vs.100))和 <xref:System.Web.Configuration.WebConfigurationManager>（对于 ASP.NET 应用程序），以及 <xref:System.Configuration.ConfigurationManager>（对于 Windows 应用程序）。</span><span class="sxs-lookup"><span data-stu-id="eaef9-145">For more information, see [Using the Configuration Classes](/previous-versions/aspnet/ms228063(v=vs.100)) and <xref:System.Web.Configuration.WebConfigurationManager> for ASP.NET applications, and <xref:System.Configuration.ConfigurationManager> for Windows applications.</span></span>  
  
 <span data-ttu-id="eaef9-146">您可以使用 <xref:System.Configuration.ConnectionStringSettingsCollection> 从应用程序配置文件中检索连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-146">You can use the <xref:System.Configuration.ConnectionStringSettingsCollection> to retrieve connection strings from application configuration files.</span></span> <span data-ttu-id="eaef9-147">它包含 <xref:System.Configuration.ConnectionStringSettings> 对象的集合，每个对象表示 connectionStrings 节中的一项\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-147">It contains a collection of <xref:System.Configuration.ConnectionStringSettings> objects, each of which represents a single entry in the **connectionStrings** section.</span></span> <span data-ttu-id="eaef9-148">它的属性 (Property) 映射为连接字符串属性 (Attribute)，从而允许您通过指定名称或提供程序名称来检索连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-148">Its properties map to connection string attributes, allowing you to retrieve a connection string by specifying the name or the provider name.</span></span>  
  
|<span data-ttu-id="eaef9-149">properties</span><span class="sxs-lookup"><span data-stu-id="eaef9-149">Property</span></span>|<span data-ttu-id="eaef9-150">说明</span><span class="sxs-lookup"><span data-stu-id="eaef9-150">Description</span></span>|  
|--------------|-----------------|  
|<xref:System.Configuration.ConnectionStringSettings.Name%2A>|<span data-ttu-id="eaef9-151">连接字符串的名称。</span><span class="sxs-lookup"><span data-stu-id="eaef9-151">The name of the connection string.</span></span> <span data-ttu-id="eaef9-152">映射到 name 属性\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-152">Maps to the **name** attribute.</span></span>|  
|<xref:System.Configuration.ConnectionStringSettings.ProviderName%2A>|<span data-ttu-id="eaef9-153">完全限定提供程序名。</span><span class="sxs-lookup"><span data-stu-id="eaef9-153">The fully qualified provider name.</span></span> <span data-ttu-id="eaef9-154">映射到 providerName 属性\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-154">Maps to the **providerName** attribute.</span></span>|  
|<xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A>|<span data-ttu-id="eaef9-155">连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-155">The connection string.</span></span> <span data-ttu-id="eaef9-156">映射到 connectionString 属性\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-156">Maps to the **connectionString** attribute.</span></span>|  
  
### <a name="example-listing-all-connection-strings"></a><span data-ttu-id="eaef9-157">示例：列出所有连接字符串</span><span class="sxs-lookup"><span data-stu-id="eaef9-157">Example: Listing All Connection Strings</span></span>  
 <span data-ttu-id="eaef9-158">此示例将循环访问， <xref:System.Configuration.ConnectionStringSettingsCollection> 并 <xref:System.Configuration.ConnectionStringSettings.Name%2A?displayProperty=nameWithType> <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A?displayProperty=nameWithType> <xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A?displayProperty=nameWithType> 在控制台窗口中显示、和属性。</span><span class="sxs-lookup"><span data-stu-id="eaef9-158">This example iterates through the <xref:System.Configuration.ConnectionStringSettingsCollection> and displays the <xref:System.Configuration.ConnectionStringSettings.Name%2A?displayProperty=nameWithType>, <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A?displayProperty=nameWithType>, and <xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A?displayProperty=nameWithType> properties in the console window.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-159">System.Configuration.dll 并不包含在所有项目类型中，您可能需要对其设置引用才能使用配置类。</span><span class="sxs-lookup"><span data-stu-id="eaef9-159">System.Configuration.dll is not included in all project types, and you may need to set a reference to it in order to use the configuration classes.</span></span> <span data-ttu-id="eaef9-160">特定应用程序配置文件的名称和位置因应用程序类型和宿主进程的不同而有所不同。</span><span class="sxs-lookup"><span data-stu-id="eaef9-160">The name and location of a particular application configuration file varies by the type of application and the hosting process.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfig#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfig/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfig#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfig/VB/source.vb#1)]  
  
### <a name="example-retrieving-a-connection-string-by-name"></a><span data-ttu-id="eaef9-161">示例：按名称检索连接字符串</span><span class="sxs-lookup"><span data-stu-id="eaef9-161">Example: Retrieving a Connection String by Name</span></span>  
 <span data-ttu-id="eaef9-162">此示例演示如何通过指定连接字符串名称从配置文件中检索连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-162">This example demonstrates how to retrieve a connection string from a configuration file by specifying its name.</span></span> <span data-ttu-id="eaef9-163">此代码创建一个 <xref:System.Configuration.ConnectionStringSettings> 对象，以将提供的输入参数与 <xref:System.Configuration.ConfigurationManager.ConnectionStrings%2A> 名称相匹配。</span><span class="sxs-lookup"><span data-stu-id="eaef9-163">The code creates a <xref:System.Configuration.ConnectionStringSettings> object, matching the supplied input parameter to the <xref:System.Configuration.ConfigurationManager.ConnectionStrings%2A> name.</span></span> <span data-ttu-id="eaef9-164">如果未找到匹配名称，则该函数返回 `null`（在 Visual Basic 中返回 `Nothing`）。</span><span class="sxs-lookup"><span data-stu-id="eaef9-164">If no matching name is found, the function returns `null` (`Nothing` in Visual Basic).</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfigByName#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByName/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfigByName#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByName/VB/source.vb#1)]  
  
### <a name="example-retrieving-a-connection-string-by-provider-name"></a><span data-ttu-id="eaef9-165">示例：按提供程序名称检索连接字符串</span><span class="sxs-lookup"><span data-stu-id="eaef9-165">Example: Retrieving a Connection String by Provider Name</span></span>  
 <span data-ttu-id="eaef9-166">此示例演示如何通过指定 System.Data.ProviderName 格式的提供程序固定名称来检索连接字符串\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-166">This example demonstrates how to retrieve a connection string by specifying the provider-invariant name in the format *System.Data.ProviderName*.</span></span> <span data-ttu-id="eaef9-167">此代码循环访问 <xref:System.Configuration.ConnectionStringSettingsCollection>，并返回找到的第一个 <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A> 的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="eaef9-167">The code iterates through the <xref:System.Configuration.ConnectionStringSettingsCollection> and returns the connection string for the first <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A> found.</span></span> <span data-ttu-id="eaef9-168">如果未找到提供程序名称，则该函数返回 `null`（在 Visual Basic 中返回 `Nothing`）。</span><span class="sxs-lookup"><span data-stu-id="eaef9-168">If the provider name is not found, the function returns `null` (`Nothing` in Visual Basic).</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider/VB/source.vb#1)]  
  
## <a name="encrypting-configuration-file-sections-using-protected-configuration"></a><span data-ttu-id="eaef9-169">使用受保护配置加密配置文件节</span><span class="sxs-lookup"><span data-stu-id="eaef9-169">Encrypting Configuration File Sections Using Protected Configuration</span></span>  
 <span data-ttu-id="eaef9-170">ASP.NET 2.0 引入了一个称为“受保护配置”的新功能，可以通过此功能来加密配置文件中的敏感信息\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-170">ASP.NET 2.0 introduced a new feature, called *protected configuration*, that enables you to encrypt sensitive information in a configuration file.</span></span> <span data-ttu-id="eaef9-171">虽然受保护配置主要是为 ASP.NET 应用程序设计的，但它也可以用于加密 Windows 应用程序中的配置文件节。</span><span class="sxs-lookup"><span data-stu-id="eaef9-171">Although primarily designed for ASP.NET, protected configuration can also be used to encrypt configuration file sections in Windows applications.</span></span> <span data-ttu-id="eaef9-172">有关受保护配置功能的详细说明，请参阅[使用受保护的配置加密配置信息](/previous-versions/aspnet/53tyfkaw(v=vs.100))。</span><span class="sxs-lookup"><span data-stu-id="eaef9-172">For a detailed description of the protected configuration capabilities, see [Encrypting Configuration Information Using Protected Configuration](/previous-versions/aspnet/53tyfkaw(v=vs.100)).</span></span>  
  
 <span data-ttu-id="eaef9-173">下面的配置文件片段演示加密后的 connectionStrings 节\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-173">The following configuration file fragment shows the **connectionStrings** section after it has been encrypted.</span></span> <span data-ttu-id="eaef9-174">configProtectionProvider 可指定用于加密和解密连接字符串的受保护配置提供程序\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-174">The **configProtectionProvider** specifies the protected configuration provider used to encrypt and decrypt the connection strings.</span></span> <span data-ttu-id="eaef9-175">EncryptedData 节包含密文\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-175">The **EncryptedData** section contains the cipher text.</span></span>  
  
```xml  
<connectionStrings configProtectionProvider="DataProtectionConfigurationProvider">  
  <EncryptedData>  
    <CipherData>  
      <CipherValue>AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAH2... </CipherValue>  
    </CipherData>  
  </EncryptedData>  
</connectionStrings>  
```  
  
 <span data-ttu-id="eaef9-176">在运行时检索加密连接字符串时，.NET Framework 会使用指定的提供程序来解密 CipherValue 并将其提供给应用程序\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-176">When the encrypted connection string is retrieved at run time, the .NET Framework uses the specified provider to decrypt the **CipherValue** and make it available to your application.</span></span> <span data-ttu-id="eaef9-177">你无需额外编写任何代码来管理解密过程。</span><span class="sxs-lookup"><span data-stu-id="eaef9-177">You do not need to write any additional code to manage the decryption process.</span></span>  
  
### <a name="protected-configuration-providers"></a><span data-ttu-id="eaef9-178">受保护配置提供程序</span><span class="sxs-lookup"><span data-stu-id="eaef9-178">Protected Configuration Providers</span></span>  
 <span data-ttu-id="eaef9-179">受保护配置提供程序是在本地计算机的 machine.config 文件的 configProtectedData 节中注册的（如下面的片段所示），此片段演示 .NET Framework 附带的两个受保护配置提供程序\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-179">Protected configuration providers are registered in the **configProtectedData** section of the **machine.config** file on the local computer, as shown in the following fragment, which shows the two protected configuration providers supplied with the .NET Framework.</span></span> <span data-ttu-id="eaef9-180">此处显示的值已被截断，以便于阅读。</span><span class="sxs-lookup"><span data-stu-id="eaef9-180">The values shown here have been truncated for readability.</span></span>  
  
```xml  
<configProtectedData defaultProvider="RsaProtectedConfigurationProvider">  
  <providers>  
    <add name="RsaProtectedConfigurationProvider"
      type="System.Configuration.RsaProtectedConfigurationProvider" />  
    <add name="DataProtectionConfigurationProvider"
      type="System.Configuration.DpapiProtectedConfigurationProvider" />  
  </providers>  
</configProtectedData>  
```  
  
 <span data-ttu-id="eaef9-181">可以配置其他受保护配置提供程序，方法是将它们添加到 machine.config 文件中\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-181">You can configure additional protected configuration providers by adding them to the **machine.config** file.</span></span> <span data-ttu-id="eaef9-182">还可以通过从 <xref:System.Configuration.ProtectedConfigurationProvider> 抽象基类继承来创建自己的受保护配置提供程序。</span><span class="sxs-lookup"><span data-stu-id="eaef9-182">You can also create your own protected configuration provider by inheriting from the <xref:System.Configuration.ProtectedConfigurationProvider> abstract base class.</span></span> <span data-ttu-id="eaef9-183">下表描述了 .NET Framework 附带的两个配置文件。</span><span class="sxs-lookup"><span data-stu-id="eaef9-183">The following table describes the two configuration files included with the .NET Framework.</span></span>  
  
|<span data-ttu-id="eaef9-184">提供程序</span><span class="sxs-lookup"><span data-stu-id="eaef9-184">Provider</span></span>|<span data-ttu-id="eaef9-185">描述</span><span class="sxs-lookup"><span data-stu-id="eaef9-185">Description</span></span>|  
|--------------|-----------------|  
|<xref:System.Configuration.RsaProtectedConfigurationProvider>|<span data-ttu-id="eaef9-186">使用 RSA 加密算法来加密和解密数据。</span><span class="sxs-lookup"><span data-stu-id="eaef9-186">Uses the RSA encryption algorithm to encrypt and decrypt data.</span></span> <span data-ttu-id="eaef9-187">RSA 算法既可用于公钥加密，也可用于数字签名。</span><span class="sxs-lookup"><span data-stu-id="eaef9-187">The RSA algorithm can be used for both public key encryption and digital signatures.</span></span> <span data-ttu-id="eaef9-188">它还称为“公共密钥”或非对称加密，因为它使用两个不同的密钥。</span><span class="sxs-lookup"><span data-stu-id="eaef9-188">It is also known as "public key" or asymmetrical encryption because it employs two different keys.</span></span> <span data-ttu-id="eaef9-189">可以使用 [ASP.NET IIS 注册工具 (Aspnet_regiis.exe)](/previous-versions/dotnet/netframework-3.5/k6h9cz8h(v=vs.90)) 来加密 Web.config 文件中的节和管理加密密钥。</span><span class="sxs-lookup"><span data-stu-id="eaef9-189">You can use the [ASP.NET IIS Registration Tool (Aspnet_regiis.exe)](/previous-versions/dotnet/netframework-3.5/k6h9cz8h(v=vs.90)) to encrypt sections in a Web.config file and manage the encryption keys.</span></span> <span data-ttu-id="eaef9-190">ASP.NET 在处理配置文件时解密该文件。</span><span class="sxs-lookup"><span data-stu-id="eaef9-190">ASP.NET decrypts the configuration file when it processes the file.</span></span> <span data-ttu-id="eaef9-191">ASP.NET 应用程序的标识必须对用于加密和解密各加密节的加密密钥具有读取权限。</span><span class="sxs-lookup"><span data-stu-id="eaef9-191">The identity of the ASP.NET application must have read access to the encryption key that is used to encrypt and decrypt the encrypted sections.</span></span>|  
|<xref:System.Configuration.DpapiProtectedConfigurationProvider>|<span data-ttu-id="eaef9-192">使用 Windows Data Protection API (DPAPI) 来加密配置节。</span><span class="sxs-lookup"><span data-stu-id="eaef9-192">Uses the Windows Data Protection API (DPAPI) to encrypt configuration sections.</span></span> <span data-ttu-id="eaef9-193">它使用 Windows 内置加密服务，并可为计算机特定或用户帐户特定保护进行配置。</span><span class="sxs-lookup"><span data-stu-id="eaef9-193">It uses the Windows built-in cryptographic services and can be configured for either machine-specific or user-account-specific protection.</span></span> <span data-ttu-id="eaef9-194">对于同一服务器上需要共享信息的多个应用程序来说，计算机特定保护非常有用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-194">Machine-specific protection is useful for multiple applications on the same server that need to share information.</span></span> <span data-ttu-id="eaef9-195">用户帐户特定保护可与以特定用户标识运行的服务（如共享宿主环境）一起使用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-195">User-account-specific protection can be used with services that run with a specific user identity, such as a shared hosting environment.</span></span> <span data-ttu-id="eaef9-196">每个应用程序以单独的标识运行，这样就限制了对文件和数据库等资源的访问。</span><span class="sxs-lookup"><span data-stu-id="eaef9-196">Each application runs under a separate identity which restricts access to resources such as files and databases.</span></span>|  
  
 <span data-ttu-id="eaef9-197">这两种提供程序都可以对数据进行强加密。</span><span class="sxs-lookup"><span data-stu-id="eaef9-197">Both providers offer strong encryption of data.</span></span> <span data-ttu-id="eaef9-198">但是，如果计划在多台服务器（如网络场）上使用相同的加密配置文件，则只有通过 <xref:System.Configuration.RsaProtectedConfigurationProvider> 才能导出用于加密数据的加密密钥，并将其导入其他服务器。</span><span class="sxs-lookup"><span data-stu-id="eaef9-198">However, if you are planning to use the same encrypted configuration file on multiple servers, such as a Web farm, only the <xref:System.Configuration.RsaProtectedConfigurationProvider> enables you to export the encryption keys used to encrypt the data and import them on another server.</span></span> <span data-ttu-id="eaef9-199">有关详细信息，请参阅[导入和导出受保护配置的 RSA 密钥容器](/previous-versions/aspnet/yxw286t2(v=vs.100))。</span><span class="sxs-lookup"><span data-stu-id="eaef9-199">For more information, see [Importing and Exporting Protected Configuration RSA Key Containers](/previous-versions/aspnet/yxw286t2(v=vs.100)).</span></span>  
  
### <a name="using-the-configuration-classes"></a><span data-ttu-id="eaef9-200">使用配置类</span><span class="sxs-lookup"><span data-stu-id="eaef9-200">Using the Configuration Classes</span></span>  
 <span data-ttu-id="eaef9-201"><xref:System.Configuration> 命名空间提供以编程方式使用配置设置的类。</span><span class="sxs-lookup"><span data-stu-id="eaef9-201">The <xref:System.Configuration> namespace provides classes to work with configuration settings programmatically.</span></span> <span data-ttu-id="eaef9-202"><xref:System.Configuration.ConfigurationManager> 类可提供对计算机、应用程序和用户配置文件的访问。</span><span class="sxs-lookup"><span data-stu-id="eaef9-202">The <xref:System.Configuration.ConfigurationManager> class provides access to machine, application, and user configuration files.</span></span> <span data-ttu-id="eaef9-203">如果创建的是 ASP.NET 应用程序，则可以使用 <xref:System.Web.Configuration.WebConfigurationManager> 类，该类提供相同的功能，同时还允许访问 ASP.NET 应用程序特有的设置，如中所述的设置 **\<system.web>** 。</span><span class="sxs-lookup"><span data-stu-id="eaef9-203">If you are creating an ASP.NET application, you can use the <xref:System.Web.Configuration.WebConfigurationManager> class, which provides the same functionality while also allowing you to access settings that are unique to ASP.NET applications, such as those found in **\<system.web>**.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-204"><xref:System.Security.Cryptography> 命名空间包含提供用于加密和解密数据的其他选项的类。</span><span class="sxs-lookup"><span data-stu-id="eaef9-204">The <xref:System.Security.Cryptography> namespace contains classes that provide additional options for encrypting and decrypting data.</span></span> <span data-ttu-id="eaef9-205">如果需要采用在使用受保护配置时不可用的加密服务，请使用这些类。</span><span class="sxs-lookup"><span data-stu-id="eaef9-205">Use these classes if you require cryptographic services that are not available using protected configuration.</span></span> <span data-ttu-id="eaef9-206">一些类是非托管 Microsoft CryptoAPI 的包装类，而其他类则是纯托管实现。</span><span class="sxs-lookup"><span data-stu-id="eaef9-206">Some of these classes are wrappers for the unmanaged Microsoft CryptoAPI, while others are purely managed implementations.</span></span> <span data-ttu-id="eaef9-207">有关更多信息，请参阅[加密服务](/previous-versions/visualstudio/visual-studio-2008/93bskf9z(v=vs.90))。</span><span class="sxs-lookup"><span data-stu-id="eaef9-207">For more information, see [Cryptographic Services](/previous-versions/visualstudio/visual-studio-2008/93bskf9z(v=vs.90)).</span></span>  
  
### <a name="appconfig-example"></a><span data-ttu-id="eaef9-208">App.config 示例</span><span class="sxs-lookup"><span data-stu-id="eaef9-208">App.config Example</span></span>  
 <span data-ttu-id="eaef9-209">此示例演示如何对 Windows 应用程序的 app.config 文件中的 connectionStrings 节的加密进行切换\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-209">This example demonstrates how to toggle encrypting the **connectionStrings** section in an **app.config** file for a Windows application.</span></span> <span data-ttu-id="eaef9-210">在此示例中，该过程将应用程序的名称（例如“MyApplication.exe”）作为一个参数。</span><span class="sxs-lookup"><span data-stu-id="eaef9-210">In this example, the procedure takes the name of the application as an argument, for example, "MyApplication.exe".</span></span> <span data-ttu-id="eaef9-211">然后，将对 app.config 文件进行加密，并采用名称“MyApplication.exe.config”将其复制到包含可执行文件的文件夹中\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-211">The **app.config** file will then be encrypted and copied to the folder that contains the executable under the name of "MyApplication.exe.config".</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-212">只能在加密连接字符串的计算机上对其进行解密。</span><span class="sxs-lookup"><span data-stu-id="eaef9-212">The connection string can only be decrypted on the computer on which it was encrypted.</span></span>  
  
 <span data-ttu-id="eaef9-213">代码使用 <xref:System.Configuration.ConfigurationManager.OpenExeConfiguration%2A> 方法打开 app.config 文件以进行编辑，<xref:System.Configuration.ConfigurationManager.GetSection%2A> 方法返回 connectionStrings 节\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-213">The code uses the <xref:System.Configuration.ConfigurationManager.OpenExeConfiguration%2A> method to open the **app.config** file for editing, and the <xref:System.Configuration.ConfigurationManager.GetSection%2A> method returns the **connectionStrings** section.</span></span> <span data-ttu-id="eaef9-214">然后，代码检查 <xref:System.Configuration.SectionInformation.IsProtected%2A> 属性，调用 <xref:System.Configuration.SectionInformation.ProtectSection%2A> 以加密未加密的节。</span><span class="sxs-lookup"><span data-stu-id="eaef9-214">The code then checks the <xref:System.Configuration.SectionInformation.IsProtected%2A> property, calling the <xref:System.Configuration.SectionInformation.ProtectSection%2A> to encrypt the section if it is not encrypted.</span></span> <span data-ttu-id="eaef9-215">调用 <xref:System.Configuration.SectionInformation.UnprotectSection%2A> 方法以加密该节。</span><span class="sxs-lookup"><span data-stu-id="eaef9-215">The <xref:System.Configuration.SectionInformation.UnprotectSection%2A> method is invoked to decrypt the section.</span></span> <span data-ttu-id="eaef9-216"><xref:System.Configuration.Configuration.Save%2A> 方法完成该操作并保存所做更改。</span><span class="sxs-lookup"><span data-stu-id="eaef9-216">The <xref:System.Configuration.Configuration.Save%2A> method completes the operation and saves the changes.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="eaef9-217">必须在要运行代码的项目中设置对 `System.Configuration.dll` 的引用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-217">You must set a reference to `System.Configuration.dll` in your project for the code to run.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStrings.Encrypt#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStrings.Encrypt/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStrings.Encrypt#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStrings.Encrypt/VB/source.vb#1)]  
  
### <a name="webconfig-example"></a><span data-ttu-id="eaef9-218">Web.config 示例</span><span class="sxs-lookup"><span data-stu-id="eaef9-218">Web.config Example</span></span>  
 <span data-ttu-id="eaef9-219">此示例使用 <xref:System.Web.Configuration.WebConfigurationManager.OpenWebConfiguration%2A> 的 `WebConfigurationManager` 方法。</span><span class="sxs-lookup"><span data-stu-id="eaef9-219">This example uses the <xref:System.Web.Configuration.WebConfigurationManager.OpenWebConfiguration%2A> method of the `WebConfigurationManager`.</span></span> <span data-ttu-id="eaef9-220">注意，在这种情况下，可以通过使用波形符来提供 Web.config 文件的相对路径\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="eaef9-220">Note that in this case you can supply the relative path to the **Web.config** file by using a tilde.</span></span> <span data-ttu-id="eaef9-221">代码需要对 `System.Web.Configuration` 类的引用。</span><span class="sxs-lookup"><span data-stu-id="eaef9-221">The code requires a reference to the `System.Web.Configuration` class.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringsWeb.Encrypt#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringsWeb.Encrypt/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringsWeb.Encrypt#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringsWeb.Encrypt/VB/source.vb#1)]  
  
 <span data-ttu-id="eaef9-222">有关保护 ASP.NET 应用程序安全的详细信息，请参阅 [保护 ASP.NET 网站的安全](/previous-versions/aspnet/91f66yxt(v=vs.100))。</span><span class="sxs-lookup"><span data-stu-id="eaef9-222">For more information about securing ASP.NET applications, see [Securing ASP.NET web sites](/previous-versions/aspnet/91f66yxt(v=vs.100)).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="eaef9-223">请参阅</span><span class="sxs-lookup"><span data-stu-id="eaef9-223">See also</span></span>

- [<span data-ttu-id="eaef9-224">连接字符串生成器</span><span class="sxs-lookup"><span data-stu-id="eaef9-224">Connection String Builders</span></span>](connection-string-builders.md)
- [<span data-ttu-id="eaef9-225">保护连接信息</span><span class="sxs-lookup"><span data-stu-id="eaef9-225">Protecting Connection Information</span></span>](protecting-connection-information.md)
- <span data-ttu-id="eaef9-226">[使用配置类](/previous-versions/visualstudio/visual-studio-2008/ms228063(v=vs.90))</span><span class="sxs-lookup"><span data-stu-id="eaef9-226">[Using the Configuration Classes](/previous-versions/visualstudio/visual-studio-2008/ms228063(v=vs.90))</span></span>
- [<span data-ttu-id="eaef9-227">配置应用程序</span><span class="sxs-lookup"><span data-stu-id="eaef9-227">Configuring Apps</span></span>](../../configure-apps/index.md)
- <span data-ttu-id="eaef9-228">[ASP.NET 网站管理](/previous-versions/aspnet/6hy1xzbw(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="eaef9-228">[ASP.NET Web Site Administration](/previous-versions/aspnet/6hy1xzbw(v=vs.100))</span></span>
- [<span data-ttu-id="eaef9-229">ADO.NET 概述</span><span class="sxs-lookup"><span data-stu-id="eaef9-229">ADO.NET Overview</span></span>](ado-net-overview.md)

---
title: LINQ to Entities
description: '了解如何创建和运行 LINQ to Entities 查询，这些查询允许使用 Visual Basic 或 Visual c # 针对实体框架概念模型编写查询。'
ms.date: 03/30/2017
ms.assetid: 641f9b68-9046-47a1-abb0-1c8eaeda0e2d
ms.openlocfilehash: 809cbd10be6a2bc44bb4bff0ba3ea363da676f7f
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/24/2020
ms.locfileid: "91150786"
---
# <a name="linq-to-entities"></a><span data-ttu-id="8a224-103">LINQ to Entities</span><span class="sxs-lookup"><span data-stu-id="8a224-103">LINQ to Entities</span></span>

<span data-ttu-id="8a224-104">LINQ to Entities 提供语言集成查询 (LINQ) 支持，它允许开发人员使用 Visual Basic 或 Visual C# 根据实体框架概念模型编写查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-104">LINQ to Entities provides Language-Integrated Query (LINQ) support that enables developers to write queries against the Entity Framework conceptual model using Visual Basic or Visual C#.</span></span> <span data-ttu-id="8a224-105">针对实体框架的查询由针对对象上下文执行的命令目录树查询表示。</span><span class="sxs-lookup"><span data-stu-id="8a224-105">Queries against the Entity Framework are represented by command tree queries, which execute against the object context.</span></span> <span data-ttu-id="8a224-106">LINQ to Entities 将语言集成查询 (LINQ) 查询转换为命令目录树查询，针对实体框架执行这些查询，并返回可同时由实体框架和 LINQ 使用的对象。</span><span class="sxs-lookup"><span data-stu-id="8a224-106">LINQ to Entities converts Language-Integrated Queries (LINQ) queries to command tree queries, executes the queries against the Entity Framework, and returns objects that can be used by both the Entity Framework and LINQ.</span></span> <span data-ttu-id="8a224-107">以下是创建和执行 LINQ to Entities 查询的过程：</span><span class="sxs-lookup"><span data-stu-id="8a224-107">The following is the process for creating and executing a LINQ to Entities query:</span></span>  
  
1. <span data-ttu-id="8a224-108">从 <xref:System.Data.Objects.ObjectQuery%601> 构造 <xref:System.Data.Objects.ObjectContext> 实例。</span><span class="sxs-lookup"><span data-stu-id="8a224-108">Construct an <xref:System.Data.Objects.ObjectQuery%601> instance from <xref:System.Data.Objects.ObjectContext>.</span></span>  
  
2. <span data-ttu-id="8a224-109">通过使用 <xref:System.Data.Objects.ObjectQuery%601> 实例在 C# 或 Visual Basic 中编写 LINQ to Entities 查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-109">Compose a LINQ to Entities query in C# or Visual Basic by using the <xref:System.Data.Objects.ObjectQuery%601> instance.</span></span>  
  
3. <span data-ttu-id="8a224-110">将 LINQ 标准查询运算符和表达式将转换为命令目录树。</span><span class="sxs-lookup"><span data-stu-id="8a224-110">Convert LINQ standard query operators and expressions to command trees.</span></span>  
  
4. <span data-ttu-id="8a224-111">对数据源执行命令目录树表示形式的查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-111">Execute the query, in command tree representation, against the data source.</span></span> <span data-ttu-id="8a224-112">执行过程中在数据源上引发的任何异常都将直接向上传递到客户端。</span><span class="sxs-lookup"><span data-stu-id="8a224-112">Any exceptions thrown on the data source during execution are passed directly up to the client.</span></span>  
  
5. <span data-ttu-id="8a224-113">将查询结果返回到客户端。</span><span class="sxs-lookup"><span data-stu-id="8a224-113">Return query results back to the client.</span></span>  
  
## <a name="constructing-an-objectquery-instance"></a><span data-ttu-id="8a224-114">构造 ObjectQuery 实例</span><span class="sxs-lookup"><span data-stu-id="8a224-114">Constructing an ObjectQuery Instance</span></span>  

 <span data-ttu-id="8a224-115"><xref:System.Data.Objects.ObjectQuery%601> 泛型类表示一个查询，此查询返回由零个或零个以上类型化实体组成的集合。</span><span class="sxs-lookup"><span data-stu-id="8a224-115">The <xref:System.Data.Objects.ObjectQuery%601> generic class represents a query that returns a collection of zero or more typed entities.</span></span> <span data-ttu-id="8a224-116">对象查询通常从现有对象上下文中构造（而不是手动构造），并且始终属于该对象上下文。</span><span class="sxs-lookup"><span data-stu-id="8a224-116">An object query is typically constructed from an existing object context, instead of being manually constructed, and always belongs to that object context.</span></span> <span data-ttu-id="8a224-117">此上下文提供了编写和执行查询所需的连接和元数据信息。</span><span class="sxs-lookup"><span data-stu-id="8a224-117">This context provides the connection and metadata information that is required to compose and execute the query.</span></span> <span data-ttu-id="8a224-118"><xref:System.Data.Objects.ObjectQuery%601> 泛型类实现 <xref:System.Linq.IQueryable%601> 泛型接口，借助于该接口的生成器方法，能够以增量方式生成 LINQ 查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-118">The <xref:System.Data.Objects.ObjectQuery%601> generic class implements the <xref:System.Linq.IQueryable%601> generic interface, whose builder methods enable LINQ queries to be incrementally built.</span></span> <span data-ttu-id="8a224-119">也可以使用 C# `var` 关键字（在 Visual Basic 中为 `Dim`，启用局部类型推理）让编译器推断实体的类型。</span><span class="sxs-lookup"><span data-stu-id="8a224-119">You can also let the compiler infer the type of entities by using the C# `var` keyword (`Dim` in Visual Basic, with local type inference enabled).</span></span>  
  
## <a name="composing-the-queries"></a><span data-ttu-id="8a224-120">编写查询</span><span class="sxs-lookup"><span data-stu-id="8a224-120">Composing the Queries</span></span>  

 <span data-ttu-id="8a224-121"><xref:System.Data.Objects.ObjectQuery%601> 泛型类（可实现泛型 <xref:System.Linq.IQueryable%601> 接口）的实例可充当 LINQ to Entities 查询的数据源。</span><span class="sxs-lookup"><span data-stu-id="8a224-121">Instances of the <xref:System.Data.Objects.ObjectQuery%601> generic class, which implements the generic <xref:System.Linq.IQueryable%601> interface, serve as the data source for LINQ to Entities queries.</span></span> <span data-ttu-id="8a224-122">在查询中，您可以确切指定要从数据源检索哪些信息。</span><span class="sxs-lookup"><span data-stu-id="8a224-122">In a query, you specify exactly the information that you want to retrieve from the data source.</span></span> <span data-ttu-id="8a224-123">查询也可以指定返回信息之前信息的排序、分组和表现方式。</span><span class="sxs-lookup"><span data-stu-id="8a224-123">A query can also specify how that information should be sorted, grouped, and shaped before it is returned.</span></span> <span data-ttu-id="8a224-124">在 LINQ 中，查询存储在变量中。</span><span class="sxs-lookup"><span data-stu-id="8a224-124">In LINQ, a query is stored in a variable.</span></span> <span data-ttu-id="8a224-125">此查询变量不执行任何操作，也不返回任何数据；它只存储查询信息。</span><span class="sxs-lookup"><span data-stu-id="8a224-125">This query variable takes no action and returns no data; it only stores the query information.</span></span> <span data-ttu-id="8a224-126">创建查询后必须执行该查询以检索任何数据。</span><span class="sxs-lookup"><span data-stu-id="8a224-126">After you create a query you must execute that query to retrieve any data.</span></span>  
  
 <span data-ttu-id="8a224-127">可以通过两种语法编写 LINQ to Entities 查询：查询表达式语法和基于方法的查询语法。</span><span class="sxs-lookup"><span data-stu-id="8a224-127">LINQ to Entities queries can be composed in two different syntaxes: query expression syntax and method-based query syntax.</span></span> <span data-ttu-id="8a224-128">查询表达式语法和基于方法的查询语法是 C# 3.0 和 Visual Basic 9.0 中的新增功能。</span><span class="sxs-lookup"><span data-stu-id="8a224-128">Query expression syntax and method-based query syntax are new in C# 3.0 and Visual Basic 9.0.</span></span>  
  
 <span data-ttu-id="8a224-129">有关详细信息，请参阅 [LINQ to Entities 中的查询](queries-in-linq-to-entities.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-129">For more information, see [Queries in LINQ to Entities](queries-in-linq-to-entities.md).</span></span>  
  
## <a name="query-conversion"></a><span data-ttu-id="8a224-130">查询转换</span><span class="sxs-lookup"><span data-stu-id="8a224-130">Query Conversion</span></span>  

 <span data-ttu-id="8a224-131">若要针对实体框架执行 LINQ to Entities 查询，必须将 LINQ 查询转换为可针对实体框架执行的命令目录树表示形式。</span><span class="sxs-lookup"><span data-stu-id="8a224-131">To execute a LINQ to Entities query against the Entity Framework, the LINQ query must be converted to a command tree representation that can be executed against the Entity Framework.</span></span>  
  
 <span data-ttu-id="8a224-132">LINQ to Entities 查询由 LINQ 标准查询运算符组成 (例如，、 <xref:System.Linq.Queryable.Select%2A> <xref:System.Linq.Queryable.Where%2A> 和 <xref:System.Linq.Queryable.GroupBy%2A>) 和表达式 (x > 10、Contact 等) 。</span><span class="sxs-lookup"><span data-stu-id="8a224-132">LINQ to Entities queries are comprised of LINQ standard query operators (such as <xref:System.Linq.Queryable.Select%2A>, <xref:System.Linq.Queryable.Where%2A>, and <xref:System.Linq.Queryable.GroupBy%2A>) and expressions (x > 10, Contact.LastName, and so on).</span></span> <span data-ttu-id="8a224-133">LINQ 运算符并非由类定义，而是由类中的方法定义。</span><span class="sxs-lookup"><span data-stu-id="8a224-133">LINQ operators are not defined by a class, but rather are methods on a class.</span></span> <span data-ttu-id="8a224-134">在 LINQ 中，表达式可包含 <xref:System.Linq.Expressions> 命名空间内的类型所允许的任何内容，并且，通过扩展，可包含可在 lambda 函数中表示的任何内容。</span><span class="sxs-lookup"><span data-stu-id="8a224-134">In LINQ, expressions can contain anything allowed by types within the <xref:System.Linq.Expressions> namespace and, by extension, anything that can be represented in a lambda function.</span></span> <span data-ttu-id="8a224-135">这是实体框架允许的表达式的超集，这些表达式在定义上限于数据库所允许的操作，并且受到 <xref:System.Data.Objects.ObjectQuery%601> 支持。</span><span class="sxs-lookup"><span data-stu-id="8a224-135">This is a superset of the expressions that are allowed by the Entity Framework, which are by definition restricted to operations allowed on the database, and supported by <xref:System.Data.Objects.ObjectQuery%601>.</span></span>  
  
 <span data-ttu-id="8a224-136">在实体框架中，运算符和表达式同时由单一类型层次结构表示，这些运算符和表达式随后会放入命令目录树中。</span><span class="sxs-lookup"><span data-stu-id="8a224-136">In the Entity Framework, both operators and expressions are represented by a single type hierarchy, which are then placed in a command tree.</span></span> <span data-ttu-id="8a224-137">实体框架使用命令目录树来执行此查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-137">The command tree is used by the Entity Framework to execute the query.</span></span> <span data-ttu-id="8a224-138">如果 LINQ 查询无法表示为命令目录树，则当转换查询时，将引发异常。</span><span class="sxs-lookup"><span data-stu-id="8a224-138">If the LINQ query cannot be expressed as a command tree, an exception will be thrown when the query is being converted.</span></span> <span data-ttu-id="8a224-139">LINQ to Entities 查询的转换涉及两个子转换：标准查询运算符的转换和表达式转换。</span><span class="sxs-lookup"><span data-stu-id="8a224-139">The conversion of LINQ to Entities queries involves two sub-conversions: the conversion of the standard query operators, and the conversion of the expressions.</span></span>  
  
 <span data-ttu-id="8a224-140">一些 LINQ 标准查询运算符在 LINQ to Entities 中没有有效的转换。</span><span class="sxs-lookup"><span data-stu-id="8a224-140">There are a number of LINQ standard query operators that do not have a valid translation in LINQ to Entities.</span></span> <span data-ttu-id="8a224-141">尝试使用这些运算符将在查询转换期间导致异常。</span><span class="sxs-lookup"><span data-stu-id="8a224-141">Attempts to use these operators will result in an exception at query translation time.</span></span> <span data-ttu-id="8a224-142">有关支持的 LINQ to Entities 运算符的列表，请参阅 [LINQ to Entities) 中支持和不支持的 LINQ 方法 (](supported-and-unsupported-linq-methods-linq-to-entities.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-142">For a list of supported LINQ to Entities operators, see [Supported and Unsupported LINQ Methods (LINQ to Entities)](supported-and-unsupported-linq-methods-linq-to-entities.md).</span></span>  
  
 <span data-ttu-id="8a224-143">有关在 LINQ to Entities 中使用标准查询运算符的详细信息，请参阅 [LINQ to Entities 查询中的标准查询运算符](standard-query-operators-in-linq-to-entities-queries.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-143">For more information about using the standard query operators in LINQ to Entities, see [Standard Query Operators in LINQ to Entities Queries](standard-query-operators-in-linq-to-entities-queries.md).</span></span>  
  
 <span data-ttu-id="8a224-144">通常，LINQ to Entities 中的表达式将在服务器上求值，这样，表达式的行为不会遵循 CLR 语义。</span><span class="sxs-lookup"><span data-stu-id="8a224-144">In general, expressions in LINQ to Entities are evaluated on the server, so the behavior of the expression should not be expected to follow CLR semantics.</span></span> <span data-ttu-id="8a224-145">有关详细信息，请参阅 [LINQ to Entities 查询中的表达式](expressions-in-linq-to-entities-queries.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-145">For more information, see [Expressions in LINQ to Entities Queries](expressions-in-linq-to-entities-queries.md).</span></span>  
  
 <span data-ttu-id="8a224-146">有关 CLR 方法调用如何映射到数据源中的规范函数的信息，请参阅 [Clr 方法到规范函数的映射](clr-method-to-canonical-function-mapping.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-146">For information about how CLR method calls are mapped to canonical functions in the data source, see [CLR Method to Canonical Function Mapping](clr-method-to-canonical-function-mapping.md).</span></span>  
  
 <span data-ttu-id="8a224-147">有关如何从 LINQ to Entities 查询中调用规范、数据库和自定义函数的信息，请参阅 [LINQ to Entities 查询中调用函数](calling-functions-in-linq-to-entities-queries.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-147">For information about how to call canonical, database, and custom functions from within LINQ to Entities queries, see [Calling Functions in LINQ to Entities Queries](calling-functions-in-linq-to-entities-queries.md).</span></span>  
  
## <a name="query-execution"></a><span data-ttu-id="8a224-148">查询执行</span><span class="sxs-lookup"><span data-stu-id="8a224-148">Query Execution</span></span>  

 <span data-ttu-id="8a224-149">在用户创建 LINQ 查询之后，该查询将转换为与实体框架兼容的表示形式（采用命令树形式），然后针对数据源执行此查询。</span><span class="sxs-lookup"><span data-stu-id="8a224-149">After the LINQ query is created by the user, it is converted to a representation that is compatible with the Entity Framework (in the form of command trees), which is then executed against the data source.</span></span> <span data-ttu-id="8a224-150">在查询执行时间，将在客户端或服务器上计算所有查询表达式（或查询的组成部分）的值。</span><span class="sxs-lookup"><span data-stu-id="8a224-150">At query execution time, all query expressions (or components of the query) are evaluated on the client or on the server.</span></span> <span data-ttu-id="8a224-151">这包括在结果具体化或实体投影中使用的表达式。</span><span class="sxs-lookup"><span data-stu-id="8a224-151">This includes expressions that are used in result materialization or entity projections.</span></span> <span data-ttu-id="8a224-152">有关详细信息，请参阅 [查询执行](query-execution.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-152">For more information, see [Query Execution](query-execution.md).</span></span> <span data-ttu-id="8a224-153">若要了解如何通过编译查询一次，然后使用不同的参数多次执行它来提高性能，请参阅 [)  (LINQ to Entities 的编译查询 ](compiled-queries-linq-to-entities.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-153">For information on how to improve performance by compiling a query once and then executing it several times with different parameters, see [Compiled Queries  (LINQ to Entities)](compiled-queries-linq-to-entities.md).</span></span>  
  
## <a name="materialization"></a><span data-ttu-id="8a224-154">具体化</span><span class="sxs-lookup"><span data-stu-id="8a224-154">Materialization</span></span>  

 <span data-ttu-id="8a224-155">具体化是将查询结果作为 CLR 类型返回到客户端的过程。</span><span class="sxs-lookup"><span data-stu-id="8a224-155">Materialization is the process of returning query results back to the client as CLR types.</span></span> <span data-ttu-id="8a224-156">在 LINQ to Entities 中，从不返回查询结果数据记录；始终存在一个后备 CLR 类型，该类型由用户或实体框架定义，或者由编译器生成（匿名类型）。</span><span class="sxs-lookup"><span data-stu-id="8a224-156">In LINQ to Entities, query results data records are never returned; there is always a backing CLR type, defined by the user or by the Entity Framework, or generated by the compiler (anonymous types).</span></span> <span data-ttu-id="8a224-157">所有对象具体化均由实体框架执行。</span><span class="sxs-lookup"><span data-stu-id="8a224-157">All object materialization is performed by the Entity Framework.</span></span> <span data-ttu-id="8a224-158">由于无法在实体框架与 CLR 之间进行映射而导致的任何错误都将导致在对象具体化过程中引发异常。</span><span class="sxs-lookup"><span data-stu-id="8a224-158">Any errors that result from an inability to map between the Entity Framework and the CLR will cause exceptions to be thrown during object materialization.</span></span>  
  
 <span data-ttu-id="8a224-159">查询结果通常以下面的某一种形式返回：</span><span class="sxs-lookup"><span data-stu-id="8a224-159">Query results are usually returned as one of the following:</span></span>  
  
- <span data-ttu-id="8a224-160">概念模型中定义的零个或多个类型化实体对象的集合或复杂类型的投影。</span><span class="sxs-lookup"><span data-stu-id="8a224-160">A collection of zero or more typed entity objects or a projection of complex types defined in the conceptual model.</span></span>  
  
- <span data-ttu-id="8a224-161">实体框架支持的 CLR 类型。</span><span class="sxs-lookup"><span data-stu-id="8a224-161">CLR types that are supported by the Entity Framework.</span></span>  
  
- <span data-ttu-id="8a224-162">内联集合。</span><span class="sxs-lookup"><span data-stu-id="8a224-162">Inline collections.</span></span>  
  
- <span data-ttu-id="8a224-163">匿名类型。</span><span class="sxs-lookup"><span data-stu-id="8a224-163">Anonymous types.</span></span>  
  
 <span data-ttu-id="8a224-164">有关详细信息，请参阅 [查询结果](query-results.md)。</span><span class="sxs-lookup"><span data-stu-id="8a224-164">For more information, see [Query Results](query-results.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="8a224-165">本节内容</span><span class="sxs-lookup"><span data-stu-id="8a224-165">In This Section</span></span>  

 [<span data-ttu-id="8a224-166">LINQ to Entities 中的查询</span><span class="sxs-lookup"><span data-stu-id="8a224-166">Queries in LINQ to Entities</span></span>](queries-in-linq-to-entities.md)  
  
 [<span data-ttu-id="8a224-167">LINQ to Entities 查询中的表达式</span><span class="sxs-lookup"><span data-stu-id="8a224-167">Expressions in LINQ to Entities Queries</span></span>](expressions-in-linq-to-entities-queries.md)  
  
 [<span data-ttu-id="8a224-168">在 LINQ to Entities 查询中调用函数</span><span class="sxs-lookup"><span data-stu-id="8a224-168">Calling Functions in LINQ to Entities Queries</span></span>](calling-functions-in-linq-to-entities-queries.md)  
  
 [<span data-ttu-id="8a224-169">已编译查询 (LINQ to Entities) </span><span class="sxs-lookup"><span data-stu-id="8a224-169">Compiled Queries  (LINQ to Entities)</span></span>](compiled-queries-linq-to-entities.md)  
  
 [<span data-ttu-id="8a224-170">查询执行</span><span class="sxs-lookup"><span data-stu-id="8a224-170">Query Execution</span></span>](query-execution.md)  
  
 [<span data-ttu-id="8a224-171">查询结果</span><span class="sxs-lookup"><span data-stu-id="8a224-171">Query Results</span></span>](query-results.md)  
  
 [<span data-ttu-id="8a224-172">LINQ to Entities 查询中的标准查询运算符</span><span class="sxs-lookup"><span data-stu-id="8a224-172">Standard Query Operators in LINQ to Entities Queries</span></span>](standard-query-operators-in-linq-to-entities-queries.md)  
  
 [<span data-ttu-id="8a224-173">CLR 方法至规范函数映射</span><span class="sxs-lookup"><span data-stu-id="8a224-173">CLR Method to Canonical Function Mapping</span></span>](clr-method-to-canonical-function-mapping.md)  
  
 [<span data-ttu-id="8a224-174">支持和不支持的 LINQ 方法 (LINQ to Entities)</span><span class="sxs-lookup"><span data-stu-id="8a224-174">Supported and Unsupported LINQ Methods (LINQ to Entities)</span></span>](supported-and-unsupported-linq-methods-linq-to-entities.md)  
  
 [<span data-ttu-id="8a224-175">LINQ to Entities 中的已知问题和注意事项</span><span class="sxs-lookup"><span data-stu-id="8a224-175">Known Issues and Considerations in LINQ to Entities</span></span>](known-issues-and-considerations-in-linq-to-entities.md)  
  
## <a name="see-also"></a><span data-ttu-id="8a224-176">请参阅</span><span class="sxs-lookup"><span data-stu-id="8a224-176">See also</span></span>

- [<span data-ttu-id="8a224-177">LINQ to Entities 中的已知问题和注意事项</span><span class="sxs-lookup"><span data-stu-id="8a224-177">Known Issues and Considerations in LINQ to Entities</span></span>](known-issues-and-considerations-in-linq-to-entities.md)
- [<span data-ttu-id="8a224-178">语言集成查询 (LINQ) - C#</span><span class="sxs-lookup"><span data-stu-id="8a224-178">Language-Integrated Query (LINQ) - C#</span></span>](../../../../../csharp/programming-guide/concepts/linq/index.md)
- [<span data-ttu-id="8a224-179">语言集成查询 (LINQ) - Visual Basic</span><span class="sxs-lookup"><span data-stu-id="8a224-179">Language-Integrated Query (LINQ) - Visual Basic</span></span>](../../../../../visual-basic/programming-guide/concepts/linq/index.md)
- [<span data-ttu-id="8a224-180">LINQ 和 ADO.NET</span><span class="sxs-lookup"><span data-stu-id="8a224-180">LINQ and ADO.NET</span></span>](../../linq-and-ado-net.md)
- [<span data-ttu-id="8a224-181">ADO.NET 实体框架</span><span class="sxs-lookup"><span data-stu-id="8a224-181">ADO.NET Entity Framework</span></span>](../index.md)

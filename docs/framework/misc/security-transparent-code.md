---
title: 安全透明的代码
description: 了解透明代码模型的用途，如何指定透明度级别和安全性的透明度强制。
ms.date: 03/30/2017
helpviewer_keywords:
- transparent code
- security-transparent code
ms.assetid: 4f3dd841-82f7-4659-aab0-6d2db2166c65
ms.openlocfilehash: a167efe12b88f796fba4abc6d60ebffe4693709a
ms.sourcegitcommit: 0fa2b7b658bf137e813a7f4d09589d64c148ebf5
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/14/2020
ms.locfileid: "86309841"
---
# <a name="security-transparent-code"></a><span data-ttu-id="4832c-103">安全透明的代码</span><span class="sxs-lookup"><span data-stu-id="4832c-103">Security-Transparent Code</span></span>

[!INCLUDE[net_security_note](../../../includes/net-security-note-md.md)]

<span data-ttu-id="4832c-104">安全性涉及三个交互部分：沙盒处理、权限和强制。</span><span class="sxs-lookup"><span data-stu-id="4832c-104">Security involves three interacting pieces: sandboxing, permissions, and enforcement.</span></span> <span data-ttu-id="4832c-105">沙盒处理是指创建隔离域的做法，在隔离域中某些代码被视为完全信任，而其他代码则被限制为沙盒授予集中的权限。</span><span class="sxs-lookup"><span data-stu-id="4832c-105">Sandboxing refers to the practice of creating isolated domains where some code is treated as fully trusted and other code is restricted to the permissions in the grant set for the sandbox.</span></span> <span data-ttu-id="4832c-106">在沙盒授予集内运行的应用程序代码被视为透明的，也就是说，它不能执行任何影响安全性的操作。</span><span class="sxs-lookup"><span data-stu-id="4832c-106">The application code that runs within the grant set of the sandbox is considered to be transparent; that is, it cannot perform any operations that can affect security.</span></span> <span data-ttu-id="4832c-107">沙盒的授予集由证据（<xref:System.Security.Policy.Evidence> 类）决定。</span><span class="sxs-lookup"><span data-stu-id="4832c-107">The grant set for the sandbox is determined by evidence (<xref:System.Security.Policy.Evidence> class).</span></span> <span data-ttu-id="4832c-108">证据标识沙盒需要哪些特定权限，以及可以创建哪种沙盒。</span><span class="sxs-lookup"><span data-stu-id="4832c-108">Evidence identifies what specific permissions are required by sandboxes, and what kinds of sandboxes can be created.</span></span> <span data-ttu-id="4832c-109">强制是指允许透明代码仅在其授予集内执行。</span><span class="sxs-lookup"><span data-stu-id="4832c-109">Enforcement refers to allowing transparent code to execute only within its grant set.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4832c-110">安全策略是旧版 .NET Framework 中的关键元素。</span><span class="sxs-lookup"><span data-stu-id="4832c-110">Security policy was a key element in previous versions of the .NET Framework.</span></span> <span data-ttu-id="4832c-111">从 .NET Framework 4 开始，安全策略已过时。</span><span class="sxs-lookup"><span data-stu-id="4832c-111">Starting with the .NET Framework 4, security policy is obsolete.</span></span> <span data-ttu-id="4832c-112">安全策略的取消独立于安全透明度。</span><span class="sxs-lookup"><span data-stu-id="4832c-112">The elimination of security policy is separate from security transparency.</span></span> <span data-ttu-id="4832c-113">有关此更改的效果的信息，请参阅[代码访问安全策略兼容性和迁移](code-access-security-policy-compatibility-and-migration.md)。</span><span class="sxs-lookup"><span data-stu-id="4832c-113">For information about the effects of this change, see [Code Access Security Policy Compatibility and Migration](code-access-security-policy-compatibility-and-migration.md).</span></span>

## <a name="purpose-of-the-transparency-model"></a><span data-ttu-id="4832c-114">透明度模型的用途</span><span class="sxs-lookup"><span data-stu-id="4832c-114">Purpose of the Transparency Model</span></span>

<span data-ttu-id="4832c-115">透明度是一种强制机制，用于将作为应用程序的一部分运行的代码与作为基础结构的一部分运行代码区分开来。</span><span class="sxs-lookup"><span data-stu-id="4832c-115">Transparency is an enforcement mechanism that separates code that runs as part of the application from code that runs as part of the infrastructure.</span></span> <span data-ttu-id="4832c-116">透明度在可以执行特许事件（例如调用本机代码）的代码（关键代码）和无法执行的代码（透明代码）之间绘制一个屏障。</span><span class="sxs-lookup"><span data-stu-id="4832c-116">Transparency draws a barrier between code that can do privileged things (critical code), such as calling native code, and code that cannot (transparent code).</span></span> <span data-ttu-id="4832c-117">透明代码可以在其运行的权限集边界内执行命令，但不能执行、派生自或包含关键代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-117">Transparent code can execute commands within the bounds of the permission set it is operating in, but cannot execute, derive from, or contain critical code.</span></span>

<span data-ttu-id="4832c-118">透明度强制的主要目标是提供简单而有效的机制，以基于特权隔离不同的代码组。</span><span class="sxs-lookup"><span data-stu-id="4832c-118">The primary goal of transparency enforcement is to provide a simple, effective mechanism for isolating different groups of code based on privilege.</span></span> <span data-ttu-id="4832c-119">在沙盒处理模型的上下文中，这些特权组是完全信任的（即不受限制）或部分信任的（即限于授予沙盒的权限集）。</span><span class="sxs-lookup"><span data-stu-id="4832c-119">Within the context of the sandboxing model, these privilege groups are either fully trusted (that is, not restricted) or partially trusted (that is, restricted to the permission set granted to the sandbox).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4832c-120">透明度模型优于代码访问安全性。</span><span class="sxs-lookup"><span data-stu-id="4832c-120">The transparency model transcends code access security.</span></span> <span data-ttu-id="4832c-121">透明度由实时编译器强制执行，并保持有效，而不考虑程序集的授予集（包括完全信任）。</span><span class="sxs-lookup"><span data-stu-id="4832c-121">Transparency is enforced by the just-in-time compiler and remains in effect regardless of the grant set for an assembly, including full trust.</span></span>

<span data-ttu-id="4832c-122">.NET Framework 2.0 版中引入了透明度，用于简化安全模型，使其更易于编写和部署安全库和应用程序。</span><span class="sxs-lookup"><span data-stu-id="4832c-122">Transparency was introduced in the .NET Framework version 2.0 to simplify the security model, and to make it easier to write and deploy secure libraries and applications.</span></span> <span data-ttu-id="4832c-123">Microsoft Silverlight 中也使用了透明代码，用于简化部分信任的应用程序的开发。</span><span class="sxs-lookup"><span data-stu-id="4832c-123">Transparent code is also used in Microsoft Silverlight, to simplify the development of partially trusted applications.</span></span>

> [!NOTE]
> <span data-ttu-id="4832c-124">当开发部分信任的应用程序时，必须知道目标主机的权限要求。</span><span class="sxs-lookup"><span data-stu-id="4832c-124">When you develop a partially trusted application, you have to be aware of the permission requirements for your target hosts.</span></span> <span data-ttu-id="4832c-125">你可以开发使用某些主机不允许的资源的应用程序。</span><span class="sxs-lookup"><span data-stu-id="4832c-125">You can develop an application that uses resources that are not allowed by some hosts.</span></span> <span data-ttu-id="4832c-126">此应用程序编译时不会出错，但将无法加载到托管环境中。</span><span class="sxs-lookup"><span data-stu-id="4832c-126">This application will compile without error, but will fail when it is loaded into the hosted environment.</span></span> <span data-ttu-id="4832c-127">如果已使用 Visual Studio 开发了应用程序，就可以在部分信任的环境中启用调试或在开发环境中启用受限的权限集。</span><span class="sxs-lookup"><span data-stu-id="4832c-127">If you have developed your application using Visual Studio, you can enable debugging in partial trust or in a restricted permission set from the development environment.</span></span> <span data-ttu-id="4832c-128">有关更多信息，请参见 [如何：使用受限权限对 ClickOnce 应用程序进行调试](/visualstudio/deployment/how-to-debug-a-clickonce-application-with-restricted-permissions)。</span><span class="sxs-lookup"><span data-stu-id="4832c-128">For more information, see [How to: Debug a ClickOnce Application with Restricted Permissions](/visualstudio/deployment/how-to-debug-a-clickonce-application-with-restricted-permissions).</span></span> <span data-ttu-id="4832c-129">为 ClickOnce 应用程序提供的计算权限功能也可用于部分信任的任何应用程序。</span><span class="sxs-lookup"><span data-stu-id="4832c-129">The Calculate Permissions feature provided for ClickOnce applications is also available for any partially trusted application.</span></span>

## <a name="specifying-the-transparency-level"></a><span data-ttu-id="4832c-130">指定透明度级别</span><span class="sxs-lookup"><span data-stu-id="4832c-130">Specifying the Transparency Level</span></span>

<span data-ttu-id="4832c-131">程序集级别的 <xref:System.Security.SecurityRulesAttribute> 特性显式选择该程序集将遵循的 <xref:System.Security.SecurityRuleSet> 规则。</span><span class="sxs-lookup"><span data-stu-id="4832c-131">The assembly-level <xref:System.Security.SecurityRulesAttribute> attribute explicitly selects the <xref:System.Security.SecurityRuleSet> rules that the assembly will follow.</span></span> <span data-ttu-id="4832c-132">这些规则在数字级别系统下组织，级别越高表示安全规则的强制性越高。</span><span class="sxs-lookup"><span data-stu-id="4832c-132">The rules are organized under a numeric level system, where higher levels mean tighter enforcement of security rules.</span></span>

<span data-ttu-id="4832c-133">级别如下：</span><span class="sxs-lookup"><span data-stu-id="4832c-133">The levels are as follows:</span></span>

- <span data-ttu-id="4832c-134">Level 2 （ <xref:System.Security.SecurityRuleSet.Level2> ）– .NET Framework 4 透明度规则。</span><span class="sxs-lookup"><span data-stu-id="4832c-134">Level 2 (<xref:System.Security.SecurityRuleSet.Level2>) – the .NET Framework 4 transparency rules.</span></span>

- <span data-ttu-id="4832c-135">1 级 (<xref:System.Security.SecurityRuleSet.Level1>) –.NET Framework 2.0 透明度规则。</span><span class="sxs-lookup"><span data-stu-id="4832c-135">Level 1 (<xref:System.Security.SecurityRuleSet.Level1>) – the .NET Framework 2.0 transparency rules.</span></span>

<span data-ttu-id="4832c-136">这两个透明度级别之间的主要区别是 1 级不对程序集外部的调用强制实施透明度规则，并且预期仅用于实现兼容性。</span><span class="sxs-lookup"><span data-stu-id="4832c-136">The primary difference between the two transparency levels is that level 1 does not enforce transparency rules for calls from outside the assembly and is intended only for compatibility.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4832c-137">你应仅出于兼容性目的指定 1 级透明度，也就是说，仅为使用 .NET Framework 3.5 或更早版本（这些版本使用 <xref:System.Security.AllowPartiallyTrustedCallersAttribute> 属性或不使用透明度模型）开发的代码指定 1 级。</span><span class="sxs-lookup"><span data-stu-id="4832c-137">You should specify level 1 transparency for compatibility only; that is, specify level 1 only for code that was developed with the .NET Framework 3.5 or earlier that uses the <xref:System.Security.AllowPartiallyTrustedCallersAttribute> attribute or does not use the transparency model.</span></span> <span data-ttu-id="4832c-138">例如，对允许从部分信任的调用方 (APTCA) 调用的 .NET Framework 2.0 程序集使用 1 级透明度。</span><span class="sxs-lookup"><span data-stu-id="4832c-138">For example, use level 1 transparency for .NET Framework 2.0 assemblies that allow calls from partially trusted callers (APTCA).</span></span> <span data-ttu-id="4832c-139">对于为 .NET Framework 4 开发的代码，请始终使用2级透明度。</span><span class="sxs-lookup"><span data-stu-id="4832c-139">For code that is developed for the .NET Framework 4, always use level 2 transparency.</span></span>

### <a name="level-2-transparency"></a><span data-ttu-id="4832c-140">2 级透明度</span><span class="sxs-lookup"><span data-stu-id="4832c-140">Level 2 Transparency</span></span>

<span data-ttu-id="4832c-141">.NET Framework 4 中引入了2级透明度。</span><span class="sxs-lookup"><span data-stu-id="4832c-141">Level 2 transparency was introduced in the .NET Framework 4.</span></span> <span data-ttu-id="4832c-142">此模型的三条原则是透明代码、安全可靠关键代码和安全关键代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-142">The three tenets of this model are transparent code, security-safe-critical code, and security-critical code.</span></span>

- <span data-ttu-id="4832c-143">透明代码（无论授予什么样的权限）可以调用其他透明代码或安全可靠关键代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-143">Transparent code, regardless of the permissions it is granted (including full trust), can call only other transparent code or security-safe-critical code.</span></span> <span data-ttu-id="4832c-144">如果代码是部分信任的代码，那么它只能执行域权限集允许的操作。</span><span class="sxs-lookup"><span data-stu-id="4832c-144">If the code is partially trusted, it can only perform actions that are allowed by the domain’s permission set.</span></span> <span data-ttu-id="4832c-145">透明代码不能：</span><span class="sxs-lookup"><span data-stu-id="4832c-145">Transparent code cannot do the following:</span></span>

  - <span data-ttu-id="4832c-146">执行 <xref:System.Security.CodeAccessPermission.Assert%2A> 操作或特权提升。</span><span class="sxs-lookup"><span data-stu-id="4832c-146">Perform an <xref:System.Security.CodeAccessPermission.Assert%2A> operation or elevation of privilege.</span></span>

  - <span data-ttu-id="4832c-147">包含不安全或不可验证的代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-147">Contain unsafe or unverifiable code.</span></span>

  - <span data-ttu-id="4832c-148">直接调用关键代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-148">Directly call critical code.</span></span>

  - <span data-ttu-id="4832c-149">调用本机代码或具有 <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> 特性的代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-149">Call native code or code that has the <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> attribute.</span></span>

  - <span data-ttu-id="4832c-150">调用受 <xref:System.Security.Permissions.SecurityAction.LinkDemand> 保护的成员。</span><span class="sxs-lookup"><span data-stu-id="4832c-150">Call a member that is protected by a <xref:System.Security.Permissions.SecurityAction.LinkDemand>.</span></span>

  - <span data-ttu-id="4832c-151">从关键类型继承。</span><span class="sxs-lookup"><span data-stu-id="4832c-151">Inherit from critical types.</span></span>

    <span data-ttu-id="4832c-152">此外，透明方法不能重写关键虚拟方法或实现关键接口方法。</span><span class="sxs-lookup"><span data-stu-id="4832c-152">In addition, transparent methods cannot override critical virtual methods or implement critical interface methods.</span></span>

- <span data-ttu-id="4832c-153">安全可靠关键代码是完全信任的代码，且可被透明代码调用的代码。</span><span class="sxs-lookup"><span data-stu-id="4832c-153">Security-safe-critical code is fully trusted but is callable by transparent code.</span></span> <span data-ttu-id="4832c-154">它公开完全信任代码的有限外围应用。</span><span class="sxs-lookup"><span data-stu-id="4832c-154">It exposes a limited surface area of full-trust code.</span></span> <span data-ttu-id="4832c-155">可靠关键代码中会进行正确性和安全性验证。</span><span class="sxs-lookup"><span data-stu-id="4832c-155">Correctness and security verifications happen in safe-critical code.</span></span>

- <span data-ttu-id="4832c-156">安全关键代码可以调用完全信任的任何代码，但不能被透明代码调用。</span><span class="sxs-lookup"><span data-stu-id="4832c-156">Security-critical code can call any code and is fully trusted, but it cannot be called by transparent code.</span></span>

### <a name="level-1-transparency"></a><span data-ttu-id="4832c-157">1 级透明度</span><span class="sxs-lookup"><span data-stu-id="4832c-157">Level 1 Transparency</span></span>

<span data-ttu-id="4832c-158">.NET Framework 2.0 版中引入了 1 级透明度模型，目的是便于开发人员减少需要接受安全性审核的代码数量。</span><span class="sxs-lookup"><span data-stu-id="4832c-158">The level 1 transparency model was introduced in the .NET Framework version 2.0 to enable developers to reduce the amount of code that is subject to a security audit.</span></span> <span data-ttu-id="4832c-159">虽然 1 级透明度在 2.0 版中公开提供，但它主要仅在 Microsoft 内部用于安全性审核目的。</span><span class="sxs-lookup"><span data-stu-id="4832c-159">Although level 1 transparency was publicly available in version 2.0, it was primarily used only within Microsoft for security auditing purposes.</span></span> <span data-ttu-id="4832c-160">开发人员可以通过批注声明哪些类型和成员可以执行安全提升和其他信任操作（安全关键），哪些不能执行（安全透明）。</span><span class="sxs-lookup"><span data-stu-id="4832c-160">Through annotations, developers are able to declare which types and members can perform security elevations and other trusted actions (security-critical) and which cannot (security-transparent).</span></span> <span data-ttu-id="4832c-161">标识为透明的代码不需要高度的安全性审核。</span><span class="sxs-lookup"><span data-stu-id="4832c-161">Code that is identified as transparent does not require a high degree of security auditing.</span></span> <span data-ttu-id="4832c-162">1 级透明度表明透明度强制仅限于程序集内部。</span><span class="sxs-lookup"><span data-stu-id="4832c-162">Level 1 transparency states that the transparency enforcement is limited to within the assembly.</span></span> <span data-ttu-id="4832c-163">换而言之，标识为安全关键的任何公共类型或成员仅在该程序集内部是安全关键的。</span><span class="sxs-lookup"><span data-stu-id="4832c-163">In other words, any public types or members that are identified as security-critical are security-critical only within the assembly.</span></span> <span data-ttu-id="4832c-164">如果希望在从程序集外部调用这些类型和成员时对它们强制实施安全性，则必须使用完全信任的链接要求。</span><span class="sxs-lookup"><span data-stu-id="4832c-164">If you want to enforce security for those types and members when they are called from outside the assembly, you must use link demands for full trust.</span></span> <span data-ttu-id="4832c-165">如果不这样做，则公开可见的安全关键类型和成员将被视为安全可靠关键，并且可在程序集外部被部分信任的代码调用。</span><span class="sxs-lookup"><span data-stu-id="4832c-165">If you do not, publicly visible security-critical types and members are treated as security-safe-critical and can be called by partially trusted code outside the assembly.</span></span>

<span data-ttu-id="4832c-166">1 级透明度模型具有以下限制：</span><span class="sxs-lookup"><span data-stu-id="4832c-166">The level 1 transparency model has the following limitations:</span></span>

- <span data-ttu-id="4832c-167">安全关键类型和成员是公开的，可从安全透明代码访问。</span><span class="sxs-lookup"><span data-stu-id="4832c-167">Security-critical types and members that are public are accessible from security-transparent code.</span></span>

- <span data-ttu-id="4832c-168">只能在程序集内部强制进行透明度批注。</span><span class="sxs-lookup"><span data-stu-id="4832c-168">The transparency annotations are enforced only within an assembly.</span></span>

- <span data-ttu-id="4832c-169">安全关键类型和成员必须使用链接要求才能对程序集外部的调用强制实施安全性。</span><span class="sxs-lookup"><span data-stu-id="4832c-169">Security-critical types and members must use link demands to enforce security for calls from outside the assembly.</span></span>

- <span data-ttu-id="4832c-170">不会强制执行继承规则。</span><span class="sxs-lookup"><span data-stu-id="4832c-170">Inheritance rules are not enforced.</span></span>

- <span data-ttu-id="4832c-171">在完全信任模式下运行时，透明代码可能会执行有害的操作。</span><span class="sxs-lookup"><span data-stu-id="4832c-171">The potential exists for transparent code to do harmful things when run in full trust.</span></span>

## <a name="transparency-enforcement"></a><span data-ttu-id="4832c-172">透明度强制</span><span class="sxs-lookup"><span data-stu-id="4832c-172">Transparency Enforcement</span></span>

<span data-ttu-id="4832c-173">在计算透明度之前，不会强制执行透明度规则。</span><span class="sxs-lookup"><span data-stu-id="4832c-173">Transparency rules are not enforced until transparency is calculated.</span></span> <span data-ttu-id="4832c-174">那时，如果违反了透明度规则，则将引发 <xref:System.InvalidOperationException>。</span><span class="sxs-lookup"><span data-stu-id="4832c-174">At that time, an <xref:System.InvalidOperationException> is thrown if a transparency rule is violated.</span></span> <span data-ttu-id="4832c-175">计算透明度的时间取决于多种因素，并且无法预测。</span><span class="sxs-lookup"><span data-stu-id="4832c-175">The time that transparency is calculated depends on multiple factors and cannot be predicted.</span></span> <span data-ttu-id="4832c-176">应尽可能晚地计算。</span><span class="sxs-lookup"><span data-stu-id="4832c-176">It is calculated as late as possible.</span></span> <span data-ttu-id="4832c-177">在 .NET Framework 4 中，程序集级别的透明度计算比 .NET Framework 2.0 更早。</span><span class="sxs-lookup"><span data-stu-id="4832c-177">In the .NET Framework 4, assembly-level transparency calculation occurs sooner than it does in the .NET Framework 2.0.</span></span> <span data-ttu-id="4832c-178">只能保证透明度计算将在需要的时间之前发生。</span><span class="sxs-lookup"><span data-stu-id="4832c-178">The only guarantee is that transparency calculation will occur by the time it is needed.</span></span> <span data-ttu-id="4832c-179">这类似于在编译某种方法且在该方法中检测到错误时实时 (JIT) 编译器将如何更改时间点。</span><span class="sxs-lookup"><span data-stu-id="4832c-179">This is similar to how the just-in-time (JIT) compiler can change the point when a method is compiled and any errors in that method are detected.</span></span> <span data-ttu-id="4832c-180">如果你的代码没有透明度错误，则透明度计算是不可见的。</span><span class="sxs-lookup"><span data-stu-id="4832c-180">Transparency calculation is invisible if your code does not have any transparency errors.</span></span>

## <a name="see-also"></a><span data-ttu-id="4832c-181">另请参阅</span><span class="sxs-lookup"><span data-stu-id="4832c-181">See also</span></span>

- [<span data-ttu-id="4832c-182">安全透明代码，级别1</span><span class="sxs-lookup"><span data-stu-id="4832c-182">Security-Transparent Code, Level 1</span></span>](security-transparent-code-level-1.md)
- [<span data-ttu-id="4832c-183">安全透明的代码，级别 2</span><span class="sxs-lookup"><span data-stu-id="4832c-183">Security-Transparent Code, Level 2</span></span>](security-transparent-code-level-2.md)

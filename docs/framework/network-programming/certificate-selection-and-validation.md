---
title: 证书选择和验证
description: 了解 System.Net 类提供的用于选择和验证 SSL/TLS 连接的证书的几种方法。
ms.date: 03/30/2017
ms.assetid: c933aca2-4cd0-4ff1-9df9-267143f25a6f
ms.openlocfilehash: a85b6947c20f7dbced1fb6ad6e79f3134ce1f57b
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/26/2020
ms.locfileid: "96287509"
---
# <a name="certificate-selection-and-validation"></a><span data-ttu-id="14b4a-103">证书选择和验证</span><span class="sxs-lookup"><span data-stu-id="14b4a-103">Certificate Selection and Validation</span></span>

<span data-ttu-id="14b4a-104"><xref:System.Net> 类支持多种针对安全套接字层 (SSL) 连接选择和验证 <xref:System.Security.Cryptography.X509Certificates> 的方法。</span><span class="sxs-lookup"><span data-stu-id="14b4a-104">The <xref:System.Net> classes support several ways to select and validate <xref:System.Security.Cryptography.X509Certificates> for Secure Socket Layer (SSL) connections.</span></span> <span data-ttu-id="14b4a-105">客户端可以选择一个或多个证书对服务器自身的客户端进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="14b4a-105">A client can select one or more certificates to authenticate itself to a server.</span></span> <span data-ttu-id="14b4a-106">服务器可以要求客户端证书具有一个或多个用于身份验证的特定属性。</span><span class="sxs-lookup"><span data-stu-id="14b4a-106">A server can require that a client certificate have one or more specific attributes for authentication.</span></span>  
  
## <a name="definition"></a><span data-ttu-id="14b4a-107">定义</span><span class="sxs-lookup"><span data-stu-id="14b4a-107">Definition</span></span>  

 <span data-ttu-id="14b4a-108">证书是 ASCII 字节流，包含公钥、属性（如版本号、序列号和到期日期）以及来自证书颁发机构的数字签名。</span><span class="sxs-lookup"><span data-stu-id="14b4a-108">A certificate is an ASCII byte stream that contains a public key, attributes (such as version number, serial number, and expiration date) and a digital signature from a Certificate Authority.</span></span> <span data-ttu-id="14b4a-109">证书用于建立加密连接，或对服务器的客户端进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="14b4a-109">Certificates are used to establish an encrypted connection or to authenticate a client to a server.</span></span>  
  
## <a name="client-certificate-selection-and-validation"></a><span data-ttu-id="14b4a-110">客户端证书选择和验证</span><span class="sxs-lookup"><span data-stu-id="14b4a-110">Client Certificate Selection and Validation</span></span>  

 <span data-ttu-id="14b4a-111">客户端可以选择一个或多个用于特定 SSL 连接的证书。</span><span class="sxs-lookup"><span data-stu-id="14b4a-111">A client can select one or more certificates for a specific SSL connection.</span></span> <span data-ttu-id="14b4a-112">客户端证书可以与 Web 服务器或 SMTP 邮件服务器的 SSL 连接相关联。</span><span class="sxs-lookup"><span data-stu-id="14b4a-112">Client certificates can be associated with the SSL connection to a web server or an SMTP mail server.</span></span> <span data-ttu-id="14b4a-113">客户端将证书添加到 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 或 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 类对象集合。</span><span class="sxs-lookup"><span data-stu-id="14b4a-113">A client adds certificates to a collection of <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects.</span></span> <span data-ttu-id="14b4a-114">以电子邮件为例，证书集合是一个与 <xref:System.Net.Mail.SmtpClient> 类的 <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> 属性相关联的 <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection> 实例。</span><span class="sxs-lookup"><span data-stu-id="14b4a-114">Using email as an example, the certificate collection is an instance of a <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection>) associated with the <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> property of the <xref:System.Net.Mail.SmtpClient> class.</span></span> <span data-ttu-id="14b4a-115"><xref:System.Net.HttpWebRequest> 类具有类似的 <xref:System.Net.HttpWebRequest.ClientCertificates%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="14b4a-115">The <xref:System.Net.HttpWebRequest> class has a similar <xref:System.Net.HttpWebRequest.ClientCertificates%2A> property.</span></span>  
  
 <span data-ttu-id="14b4a-116"><xref:System.Security.Cryptography.X509Certificates.X509Certificate> 和 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 类的主要区别是私钥需要保存在 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 类的证书存储中。</span><span class="sxs-lookup"><span data-stu-id="14b4a-116">The primary difference between the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class is that the private key must reside in the certificate store for the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> class.</span></span>  
  
 <span data-ttu-id="14b4a-117">即使证书添加到集合并与特定 SSL 连接相关联，也不会向服务器发送任何证书，除非服务器作出请求。</span><span class="sxs-lookup"><span data-stu-id="14b4a-117">Even if certificates are added to a collection and associated with a specific SSL connection, no certificates will be sent to the server unless the server requests them.</span></span> <span data-ttu-id="14b4a-118">如果某个连接上设置了多个客户端证书，则将根据算法使用连接性能最好的一个，该算法会考虑由服务器提供的证书颁发者列表与客户端证书颁发者名称之间的匹配。</span><span class="sxs-lookup"><span data-stu-id="14b4a-118">If multiple client certificates are set on a connection, the best one will be used based on an algorithm that considers the match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span>  
  
 <span data-ttu-id="14b4a-119"><xref:System.Net.Security.SslStream> 类甚至对 SSL 握手提供了更多控制。</span><span class="sxs-lookup"><span data-stu-id="14b4a-119">The <xref:System.Net.Security.SslStream> class provides even more control over the SSL handshake.</span></span> <span data-ttu-id="14b4a-120">客户端可以指定委托选取要使用的客户端证书。</span><span class="sxs-lookup"><span data-stu-id="14b4a-120">A client can specify a delegate to pick which client certificate to use.</span></span>  
  
 <span data-ttu-id="14b4a-121">远程服务器可以验证客户端证书是否有效、是否为最新，以及是否由适当的证书颁发机构签名。</span><span class="sxs-lookup"><span data-stu-id="14b4a-121">A remote server can verify that a client certificate is valid, current, and signed by the appropriate Certificate Authority.</span></span> <span data-ttu-id="14b4a-122">委托可以添加到 <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> 以强制执行证书验证。</span><span class="sxs-lookup"><span data-stu-id="14b4a-122">A delegate can be added to the <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> to enforce certificate validation.</span></span>  
  
## <a name="client-certificate-selection"></a><span data-ttu-id="14b4a-123">客户端证书选择</span><span class="sxs-lookup"><span data-stu-id="14b4a-123">Client Certificate Selection</span></span>  

 <span data-ttu-id="14b4a-124">NET Framework 按以下方式选择将提供给服务器的客户端证书：</span><span class="sxs-lookup"><span data-stu-id="14b4a-124">The .NET Framework selects the client certificate to present to the server in the following manner:</span></span>  
  
1. <span data-ttu-id="14b4a-125">如果之前已向服务器提供客户端证书，首次提供时，证书将被缓存，并且重复用于后续客户端证书请求。</span><span class="sxs-lookup"><span data-stu-id="14b4a-125">If a client certificate was presented previously to the server, the certificate is cached when first presented and is reused for subsequent client certificate requests.</span></span>  
  
2. <span data-ttu-id="14b4a-126">如果存在委托，请始终使用委托的结果作为客户端证书的选择。</span><span class="sxs-lookup"><span data-stu-id="14b4a-126">If a delegate is present, always use the result from the delegate as the client certificate to select.</span></span> <span data-ttu-id="14b4a-127">若可能，请尝试使用已缓存的证书，但如果委托已返回 NULL，且证书集合不为空，请勿使用已缓存的匿名凭据。</span><span class="sxs-lookup"><span data-stu-id="14b4a-127">Try to use a cached certificate when possible, but do not use cached anonymous credentials if the delegate has returned null and the certificate collection is not empty.</span></span>  
  
3. <span data-ttu-id="14b4a-128">如果这是对客户端证书的第一次质询，Framework 将枚举与连接关联的 <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 或 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 类对象中的证书，查找由服务器提供的证书颁布者列表与客户端证书颁布者名称之间的匹配。</span><span class="sxs-lookup"><span data-stu-id="14b4a-128">If this is the first challenge for a client certificate, the Framework enumerates the certificates in <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span> <span data-ttu-id="14b4a-129">匹配的第一个证书将被发送到服务器。</span><span class="sxs-lookup"><span data-stu-id="14b4a-129">The first certificate that matches is sent to the server.</span></span> <span data-ttu-id="14b4a-130">如果没有证书匹配或证书集合为空，则向服务器发送匿名凭据。</span><span class="sxs-lookup"><span data-stu-id="14b4a-130">If no certificate matches or the certificate collection is empty, then an anonymous credential is sent to the server.</span></span>  
  
## <a name="tools-for-certificate-configuration"></a><span data-ttu-id="14b4a-131">证书配置工具</span><span class="sxs-lookup"><span data-stu-id="14b4a-131">Tools for Certificate Configuration</span></span>  

 <span data-ttu-id="14b4a-132">许多工具都可用于配置客户端和服务器证书。</span><span class="sxs-lookup"><span data-stu-id="14b4a-132">A number of tools are available for client and server certificate configuration.</span></span>  
  
 <span data-ttu-id="14b4a-133">Winhttpcertcfg.exe 工具可用于配置客户端证书。</span><span class="sxs-lookup"><span data-stu-id="14b4a-133">The *Winhttpcertcfg.exe* tool can be used to configure client certificates.</span></span> <span data-ttu-id="14b4a-134">Winhttpcertcfg.exe 工具作为 Windows Server 2003 Resource Kit 的工具之一提供。</span><span class="sxs-lookup"><span data-stu-id="14b4a-134">The *Winhttpcertcfg.exe* tool is provided as one of the tools with the Windows Server 2003 Resource Kit.</span></span> <span data-ttu-id="14b4a-135">该工具在 [www.microsoft.com](https://www.microsoft.com) 上也是作为 Windows Server 2003 Resource Kit 工具的部件可供下载。</span><span class="sxs-lookup"><span data-stu-id="14b4a-135">This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at [www.microsoft.com](https://www.microsoft.com).</span></span>  
  
<span data-ttu-id="14b4a-136">HttpCfg.exe 工具可用于配置 <xref:System.Net.HttpListener> 类的服务器证书。</span><span class="sxs-lookup"><span data-stu-id="14b4a-136">The *HttpCfg.exe* tool can be used to configure server certificates for the <xref:System.Net.HttpListener> class.</span></span> <span data-ttu-id="14b4a-137">HttpCfg.exe 工具作为 Windows Server 2003 和 Windows XP Service Pack 2 的支持工具之一提供。</span><span class="sxs-lookup"><span data-stu-id="14b4a-137">The *HttpCfg.exe* tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2.</span></span> <span data-ttu-id="14b4a-138">默认情况下，Windows Server 2003 或 Windows XP 上都未安装 HttpCfg.exe 和其他支持工具。</span><span class="sxs-lookup"><span data-stu-id="14b4a-138">*HttpCfg.exe* and the other support tools are not installed by default on either Windows Server 2003 or Windows XP.</span></span> <span data-ttu-id="14b4a-139">在 Windows Server 2003 上，</span><span class="sxs-lookup"><span data-stu-id="14b4a-139">On Windows Server 2003.</span></span> <span data-ttu-id="14b4a-140">支持工具单独安装在 Windows Server 2003 CD-ROM 上的以下文件夹和文件中：</span><span class="sxs-lookup"><span data-stu-id="14b4a-140">the support tools are installed separately from the following folder and file on the Windows Server 2003 CD-ROM:</span></span>  
  
 <span data-ttu-id="14b4a-141">\Support\Tools\Suptools.msi</span><span class="sxs-lookup"><span data-stu-id="14b4a-141">\Support\Tools\Suptools.msi</span></span>  
  
 <span data-ttu-id="14b4a-142">若要使用 Windows XP Service Pack 2，可访问 [www.microsoft.com](https://www.microsoft.com) 下载 Windows XP 支持工具。</span><span class="sxs-lookup"><span data-stu-id="14b4a-142">For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from [www.microsoft.com](https://www.microsoft.com).</span></span>  
  
 <span data-ttu-id="14b4a-143">HttpCfg.exe 工具版本的源代码也可用作 Windows Server SDK 的示例。</span><span class="sxs-lookup"><span data-stu-id="14b4a-143">The source code to a version of the *HttpCfg.exe* tool is also provided as a sample with the Windows Server SDK.</span></span> <span data-ttu-id="14b4a-144">HttpCfg.exe 示例的源代码使用网络示例作为 Windows SDK 的部件在以下文件夹中默认安装：</span><span class="sxs-lookup"><span data-stu-id="14b4a-144">The source code to the *HttpCfg.exe* sample is installed by default with the networking samples as part of the Windows SDK under the following folder:</span></span>  
  
 <span data-ttu-id="14b4a-145">C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig</span><span class="sxs-lookup"><span data-stu-id="14b4a-145">*C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig*</span></span>  
  
 <span data-ttu-id="14b4a-146">除了这些工具， <xref:System.Security.Cryptography.X509Certificates.X509Certificate> 和 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 类还提供从文件系统加载证书的方法。</span><span class="sxs-lookup"><span data-stu-id="14b4a-146">In addition to these tools, the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> classes provides methods for loading a certificate from the file system.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="14b4a-147">请参阅</span><span class="sxs-lookup"><span data-stu-id="14b4a-147">See also</span></span>

- [<span data-ttu-id="14b4a-148">网络编程中的安全性</span><span class="sxs-lookup"><span data-stu-id="14b4a-148">Security in Network Programming</span></span>](security-in-network-programming.md)
- [<span data-ttu-id="14b4a-149">.NET Framework 中的网络编程</span><span class="sxs-lookup"><span data-stu-id="14b4a-149">Network Programming in the .NET Framework</span></span>](index.md)

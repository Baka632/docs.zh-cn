---
title: 异步编程模型 (APM)
description: 了解 .NET 中的异步编程模型 (APM)。 了解如何开始和结束异步操作。
ms.date: 03/30/2017
helpviewer_keywords:
- ending asynchronous operations
- starting asynchronous operations
- beginning asynchronous operations
- asynchronous programming, ending operations
- asynchronous programming
- stopping asynchronous operations
- asynchronous programming, beginning operations
ms.assetid: c9b3501e-6bc6-40f9-8efd-4b6d9e39ccf0
ms.openlocfilehash: a6e2ed06e92adffa6c8a61b27bbff994370e8b34
ms.sourcegitcommit: d8020797a6657d0fbbdff362b80300815f682f94
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/24/2020
ms.locfileid: "95722734"
---
# <a name="asynchronous-programming-model-apm"></a><span data-ttu-id="5ec2b-104">异步编程模型 (APM)</span><span class="sxs-lookup"><span data-stu-id="5ec2b-104">Asynchronous Programming Model (APM)</span></span>

<span data-ttu-id="5ec2b-105">使用 <xref:System.IAsyncResult> 设计模式的异步操作是通过名为 `BeginOperationName` 和 `EndOperationName` 的两个方法来实现的，这两个方法分别开始和结束异步操作 OperationName。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-105">An asynchronous operation that uses the <xref:System.IAsyncResult> design pattern is implemented as two methods named `BeginOperationName` and `EndOperationName` that begin and end the asynchronous operation *OperationName* respectively.</span></span> <span data-ttu-id="5ec2b-106">例如， <xref:System.IO.FileStream> 类提供 <xref:System.IO.FileStream.BeginRead%2A> 和 <xref:System.IO.FileStream.EndRead%2A> 方法来从文件异步读取字节。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-106">For example, the <xref:System.IO.FileStream> class provides the <xref:System.IO.FileStream.BeginRead%2A> and <xref:System.IO.FileStream.EndRead%2A> methods to asynchronously read bytes from a file.</span></span> <span data-ttu-id="5ec2b-107">这两个方法实现了 <xref:System.IO.FileStream.Read%2A> 方法的异步版本。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-107">These methods implement the asynchronous version of the <xref:System.IO.FileStream.Read%2A> method.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5ec2b-108">从 .NET Framework 4 开始，任务并行库为异步和并行编程提供了一种新模型。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-108">Starting with the .NET Framework 4, the Task Parallel Library provides a new model for asynchronous and parallel programming.</span></span> <span data-ttu-id="5ec2b-109">有关详细信息，请参阅 “[任务并行库 (TPL)](../parallel-programming/task-parallel-library-tpl.md)” 和 “[基于任务的异步模式 (TAP)](task-based-asynchronous-pattern-tap.md)”。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-109">For more information, see [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) and [Task-based Asynchronous Pattern (TAP)](task-based-asynchronous-pattern-tap.md)).</span></span>  
  
 <span data-ttu-id="5ec2b-110">在调用 `BeginOperationName` 后，应用程序可以继续在调用线程上执行指令，同时异步操作在另一个线程上执行。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-110">After calling `BeginOperationName`, an application can continue executing instructions on the calling thread while the asynchronous operation takes place on a different thread.</span></span> <span data-ttu-id="5ec2b-111">每次调用 `BeginOperationName` 时，应用程序还应调用 `EndOperationName` 来获取操作的结果。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-111">For each call to `BeginOperationName`, the application should also call `EndOperationName` to get the results of the operation.</span></span>  
  
## <a name="beginning-an-asynchronous-operation"></a><span data-ttu-id="5ec2b-112">开始异步操作</span><span class="sxs-lookup"><span data-stu-id="5ec2b-112">Beginning an Asynchronous Operation</span></span>  

 <span data-ttu-id="5ec2b-113">`BeginOperationName` 方法开始异步操作 OperationName，并返回实现 <xref:System.IAsyncResult> 接口的对象。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-113">The `BeginOperationName` method begins asynchronous operation *OperationName* and returns an object that implements the <xref:System.IAsyncResult> interface.</span></span> <span data-ttu-id="5ec2b-114"><xref:System.IAsyncResult> 对象存储有关异步操作的信息。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-114"><xref:System.IAsyncResult> objects store information about an asynchronous operation.</span></span> <span data-ttu-id="5ec2b-115">下表显示有关异步操作的信息。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-115">The following table shows information about an asynchronous operation.</span></span>  
  
|<span data-ttu-id="5ec2b-116">成员</span><span class="sxs-lookup"><span data-stu-id="5ec2b-116">Member</span></span>|<span data-ttu-id="5ec2b-117">描述</span><span class="sxs-lookup"><span data-stu-id="5ec2b-117">Description</span></span>|  
|------------|-----------------|  
|<xref:System.IAsyncResult.AsyncState%2A>|<span data-ttu-id="5ec2b-118">一个特定于应用程序的可选对象，其中包含有关异步操作的信息。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-118">An optional application-specific object that contains information about the asynchronous operation.</span></span>|  
|<xref:System.IAsyncResult.AsyncWaitHandle%2A>|<span data-ttu-id="5ec2b-119">一个 <xref:System.Threading.WaitHandle> ，可用来在异步操作完成之前阻止应用程序执行。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-119">A <xref:System.Threading.WaitHandle> that can be used to block application execution until the asynchronous operation completes.</span></span>|  
|<xref:System.IAsyncResult.CompletedSynchronously%2A>|<span data-ttu-id="5ec2b-120">一个值，指示异步操作是否是在用于调用 `BeginOperationName` 的线程上完成，而不是在单独的 <xref:System.Threading.ThreadPool> 线程上完成。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-120">A value that indicates whether the asynchronous operation completed on the thread used to call `BeginOperationName` instead of completing on a separate <xref:System.Threading.ThreadPool> thread.</span></span>|  
|<xref:System.IAsyncResult.IsCompleted%2A>|<span data-ttu-id="5ec2b-121">一个值，指示异步操作是否已完成。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-121">A value that indicates whether the asynchronous operation has completed.</span></span>|  
  
 <span data-ttu-id="5ec2b-122">`BeginOperationName` 方法采用该方法的同步版本的签名中声明的任何参数（由值传递或由引用传递）。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-122">A `BeginOperationName` method takes any parameters declared in the signature of the synchronous version of the method that are passed by value or by reference.</span></span> <span data-ttu-id="5ec2b-123">`BeginOperationName` 方法签名中不包含任何输出参数。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-123">Any out parameters are not part of the `BeginOperationName` method signature.</span></span> <span data-ttu-id="5ec2b-124">`BeginOperationName` 方法签名另外还包括两个其他参数。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-124">The `BeginOperationName` method signature also includes two additional parameters.</span></span> <span data-ttu-id="5ec2b-125">第一个参数定义一个 <xref:System.AsyncCallback> 委托，此委托引用在异步操作完成时调用的方法。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-125">The first of these defines an <xref:System.AsyncCallback> delegate that references a method that is called when the asynchronous operation completes.</span></span> <span data-ttu-id="5ec2b-126">如果调用方不希望在操作完成后调用方法，它可以指定 `null` （在 Visual Basic 中为`Nothing` ）。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-126">The caller can specify `null` (`Nothing` in Visual Basic) if it does not want a method invoked when the operation completes.</span></span> <span data-ttu-id="5ec2b-127">第二个参数是一个用户定义的对象。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-127">The second additional parameter is a user-defined object.</span></span> <span data-ttu-id="5ec2b-128">此对象可用来向异步操作完成时调用的方法传递应用程序特定的状态信息。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-128">This object can be used to pass application-specific state information to the method invoked when the asynchronous operation completes.</span></span> <span data-ttu-id="5ec2b-129">如果 `BeginOperationName` 方法还采用其他一些操作特定的参数（例如，一个用于存储从文件读取的字节的字节数组），则 <xref:System.AsyncCallback> 和应用程序状态对象将是 `BeginOperationName` 方法签名中的最后两个参数。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-129">If a `BeginOperationName` method takes additional operation-specific parameters, such as a byte array to store bytes read from a file, the <xref:System.AsyncCallback> and application state object are the last parameters in the `BeginOperationName` method signature.</span></span>  
  
 <span data-ttu-id="5ec2b-130">`BeginOperationName` 立即返回对调用线程的控制。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-130">`BeginOperationName` returns control to the calling thread immediately.</span></span> <span data-ttu-id="5ec2b-131">如果 `BeginOperationName` 方法引发异常，则会在开始异步操作之前引发异常。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-131">If the `BeginOperationName` method throws exceptions, the exceptions are thrown before the asynchronous operation is started.</span></span> <span data-ttu-id="5ec2b-132">如果 `BeginOperationName` 方法引发异常，则意味着没有调用回调方法。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-132">If the `BeginOperationName` method throws exceptions, the callback method is not invoked.</span></span>  
  
## <a name="ending-an-asynchronous-operation"></a><span data-ttu-id="5ec2b-133">结束异步操作</span><span class="sxs-lookup"><span data-stu-id="5ec2b-133">Ending an Asynchronous Operation</span></span>  

 <span data-ttu-id="5ec2b-134">`EndOperationName` 方法用于结束异步操作 OperationName。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-134">The `EndOperationName` method ends asynchronous operation *OperationName*.</span></span> <span data-ttu-id="5ec2b-135">`EndOperationName` 方法的返回值与其同步对应方法的返回值类型相同，并且是特定于异步操作的。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-135">The return value of the `EndOperationName` method is the same type returned by its synchronous counterpart and is specific to the asynchronous operation.</span></span> <span data-ttu-id="5ec2b-136">例如， <xref:System.IO.FileStream.EndRead%2A> 方法返回从 <xref:System.IO.FileStream> 读取的字节数， <xref:System.Net.Dns.EndGetHostByName%2A> 方法返回包含有关主机的信息的 <xref:System.Net.IPHostEntry> 对象。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-136">For example, the <xref:System.IO.FileStream.EndRead%2A> method returns the number of bytes read from a <xref:System.IO.FileStream> and the <xref:System.Net.Dns.EndGetHostByName%2A> method returns an <xref:System.Net.IPHostEntry> object that contains information about a host computer.</span></span> <span data-ttu-id="5ec2b-137">`EndOperationName` 方法采用该方法同步版本的签名中声明的所有输出参数或引用参数。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-137">The `EndOperationName` method takes any out or ref parameters declared in the signature of the synchronous version of the method.</span></span> <span data-ttu-id="5ec2b-138">除了来自同步方法的参数外，`EndOperationName` 方法还包括 <xref:System.IAsyncResult> 参数。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-138">In addition to the parameters from the synchronous method, the `EndOperationName` method also includes an <xref:System.IAsyncResult> parameter.</span></span> <span data-ttu-id="5ec2b-139">调用方必须将对应调用返回的实例传递给 `BeginOperationName`。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-139">Callers must pass the instance returned by the corresponding call to `BeginOperationName`.</span></span>  
  
 <span data-ttu-id="5ec2b-140">如果调用 `EndOperationName` 时 <xref:System.IAsyncResult> 对象表示的异步操作尚未完成，则 `EndOperationName` 将在异步操作完成之前阻止调用线程。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-140">If the asynchronous operation represented by the <xref:System.IAsyncResult> object has not completed when `EndOperationName` is called, `EndOperationName` blocks the calling thread until the asynchronous operation is complete.</span></span> <span data-ttu-id="5ec2b-141">异步操作引发的异常是从 `EndOperationName` 方法引发的。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-141">Exceptions thrown by the asynchronous operation are thrown from the `EndOperationName` method.</span></span> <span data-ttu-id="5ec2b-142">未定义多次使用同一 <xref:System.IAsyncResult> 调用 `EndOperationName` 方法的效果。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-142">The effect of calling the `EndOperationName` method multiple times with the same <xref:System.IAsyncResult> is not defined.</span></span> <span data-ttu-id="5ec2b-143">同样，也未定义使用 <xref:System.IAsyncResult>（相关 Begin 方法未返回）调用 `EndOperationName` 方法的效果。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-143">Likewise, calling the `EndOperationName` method with an <xref:System.IAsyncResult> that was not returned by the related Begin method is also not defined.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5ec2b-144">对于这两种未定义的情况，实施者应考虑引发 <xref:System.InvalidOperationException>。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-144">For either of the undefined scenarios, implementers should consider throwing <xref:System.InvalidOperationException>.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5ec2b-145">此设计模式的实施者应通知调用方异步操作已通过以下步骤完成：将 <xref:System.IAsyncResult.IsCompleted%2A> 设置为 true，调用异步回调方法（如果已指定一个回调方法），然后发送 <xref:System.IAsyncResult.AsyncWaitHandle%2A>信号。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-145">Implementers of this design pattern should notify the caller that the asynchronous operation completed by setting <xref:System.IAsyncResult.IsCompleted%2A> to true, calling the asynchronous callback method (if one was specified) and signaling the <xref:System.IAsyncResult.AsyncWaitHandle%2A>.</span></span>  
  
 <span data-ttu-id="5ec2b-146">对于访问异步操作的结果，应用程序开发人员有若干种设计选择。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-146">Application developers have several design choices for accessing the results of the asynchronous operation.</span></span> <span data-ttu-id="5ec2b-147">正确的选择取决于应用程序是否有可以在操作完成时执行的指令。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-147">The correct choice depends on whether the application has instructions that can execute while the operation completes.</span></span> <span data-ttu-id="5ec2b-148">如果应用程序在接收到异步操作结果之前不能进行任何其他工作，则必须在获得这些结果之前先阻止该应用程序进行其他工作。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-148">If an application cannot perform any additional work until it receives the results of the asynchronous operation, the application must block until the results are available.</span></span> <span data-ttu-id="5ec2b-149">若要在异步操作完成之前阻止应用程序，可以使用下列方法之一：</span><span class="sxs-lookup"><span data-stu-id="5ec2b-149">To block until an asynchronous operation completes, you can use one of the following approaches:</span></span>  
  
- <span data-ttu-id="5ec2b-150">从应用程序的主线程调用 `EndOperationName`，阻止应用程序执行，直到操作完成之后再继续执行。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-150">Call `EndOperationName` from the application’s main thread, blocking application execution until the operation is complete.</span></span> <span data-ttu-id="5ec2b-151">有关展示了此方法的示例，请参阅[通过结束异步操作阻止应用执行](blocking-application-execution-by-ending-an-async-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-151">For an example that illustrates this technique, see [Blocking Application Execution by Ending an Async Operation](blocking-application-execution-by-ending-an-async-operation.md).</span></span>  
  
- <span data-ttu-id="5ec2b-152">使用 <xref:System.IAsyncResult.AsyncWaitHandle%2A> 来阻止应用程序执行，直到一个或多个操作完成。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-152">Use the <xref:System.IAsyncResult.AsyncWaitHandle%2A> to block application execution until one or more operations are complete.</span></span> <span data-ttu-id="5ec2b-153">有关演示此方法的示例，请参阅 “[使用 AsyncWaitHandle 阻止应用程序的执行](blocking-application-execution-using-an-asyncwaithandle.md)”。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-153">For an example that illustrates this technique, see [Blocking Application Execution Using an AsyncWaitHandle](blocking-application-execution-using-an-asyncwaithandle.md).</span></span>  
  
 <span data-ttu-id="5ec2b-154">在异步操作完成时不需要阻止的应用程序可使用下列方法之一：</span><span class="sxs-lookup"><span data-stu-id="5ec2b-154">Applications that do not need to block while the asynchronous operation completes can use one of the following approaches:</span></span>  
  
- <span data-ttu-id="5ec2b-155">按以下方式轮询操作完成状态：定期检查 <xref:System.IAsyncResult.IsCompleted%2A> 属性，操作完成后调用 `EndOperationName`。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-155">Poll for operation completion status by checking the <xref:System.IAsyncResult.IsCompleted%2A> property periodically and calling `EndOperationName` when the operation is complete.</span></span> <span data-ttu-id="5ec2b-156">有关演示此方法的示例，请参阅 [轮询异步操作的状态](polling-for-the-status-of-an-asynchronous-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-156">For an example that illustrates this technique, see [Polling for the Status of an Asynchronous Operation](polling-for-the-status-of-an-asynchronous-operation.md).</span></span>  
  
- <span data-ttu-id="5ec2b-157">使用 <xref:System.AsyncCallback> 委托来指定要在操作完成时调用的方法。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-157">Use an <xref:System.AsyncCallback> delegate to specify a method to be invoked when the operation is complete.</span></span> <span data-ttu-id="5ec2b-158">有关演示此方法的示例，请参阅 [使用 AsyncCallback 委托结束异步操作](using-an-asynccallback-delegate-to-end-an-asynchronous-operation.md)。</span><span class="sxs-lookup"><span data-stu-id="5ec2b-158">For an example that illustrates this technique, see [Using an AsyncCallback Delegate to End an Asynchronous Operation](using-an-asynccallback-delegate-to-end-an-asynchronous-operation.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="5ec2b-159">请参阅</span><span class="sxs-lookup"><span data-stu-id="5ec2b-159">See also</span></span>

- [<span data-ttu-id="5ec2b-160">基于事件的异步模式 (EAP)</span><span class="sxs-lookup"><span data-stu-id="5ec2b-160">Event-based Asynchronous Pattern (EAP)</span></span>](event-based-asynchronous-pattern-eap.md)
- [<span data-ttu-id="5ec2b-161">使用异步方式调用同步方法</span><span class="sxs-lookup"><span data-stu-id="5ec2b-161">Calling Synchronous Methods Asynchronously</span></span>](calling-synchronous-methods-asynchronously.md)
- [<span data-ttu-id="5ec2b-162">使用 AsyncCallback 委托和状态对象</span><span class="sxs-lookup"><span data-stu-id="5ec2b-162">Using an AsyncCallback Delegate and State Object</span></span>](using-an-asynccallback-delegate-and-state-object.md)

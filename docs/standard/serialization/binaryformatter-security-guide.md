---
title: BinaryFormatter 安全指南
description: 本文介绍了 BinaryFormatter 类型中固有的安全风险，以及针对要使用的不同序列化程序的建议。
ms.date: 07/11/2020
ms.author: levib
author: GrabYourPitchforks
ms.openlocfilehash: 2c76a81650e5b83677f6c4df64770bd1ef5f775e
ms.sourcegitcommit: cbb19e56d48cf88375d35d0c27554d4722761e0d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/19/2020
ms.locfileid: "88607927"
---
# <a name="binaryformatter-security-guide"></a><span data-ttu-id="b19ba-103">BinaryFormatter 安全指南</span><span class="sxs-lookup"><span data-stu-id="b19ba-103">BinaryFormatter security guide</span></span>

<span data-ttu-id="b19ba-104">本文适用于以下 .NET 实现：</span><span class="sxs-lookup"><span data-stu-id="b19ba-104">This article applies to the following .NET implementations:</span></span>

* <span data-ttu-id="b19ba-105">所有版本的 .NET Framework</span><span class="sxs-lookup"><span data-stu-id="b19ba-105">.NET Framework all versions</span></span>
* <span data-ttu-id="b19ba-106">.NET Core 2.1 - 3.1</span><span class="sxs-lookup"><span data-stu-id="b19ba-106">.NET Core 2.1 - 3.1</span></span>
* <span data-ttu-id="b19ba-107">.NET 5.0 及更高版本</span><span class="sxs-lookup"><span data-stu-id="b19ba-107">.NET 5.0 and later</span></span>

## <a name="background"></a><span data-ttu-id="b19ba-108">背景</span><span class="sxs-lookup"><span data-stu-id="b19ba-108">Background</span></span>

> [!WARNING]
> <span data-ttu-id="b19ba-109"><xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter> 类型会带来风险，不建议将其用于数据处理。</span><span class="sxs-lookup"><span data-stu-id="b19ba-109">The <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter> type is dangerous and is ***not*** recommended for data processing.</span></span> <span data-ttu-id="b19ba-110">即使应用程序认为自己正在处理的数据是可信的，也应尽快停止使用 `BinaryFormatter`。</span><span class="sxs-lookup"><span data-stu-id="b19ba-110">Applications should stop using `BinaryFormatter` as soon as possible, even if they believe the data they're processing to be trustworthy.</span></span> <span data-ttu-id="b19ba-111">`BinaryFormatter` 不安全，无法确保安全。</span><span class="sxs-lookup"><span data-stu-id="b19ba-111">`BinaryFormatter` is insecure and can't be made secure.</span></span>

<span data-ttu-id="b19ba-112">本文适用于以下类型：</span><span class="sxs-lookup"><span data-stu-id="b19ba-112">This article also applies to the following types:</span></span>

* <xref:System.Runtime.Serialization.Formatters.Soap.SoapFormatter>
* <xref:System.Runtime.Serialization.NetDataContractSerializer>
* <xref:System.Web.UI.LosFormatter>
* <xref:System.Web.UI.ObjectStateFormatter>

<span data-ttu-id="b19ba-113">反序列化漏洞是指不安全地处理请求有效负载的威胁类别。</span><span class="sxs-lookup"><span data-stu-id="b19ba-113">Deserialization vulnerabilities are a threat category where request payloads are processed insecurely.</span></span> <span data-ttu-id="b19ba-114">成功利用这些漏洞攻击应用的攻击者可导致目标应用内出现拒绝服务 (DoS)、信息泄露或远程代码执行。</span><span class="sxs-lookup"><span data-stu-id="b19ba-114">An attacker who successfully leverages these vulnerabilities against an app can cause denial of service (DoS), information disclosure, or remote code execution inside the target app.</span></span> <span data-ttu-id="b19ba-115">此风险类别始终是 [10 项最严重的 OWASP 风险](https://owasp.org/www-project-top-ten/)之一。</span><span class="sxs-lookup"><span data-stu-id="b19ba-115">This risk category consistently makes the [OWASP Top 10](https://owasp.org/www-project-top-ten/).</span></span> <span data-ttu-id="b19ba-116">攻击目标包括使用[多种语言](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data)（包括 C/C++、Java 和 C#）编写的应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-116">Targets include apps written in [a variety of languages](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data), including C/C++, Java, and C#.</span></span>

<span data-ttu-id="b19ba-117">在 .NET 中，风险最大的目标是使用 <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter> 类型来反序列化数据的应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-117">In .NET, the biggest risk target is apps that use the <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter> type to deserialize data.</span></span> <span data-ttu-id="b19ba-118">`BinaryFormatter` 因为其强大的功能和易用性而广泛用于整个 .NET 生态系统。</span><span class="sxs-lookup"><span data-stu-id="b19ba-118">`BinaryFormatter` is widely used throughout the .NET ecosystem because of its power and its ease of use.</span></span> <span data-ttu-id="b19ba-119">但是，其强大的功能也让攻击者能够影响目标应用内的控制流。</span><span class="sxs-lookup"><span data-stu-id="b19ba-119">However, this same power gives attackers the ability to influence control flow within the target app.</span></span> <span data-ttu-id="b19ba-120">成功的攻击可能导致攻击者能够在目标进程的上下文中运行代码。</span><span class="sxs-lookup"><span data-stu-id="b19ba-120">Successful attacks can result in the attacker being able to run code within the context of the target process.</span></span>

<span data-ttu-id="b19ba-121">更简单的比喻是，假设在有效负载上调用 `BinaryFormatter.Deserialize` 相当于将该有效负载解释为独立的可执行文件并启动它。</span><span class="sxs-lookup"><span data-stu-id="b19ba-121">As a simpler analogy, assume that calling `BinaryFormatter.Deserialize` over a payload is the equivalent of interpreting that payload as a standalone executable and launching it.</span></span>

## <a name="binaryformatter-security-vulnerabilities"></a><span data-ttu-id="b19ba-122">BinaryFormatter 安全漏洞</span><span class="sxs-lookup"><span data-stu-id="b19ba-122">BinaryFormatter security vulnerabilities</span></span>

> [!WARNING]
> <span data-ttu-id="b19ba-123">将 `BinaryFormatter.Deserialize` 方法用于不受信任的输入时，该方法永远都不安全。</span><span class="sxs-lookup"><span data-stu-id="b19ba-123">The `BinaryFormatter.Deserialize` method is __never__ safe when used with untrusted input.</span></span> <span data-ttu-id="b19ba-124">强烈建议使用者改为考虑使用本文后面概述的替代方法之一。</span><span class="sxs-lookup"><span data-stu-id="b19ba-124">We strongly recommend that consumers instead consider using one of the alternatives outlined later in this article.</span></span>

<span data-ttu-id="b19ba-125">`BinaryFormatter` 是在反序列化漏洞成为一个众所周知的威胁类别之前实现的。</span><span class="sxs-lookup"><span data-stu-id="b19ba-125">`BinaryFormatter` was implemented before deserialization vulnerabilities were a well-understood threat category.</span></span> <span data-ttu-id="b19ba-126">因此，代码不遵循现代最佳做法。</span><span class="sxs-lookup"><span data-stu-id="b19ba-126">As a result, the code does not follow modern best practices.</span></span> <span data-ttu-id="b19ba-127">`Deserialize` 方法可用作攻击者对使用中的应用执行 DoS 攻击的载体。</span><span class="sxs-lookup"><span data-stu-id="b19ba-127">The `Deserialize` method can be used as a vector for attackers to perform DoS attacks against consuming apps.</span></span> <span data-ttu-id="b19ba-128">这些攻击可能导致应用无响应或进程意外终止。</span><span class="sxs-lookup"><span data-stu-id="b19ba-128">These attacks might render the app unresponsive or result in unexpected process termination.</span></span> <span data-ttu-id="b19ba-129">使用 `SerializationBinder` 或任何其他 `BinaryFormatter` 配置开关都无法缓解此类攻击。</span><span class="sxs-lookup"><span data-stu-id="b19ba-129">This category of attack cannot be mitigated with a `SerializationBinder` or any other `BinaryFormatter` configuration switch.</span></span> <span data-ttu-id="b19ba-130">.NET 认为此行为是设计使然，因此不会发布代码更新来修改此行为。</span><span class="sxs-lookup"><span data-stu-id="b19ba-130">.NET considers this behavior to be ***by design*** and won't issue a code update to modify the behavior.</span></span>

<span data-ttu-id="b19ba-131">使用 `BinaryFormatter.Deserialize` 可能容易遭受其他攻击类别的攻击，如信息泄露或远程代码执行。</span><span class="sxs-lookup"><span data-stu-id="b19ba-131">`BinaryFormatter.Deserialize` may be vulnerable to other attack categories, such as information disclosure or remote code execution.</span></span> <span data-ttu-id="b19ba-132">利用自定义 <xref:System.Runtime.Serialization.SerializationBinder> 等功能可能不足以适当缓解这些风险。</span><span class="sxs-lookup"><span data-stu-id="b19ba-132">Utilizing features such as a custom <xref:System.Runtime.Serialization.SerializationBinder> may be insufficient to properly mitigate these risks.</span></span> <span data-ttu-id="b19ba-133">存在发现新漏洞的可能性，而 .NET 实际上无法为此发布安全更新。</span><span class="sxs-lookup"><span data-stu-id="b19ba-133">The possibility exists that a novel vulnerability will be discovered for which .NET cannot practically publish a security update.</span></span> <span data-ttu-id="b19ba-134">使用者应该评估其各个应用场景，并考虑他们遇到这些风险的可能性。</span><span class="sxs-lookup"><span data-stu-id="b19ba-134">Consumers should assess their individual scenarios and consider their potential exposure to these risks.</span></span>

<span data-ttu-id="b19ba-135">我们建议 `BinaryFormatter` 使用者对其应用执行单独的风险评估。</span><span class="sxs-lookup"><span data-stu-id="b19ba-135">We recommend that `BinaryFormatter` consumers perform individual risk assessments on their apps.</span></span> <span data-ttu-id="b19ba-136">由使用者完全负责确定是否利用 `BinaryFormatter`。</span><span class="sxs-lookup"><span data-stu-id="b19ba-136">It is the consumer's sole responsibility to determine whether to utilize `BinaryFormatter`.</span></span> <span data-ttu-id="b19ba-137">使用者应该对使用 `BinaryFormatter` 的安全性、技术、声誉、法律和监管要求进行风险评估。</span><span class="sxs-lookup"><span data-stu-id="b19ba-137">Consumers should risk assess the security, technical, reputation, legal, and regulatory requirements of using `BinaryFormatter`.</span></span>

## <a name="preferred-alternatives"></a><span data-ttu-id="b19ba-138">首选替代方法</span><span class="sxs-lookup"><span data-stu-id="b19ba-138">Preferred alternatives</span></span>

<span data-ttu-id="b19ba-139">.NET 提供了多个随附的序列化程序，可用于安全处理不受信任的数据：</span><span class="sxs-lookup"><span data-stu-id="b19ba-139">.NET offers several in-box serializers that can handle untrusted data safely:</span></span>

* <span data-ttu-id="b19ba-140"><xref:System.Xml.Serialization.XmlSerializer> 和 <xref:System.Runtime.Serialization.DataContractSerializer>，用于将对象图序列化为 XML 或从 XML 序列化对象图。</span><span class="sxs-lookup"><span data-stu-id="b19ba-140"><xref:System.Xml.Serialization.XmlSerializer> and <xref:System.Runtime.Serialization.DataContractSerializer> to serialize object graphs into and from XML.</span></span> <span data-ttu-id="b19ba-141">不要将 `DataContractSerializer` 与 <xref:System.Runtime.Serialization.NetDataContractSerializer> 混淆。</span><span class="sxs-lookup"><span data-stu-id="b19ba-141">Do not confuse `DataContractSerializer` with  <xref:System.Runtime.Serialization.NetDataContractSerializer>.</span></span>
* <span data-ttu-id="b19ba-142"><xref:System.IO.BinaryReader> 和 <xref:System.IO.BinaryWriter>，适用于 XML 和 JSON。</span><span class="sxs-lookup"><span data-stu-id="b19ba-142"><xref:System.IO.BinaryReader> and <xref:System.IO.BinaryWriter> for XML and JSON.</span></span>
* <span data-ttu-id="b19ba-143"><xref:System.Text.Json> API，用于将对象图序列化为 JSON。</span><span class="sxs-lookup"><span data-stu-id="b19ba-143">The <xref:System.Text.Json> APIs to serialize object graphs into JSON.</span></span>

## <a name="dangerous-alternatives"></a><span data-ttu-id="b19ba-144">危险的替代方法</span><span class="sxs-lookup"><span data-stu-id="b19ba-144">Dangerous alternatives</span></span>

<span data-ttu-id="b19ba-145">避免使用以下序列化程序：</span><span class="sxs-lookup"><span data-stu-id="b19ba-145">Avoid the following serializers:</span></span>

* <xref:System.Runtime.Serialization.Formatters.Soap.SoapFormatter>
* <xref:System.Web.UI.LosFormatter>
* <xref:System.Runtime.Serialization.NetDataContractSerializer>
* <xref:System.Web.UI.ObjectStateFormatter>

<span data-ttu-id="b19ba-146">上述序列化程序都执行不受限制的多态反序列化，并且会带来风险，就像 `BinaryFormatter` 一样。</span><span class="sxs-lookup"><span data-stu-id="b19ba-146">The preceding serializers all perform unrestricted polymorphic deserialization and are dangerous, just like `BinaryFormatter`.</span></span>

## <a name="the-risks-of-assuming-data-to-be-trustworthy"></a><span data-ttu-id="b19ba-147">假设数据值得信任的风险</span><span class="sxs-lookup"><span data-stu-id="b19ba-147">The risks of assuming data to be trustworthy</span></span>

<span data-ttu-id="b19ba-148">通常，应用开发人员可能会认为他们只是在处理受信任的输入。</span><span class="sxs-lookup"><span data-stu-id="b19ba-148">Frequently, an app developer might believe that they are processing only trusted input.</span></span> <span data-ttu-id="b19ba-149">在一些罕见的情况下，可实现真正的安全输入。</span><span class="sxs-lookup"><span data-stu-id="b19ba-149">The safe input case is true in some rare circumstances.</span></span> <span data-ttu-id="b19ba-150">但更常见的情况是，有效负载跨越了信任边界，而开发人员却没有意识到这一点。</span><span class="sxs-lookup"><span data-stu-id="b19ba-150">But it's much more common that a payload crosses a trust boundary without the developer realizing it.</span></span>

<span data-ttu-id="b19ba-151">考虑本地服务器，员工在其中使用其工作站的桌面客户端与服务进行交互。</span><span class="sxs-lookup"><span data-stu-id="b19ba-151">__Consider an on-prem server__ where employees use a desktop client from their workstations to interact with the service.</span></span> <span data-ttu-id="b19ba-152">这个场景可能被天真地视为可以接受使用 `BinaryFormatter` 的“安全”设置。</span><span class="sxs-lookup"><span data-stu-id="b19ba-152">This scenario might be seen naïvely as a "safe" setup where utilizing `BinaryFormatter` is acceptable.</span></span> <span data-ttu-id="b19ba-153">但是，这个场景为恶意软件提供了一个载体，使恶意软件能够访问单个员工的计算机，从而能够在整个企业中传播。</span><span class="sxs-lookup"><span data-stu-id="b19ba-153">However, this scenario presents a vector for malware that gains access to a single employee's machine to be able to spread throughout the enterprise.</span></span> <span data-ttu-id="b19ba-154">该恶意软件可以利用企业使用 `BinaryFormatter` 造成的漏洞，从员工的工作站横向移动到后端服务器。</span><span class="sxs-lookup"><span data-stu-id="b19ba-154">That malware can leverage the enterprise's use of `BinaryFormatter` to move laterally from the employee's workstation to the backend server.</span></span> <span data-ttu-id="b19ba-155">然后，它可以泄露公司的敏感数据。</span><span class="sxs-lookup"><span data-stu-id="b19ba-155">It can then exfiltrate the company's sensitive data.</span></span> <span data-ttu-id="b19ba-156">此类数据可能包括商业机密或客户数据。</span><span class="sxs-lookup"><span data-stu-id="b19ba-156">Such data could include trade secrets or customer data.</span></span>

<span data-ttu-id="b19ba-157">还考虑使用借助 `BinaryFormatter` 来保持保存状态的应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-157">__Consider also an app that uses `BinaryFormatter` to persist save state.__</span></span> <span data-ttu-id="b19ba-158">最初看来这似乎是一个安全的方案，因为在你自己的硬盘驱动器上读写数据威胁较低。</span><span class="sxs-lookup"><span data-stu-id="b19ba-158">This might at first seem to be a safe scenario, as reading and writing data on your own hard drive represents a minor threat.</span></span> <span data-ttu-id="b19ba-159">但是，通过电子邮件或 Internet 共享文档是很常见的，并且大多数最终用户不会认为打开这些下载的文件属于危险行为。</span><span class="sxs-lookup"><span data-stu-id="b19ba-159">However, sharing documents across email or the internet is common, and most end users wouldn't perceive opening these downloaded files as risky behavior.</span></span>

<span data-ttu-id="b19ba-160">攻击者可以利用此场景来制造恶意结果。</span><span class="sxs-lookup"><span data-stu-id="b19ba-160">This scenario can be leveraged to nefarious effect.</span></span> <span data-ttu-id="b19ba-161">如果应用是一款游戏，则共享保存文件的用户会在不知情的情况下面临风险。</span><span class="sxs-lookup"><span data-stu-id="b19ba-161">If the app is a game, users who share save files unknowingly place themselves at risk.</span></span> <span data-ttu-id="b19ba-162">开发者自身也可能成为目标。</span><span class="sxs-lookup"><span data-stu-id="b19ba-162">The developers themselves can also be targeted.</span></span> <span data-ttu-id="b19ba-163">攻击者可能会通过电子邮件向开发者的技术支持人员发送电子邮件，并添加恶意数据文件作为附件，然后要求支持人员打开该文件。</span><span class="sxs-lookup"><span data-stu-id="b19ba-163">The attacker might email the developers' tech support, attaching a malicious data file and asking the support staff to open it.</span></span> <span data-ttu-id="b19ba-164">这种攻击可以为攻击者提供一个在企业中的据点。</span><span class="sxs-lookup"><span data-stu-id="b19ba-164">This kind of attack could give the attacker a foothold in the enterprise.</span></span>

<span data-ttu-id="b19ba-165">另一种场景是数据文件存储在云存储空间中，并在用户的计算机之间自动同步。</span><span class="sxs-lookup"><span data-stu-id="b19ba-165">Another scenario is where the data file is stored in cloud storage and automatically synced between the user's machines.</span></span> <span data-ttu-id="b19ba-166">能够访问云存储帐户的攻击者可以对数据文件进行病毒攻击。</span><span class="sxs-lookup"><span data-stu-id="b19ba-166">An attacker who is able to gain access to the cloud storage account can poison the data file.</span></span> <span data-ttu-id="b19ba-167">此数据文件将自动同步到用户的计算机。</span><span class="sxs-lookup"><span data-stu-id="b19ba-167">This data file will be automatically synced to the user's machines.</span></span> <span data-ttu-id="b19ba-168">用户下一次打开数据文件时，攻击者的有效负载就会运行。</span><span class="sxs-lookup"><span data-stu-id="b19ba-168">The next time the user opens the data file, the attacker's payload runs.</span></span> <span data-ttu-id="b19ba-169">因此，攻击者可以利用云存储帐户泄露来获得完整的代码执行权限。</span><span class="sxs-lookup"><span data-stu-id="b19ba-169">Thus the attacker can leverage a cloud storage account compromise to gain full code execution permissions.</span></span>

<span data-ttu-id="b19ba-170">考虑从桌面安装模型迁移到云优先模型的应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-170">__Consider an app that moves from a desktop-install model to a cloud-first model.__</span></span> <span data-ttu-id="b19ba-171">此场景包括从桌面应用或丰富客户端模型迁移到基于 Web 的模型的应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-171">This scenario includes apps that move from a desktop app or rich client model into a web-based model.</span></span> <span data-ttu-id="b19ba-172">任何为桌面应用绘制的威胁模型都不一定适用于基于云的服务。</span><span class="sxs-lookup"><span data-stu-id="b19ba-172">Any threat models drawn for the desktop app aren't necessarily applicable to the cloud-based service.</span></span> <span data-ttu-id="b19ba-173">桌面应用的威胁模型可能会消除某个给定的威胁，因为“客户端对攻击自己不感兴趣”。</span><span class="sxs-lookup"><span data-stu-id="b19ba-173">The threat model for the desktop app might dismiss a given threat as "not interesting for the client to attack itself."</span></span> <span data-ttu-id="b19ba-174">但是，当考虑到远程用户（客户端）攻击云服务本身时，同样的威胁可能会变得有意义。</span><span class="sxs-lookup"><span data-stu-id="b19ba-174">But that same threat might become interesting when it considers a remote user (the client) attacking the cloud service itself.</span></span>

> [!NOTE]
> <span data-ttu-id="b19ba-175">通常，序列化的目的是将对象传入或传出应用。</span><span class="sxs-lookup"><span data-stu-id="b19ba-175">In general terms, the intent of serialization is to transmit an object into or out of an app.</span></span> <span data-ttu-id="b19ba-176">威胁建模练习几乎始终将此类数据传输标记为跨越信任边界。</span><span class="sxs-lookup"><span data-stu-id="b19ba-176">A threat modeling exercise almost always marks this kind of data transfer as crossing a trust boundary.</span></span>

## <a name="further-resources"></a><span data-ttu-id="b19ba-177">其他资源</span><span class="sxs-lookup"><span data-stu-id="b19ba-177">Further resources</span></span>

* <span data-ttu-id="b19ba-178">[YSoSerial.Net](https://github.com/pwntester/ysoserial.net)，提供有关攻击者如何使用 `BinaryFormatter` 来攻击应用的研究。</span><span class="sxs-lookup"><span data-stu-id="b19ba-178">[YSoSerial.Net](https://github.com/pwntester/ysoserial.net) for research into how adversaries attack apps that utilize `BinaryFormatter`.</span></span>
* <span data-ttu-id="b19ba-179">反序列化漏洞的一般背景：</span><span class="sxs-lookup"><span data-stu-id="b19ba-179">General background on deserialization vulnerabilities:</span></span>
  * [<span data-ttu-id="b19ba-180">10 项最严重的 OWASP 风险 - A8:2017 不安全的反序列化</span><span class="sxs-lookup"><span data-stu-id="b19ba-180">OWASP Top 10 - A8:2017-Insecure Deserialization</span></span>](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A8-Insecure_Deserialization)
  * [<span data-ttu-id="b19ba-181">CWE-502：不受信任的数据的反序列化</span><span class="sxs-lookup"><span data-stu-id="b19ba-181">CWE-502: Deserialization of Untrusted Data</span></span>](https://cwe.mitre.org/data/definitions/502.html)

---
title: 线程与线程处理
description: 了解线程处理，如进程和线程、何时使用多个线程，以及如何在 .NET 中使用多线程处理提高响应能力或吞吐量。
ms.date: 11/08/2018
helpviewer_keywords:
- multiple threads
- threading [.NET]
- threading [.NET], multiple threads
ms.assetid: 5baac3aa-e603-4fa6-9f89-0f2c1084e6b1
ms.openlocfilehash: 20550b597e27c75f00d16528871007988dd6b885
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/18/2020
ms.locfileid: "94819534"
---
# <a name="threads-and-threading"></a><span data-ttu-id="0599a-103">线程与线程处理</span><span class="sxs-lookup"><span data-stu-id="0599a-103">Threads and threading</span></span>

<span data-ttu-id="0599a-104">借助多线程处理，可以提高应用程序的响应能力，如果应用程序在多处理器或多核系统上运行，则可提高其吞吐量。</span><span class="sxs-lookup"><span data-stu-id="0599a-104">Multithreading allows you to increase the responsiveness of your application and, if your application runs on a multiprocessor or multi-core system, increase its throughput.</span></span>

## <a name="processes-and-threads"></a><span data-ttu-id="0599a-105">进程和线程</span><span class="sxs-lookup"><span data-stu-id="0599a-105">Processes and threads</span></span>

<span data-ttu-id="0599a-106">进程是一种正在执行的程序。</span><span class="sxs-lookup"><span data-stu-id="0599a-106">A *process* is an executing program.</span></span> <span data-ttu-id="0599a-107">操作系统使用进程来分隔正在执行的应用程序。</span><span class="sxs-lookup"><span data-stu-id="0599a-107">An operating system uses processes to separate the applications that are being executed.</span></span> <span data-ttu-id="0599a-108">线程是操作系统向其分配处理器时间的基本单元。</span><span class="sxs-lookup"><span data-stu-id="0599a-108">A *thread* is the basic unit to which an operating system allocates processor time.</span></span> <span data-ttu-id="0599a-109">每个线程具有[计划优先级](scheduling-threads.md)并维护系统用于保存线程执行暂停时线程上下文的一组结构。</span><span class="sxs-lookup"><span data-stu-id="0599a-109">Each thread has a [scheduling priority](scheduling-threads.md) and maintains a set of structures the system uses to save the thread context when the thread's execution is paused.</span></span> <span data-ttu-id="0599a-110">线程上下文包含线程顺畅继续执行所需的全部信息，包括线程的一组 CPU 寄存器和堆栈。</span><span class="sxs-lookup"><span data-stu-id="0599a-110">The thread context includes all the information the thread needs to seamlessly resume execution, including the thread's set of CPU registers and stack.</span></span> <span data-ttu-id="0599a-111">多个线程可在进程上下文中运行。</span><span class="sxs-lookup"><span data-stu-id="0599a-111">Multiple threads can run in the context of a process.</span></span> <span data-ttu-id="0599a-112">进程的所有线程共享其虚拟地址空间。</span><span class="sxs-lookup"><span data-stu-id="0599a-112">All threads of a process share its virtual address space.</span></span> <span data-ttu-id="0599a-113">线程可执行任意部分的程序代码，包括其他线程正在执行的部分。</span><span class="sxs-lookup"><span data-stu-id="0599a-113">A thread can execute any part of the program code, including parts currently being executed by another thread.</span></span>

> [!NOTE]
> <span data-ttu-id="0599a-114">.NET Framework 通过使用应用程序域，提供在进程中隔离应用程序的方法。</span><span class="sxs-lookup"><span data-stu-id="0599a-114">.NET Framework provides a way to isolate applications within a process with the use of *application domains*.</span></span> <span data-ttu-id="0599a-115">（应用程序域不适用于 .NET Core。）有关详细信息，请参阅[应用程序域](../../framework/app-domains/application-domains.md)一文中的[应用程序域和线程](../../framework/app-domains/application-domains.md#application-domains-and-threads)部分。</span><span class="sxs-lookup"><span data-stu-id="0599a-115">(Application domains are not available on .NET Core.) For more information, see the [Application domains and threads](../../framework/app-domains/application-domains.md#application-domains-and-threads) section of the [Application domains](../../framework/app-domains/application-domains.md) article.</span></span>

<span data-ttu-id="0599a-116">默认情况下，.NET 程序由单个线程（通常称为主线程）启动。</span><span class="sxs-lookup"><span data-stu-id="0599a-116">By default, a .NET program is started with a single thread, often called the *primary* thread.</span></span> <span data-ttu-id="0599a-117">但是，它可以创建其他线程，以与主线程并行或同时执行代码。</span><span class="sxs-lookup"><span data-stu-id="0599a-117">However, it can create additional threads to execute code in parallel or concurrently with the primary thread.</span></span> <span data-ttu-id="0599a-118">这些线程通常称为工作线程。</span><span class="sxs-lookup"><span data-stu-id="0599a-118">These threads are often called *worker* threads.</span></span>

## <a name="when-to-use-multiple-threads"></a><span data-ttu-id="0599a-119">何时使用多个线程</span><span class="sxs-lookup"><span data-stu-id="0599a-119">When to use multiple threads</span></span>

<span data-ttu-id="0599a-120">使用多线程可以提高应用程序的响应能力，并利用多处理器或多核系统提高应用程序吞吐量。</span><span class="sxs-lookup"><span data-stu-id="0599a-120">You use multiple threads to increase the responsiveness of your application and to take advantage of a multiprocessor or multi-core system to increase the application's throughput.</span></span>

<span data-ttu-id="0599a-121">请思考桌面应用程序，其主线程负责用户界面元素并响应用户操作。</span><span class="sxs-lookup"><span data-stu-id="0599a-121">Consider a desktop application, in which the primary thread is responsible for user interface elements and responds to user actions.</span></span> <span data-ttu-id="0599a-122">使用工作线程执行耗时的操作（这些操作会占用主线程并使用户界面无响应）。</span><span class="sxs-lookup"><span data-stu-id="0599a-122">Use worker threads to perform time-consuming operations that, otherwise, would occupy the primary thread and make the user interface non-responsive.</span></span> <span data-ttu-id="0599a-123">此外，可以使用专用线程，提高网络或设备通信对传入消息或事件的响应能力。</span><span class="sxs-lookup"><span data-stu-id="0599a-123">You can also use a dedicated thread for network or device communication to be more responsive to incoming messages or events.</span></span>

<span data-ttu-id="0599a-124">如果程序执行可并行执行的操作，可通过在单独线程中执行这些操作并在多处理器或多核系统中运行程序减少总执行时间。</span><span class="sxs-lookup"><span data-stu-id="0599a-124">If your program performs operations that can be done in parallel, the total execution time can be decreased by performing those operations in separate threads and running the program on a multiprocessor or multi-core system.</span></span> <span data-ttu-id="0599a-125">在此类系统中，使用多线程处理可能会提高吞吐量和响应能力。</span><span class="sxs-lookup"><span data-stu-id="0599a-125">On such a system, use of multithreading might increase throughput along with the increased responsiveness.</span></span>

## <a name="how-to-use-multithreading-in-net"></a><span data-ttu-id="0599a-126">如何在 .NET 中使用多线程处理</span><span class="sxs-lookup"><span data-stu-id="0599a-126">How to use multithreading in .NET</span></span>

<span data-ttu-id="0599a-127">从 .NET Framework 4 开始，使用多线程的推荐方法是使用[任务并行库 (TPL)](../parallel-programming/task-parallel-library-tpl.md) 和[并行 LINQ (PLINQ)](../parallel-programming/introduction-to-plinq.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-127">Starting with .NET Framework 4, the recommended way to utilize multithreading is to use [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) and [Parallel LINQ (PLINQ)](../parallel-programming/introduction-to-plinq.md).</span></span> <span data-ttu-id="0599a-128">有关详细信息，请参阅[并行编程](../parallel-programming/index.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-128">For more information, see [Parallel programming](../parallel-programming/index.md).</span></span>

<span data-ttu-id="0599a-129">TPL 和 PLINQ 依赖于 <xref:System.Threading.ThreadPool> 线程。</span><span class="sxs-lookup"><span data-stu-id="0599a-129">Both TPL and PLINQ rely on the <xref:System.Threading.ThreadPool> threads.</span></span> <span data-ttu-id="0599a-130"><xref:System.Threading.ThreadPool?displayProperty=nameWithType> 类为 .NET 应用程序提供工作线程池。</span><span class="sxs-lookup"><span data-stu-id="0599a-130">The <xref:System.Threading.ThreadPool?displayProperty=nameWithType> class provides a .NET application with a pool of worker threads.</span></span> <span data-ttu-id="0599a-131">还可使用线程池线程。</span><span class="sxs-lookup"><span data-stu-id="0599a-131">You can also use thread pool threads.</span></span> <span data-ttu-id="0599a-132">有关详细信息，请参阅[托管线程池](the-managed-thread-pool.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-132">For more information, see [The managed thread pool](the-managed-thread-pool.md).</span></span>

<span data-ttu-id="0599a-133">最后，可以使用表示托管线程的 <xref:System.Threading.Thread?displayProperty=nameWithType> 类。</span><span class="sxs-lookup"><span data-stu-id="0599a-133">At last, you can use the <xref:System.Threading.Thread?displayProperty=nameWithType> class that represents a managed thread.</span></span> <span data-ttu-id="0599a-134">有关详细信息，请参阅[使用线程和线程处理](using-threads-and-threading.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-134">For more information, see [Using threads and threading](using-threads-and-threading.md).</span></span>

<span data-ttu-id="0599a-135">多个线程可能需要访问共享的资源。</span><span class="sxs-lookup"><span data-stu-id="0599a-135">Multiple threads might need to access a shared resource.</span></span> <span data-ttu-id="0599a-136">要使资源保持未损坏的状态并避免争用条件，必须同步对资源的线程访问。</span><span class="sxs-lookup"><span data-stu-id="0599a-136">To keep the resource in a uncorrupted state and avoid race conditions, you must synchronize the thread access to it.</span></span> <span data-ttu-id="0599a-137">可能还需要协调多个线程的交互。</span><span class="sxs-lookup"><span data-stu-id="0599a-137">You also might want to coordinate the interaction of multiple threads.</span></span> <span data-ttu-id="0599a-138">.NET 提供了一系列可用于同步对共享资源或协调线程交互的访问的类型。</span><span class="sxs-lookup"><span data-stu-id="0599a-138">.NET provides a range of types that you can use to synchronize access to a shared resource or coordinate thread interaction.</span></span> <span data-ttu-id="0599a-139">有关详细信息，请参阅[同步基元概述](overview-of-synchronization-primitives.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-139">For more information, see [Overview of synchronization primitives](overview-of-synchronization-primitives.md).</span></span>

<span data-ttu-id="0599a-140">请务必处理线程异常。</span><span class="sxs-lookup"><span data-stu-id="0599a-140">Do handle exceptions in threads.</span></span> <span data-ttu-id="0599a-141">线程中未经处理的异常通常会终止进程。</span><span class="sxs-lookup"><span data-stu-id="0599a-141">Unhandled exceptions in threads generally terminate the process.</span></span> <span data-ttu-id="0599a-142">有关详细信息，请参阅[托管线程异常](exceptions-in-managed-threads.md)。</span><span class="sxs-lookup"><span data-stu-id="0599a-142">For more information, see [Exceptions in managed threads](exceptions-in-managed-threads.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="0599a-143">请参阅</span><span class="sxs-lookup"><span data-stu-id="0599a-143">See also</span></span>

- [<span data-ttu-id="0599a-144">线程处理对象和功能</span><span class="sxs-lookup"><span data-stu-id="0599a-144">Threading objects and features</span></span>](threading-objects-and-features.md)
- [<span data-ttu-id="0599a-145">托管线程处理的最佳做法</span><span class="sxs-lookup"><span data-stu-id="0599a-145">Managed threading best practices</span></span>](managed-threading-best-practices.md)
- [<span data-ttu-id="0599a-146">.NET 中的并行处理、并发和异步编程</span><span class="sxs-lookup"><span data-stu-id="0599a-146">Parallel Processing, Concurrency, and Async Programming in .NET</span></span>](../parallel-processing-and-concurrency.md)
- [<span data-ttu-id="0599a-147">关于进程和线程</span><span class="sxs-lookup"><span data-stu-id="0599a-147">About Processes and Threads</span></span>](/windows/desktop/procthread/about-processes-and-threads)

---
title: 数据并行（任务并行库）
description: 了解任务并行库 (TPL) 如何支持数据并行，以在 .NET 中同时对源集合或数组的元素执行相同的操作。
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallelism, data
ms.assetid: 3f05f33f-f1da-4b16-81c2-9ceff1bef449
ms.openlocfilehash: 617757581f6d2491098e1172072bdf0387c6852b
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/15/2020
ms.locfileid: "90558909"
---
# <a name="data-parallelism-task-parallel-library"></a><span data-ttu-id="5d3a2-103">数据并行（任务并行库）</span><span class="sxs-lookup"><span data-stu-id="5d3a2-103">Data Parallelism (Task Parallel Library)</span></span>
<span data-ttu-id="5d3a2-104">*数据并行*指的是对源集合或数组的元素同时（即，并行）执行相同操作的场景。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-104">*Data parallelism* refers to scenarios in which the same operation is performed concurrently (that is, in parallel) on elements in a source collection or array.</span></span> <span data-ttu-id="5d3a2-105">在数据并行操作中，对源集合进行分区，以便多个线程能够同时在不同的网段上操作。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-105">In data parallel operations, the source collection is partitioned so that multiple threads can operate on different segments concurrently.</span></span>  
  
 <span data-ttu-id="5d3a2-106">任务并行库 (TPL) 支持通过 <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType> 类实现的数据并行。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-106">The Task Parallel Library (TPL) supports data parallelism through the <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType> class.</span></span> <span data-ttu-id="5d3a2-107">此类对 [for](../../csharp/language-reference/keywords/for.md) 循环和 [foreach](../../csharp/language-reference/keywords/foreach-in.md) 循环（Visual Basic 中的 `For` 和 `For Each`）提供了基于方法的并行执行。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-107">This class provides method-based parallel implementations of [for](../../csharp/language-reference/keywords/for.md) and [foreach](../../csharp/language-reference/keywords/foreach-in.md) loops (`For` and `For Each` in Visual Basic).</span></span> <span data-ttu-id="5d3a2-108">你为 <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> 或 <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 循环编写的循环逻辑与编写连续循环的相似。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-108">You write the loop logic for a <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> or <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> loop much as you would write a sequential loop.</span></span> <span data-ttu-id="5d3a2-109">无需创建线程或列工作项。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-109">You do not have to create threads or queue work items.</span></span> <span data-ttu-id="5d3a2-110">在基本循环中，不需要加锁。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-110">In basic loops, you do not have to take locks.</span></span> <span data-ttu-id="5d3a2-111">TPL 为你处理所有低级别的工作。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-111">The TPL handles all the low-level work for you.</span></span> <span data-ttu-id="5d3a2-112">有关使用 <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> 和 <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 的详细信息，请下载文档[并行编程模式：了解并应用与 .NET Framework 4 的并行模式](https://www.microsoft.com/download/details.aspx?id=19222)。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-112">For in-depth information about the use of <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType>, download the document [Patterns for Parallel Programming: Understanding and Applying Parallel Patterns with the .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=19222).</span></span> <span data-ttu-id="5d3a2-113">下面的代码示例演示了一个简单的 `foreach` 循环及其并行等效项。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-113">The following code example shows a simple `foreach` loop and its parallel equivalent.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5d3a2-114">本文档使用 lambda 表达式在 TPL 中定义委托。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-114">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="5d3a2-115">如果不熟悉 C# 或 Visual Basic 中的 lambda 表达式，请参阅 [PLINQ 和 TPL 中的 Lambda 表达式](lambda-expressions-in-plinq-and-tpl.md)。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-115">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
 [!code-csharp[TPL#20](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl/cs/tpl.cs#20)]
 [!code-vb[TPL#20](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl/vb/tpl_vb.vb#20)]  
  
 <span data-ttu-id="5d3a2-116">并行循环运行时，TPL 将数据源进行分区，以便该循环可以同时对多个部分进行作用。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-116">When a parallel loop runs, the TPL partitions the data source so that the loop can operate on multiple parts concurrently.</span></span> <span data-ttu-id="5d3a2-117">在后台，任务计划程序基于系统资源和工作负荷来划分任务。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-117">Behind the scenes, the Task Scheduler partitions the task based on system resources and workload.</span></span> <span data-ttu-id="5d3a2-118">如有可能，如果工作负荷变得不平衡了，计划程序将重新分配多个线程与处理器之间的工作。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-118">When possible, the scheduler redistributes work among multiple threads and processors if the workload becomes unbalanced.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5d3a2-119">你也可以提供你自己的自定义分区程序或计划程序。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-119">You can also supply your own custom partitioner or scheduler.</span></span> <span data-ttu-id="5d3a2-120">有关详细信息，请参阅 [PLINQ 和 TPL 的自定义分区程序](custom-partitioners-for-plinq-and-tpl.md)和[任务计划程序](xref:System.Threading.Tasks.TaskScheduler)。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-120">For more information, see [Custom Partitioners for PLINQ and TPL](custom-partitioners-for-plinq-and-tpl.md) and [Task Schedulers](xref:System.Threading.Tasks.TaskScheduler).</span></span>  
  
 <span data-ttu-id="5d3a2-121"><xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> 和 <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 方法都有多个过载，可让你停止或中断循环执行，监视其它线程上循环的状态，保持本地线程状态，完成本地线程对象，控制并发程度等等。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-121">Both the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> methods have several overloads that let you stop or break loop execution, monitor the state of the loop on other threads, maintain thread-local state, finalize thread-local objects, control the degree of concurrency, and so on.</span></span> <span data-ttu-id="5d3a2-122">启用此功能的帮助器类型包括 <xref:System.Threading.Tasks.ParallelLoopState>、<xref:System.Threading.Tasks.ParallelOptions>、<xref:System.Threading.Tasks.ParallelLoopResult>、<xref:System.Threading.CancellationToken> 和 <xref:System.Threading.CancellationTokenSource>。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-122">The helper types that enable this functionality include <xref:System.Threading.Tasks.ParallelLoopState>, <xref:System.Threading.Tasks.ParallelOptions>, <xref:System.Threading.Tasks.ParallelLoopResult>, <xref:System.Threading.CancellationToken>, and <xref:System.Threading.CancellationTokenSource>.</span></span>  
  
 <span data-ttu-id="5d3a2-123">有关详细信息，请参阅[并行编程模式：了解并应用与 .NET Framework 4 的并行模式](https://www.microsoft.com/download/details.aspx?id=19222)。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-123">For more information, see [Patterns for Parallel Programming: Understanding and Applying Parallel Patterns with the .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=19222).</span></span>  
  
 <span data-ttu-id="5d3a2-124">PLINQ 支持使用声明性或查询类语法的数据并行。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-124">Data parallelism with declarative, or query-like, syntax is supported by PLINQ.</span></span> <span data-ttu-id="5d3a2-125">有关详细信息，请参阅[并行 LINQ (PLINQ)](introduction-to-plinq.md)。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-125">For more information, see [Parallel LINQ (PLINQ)](introduction-to-plinq.md).</span></span>  
  
## <a name="related-topics"></a><span data-ttu-id="5d3a2-126">相关主题</span><span class="sxs-lookup"><span data-stu-id="5d3a2-126">Related Topics</span></span>  
  
|<span data-ttu-id="5d3a2-127">Title</span><span class="sxs-lookup"><span data-stu-id="5d3a2-127">Title</span></span>|<span data-ttu-id="5d3a2-128">描述</span><span class="sxs-lookup"><span data-stu-id="5d3a2-128">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="5d3a2-129">如何：编写简单的 Parallel.For 循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-129">How to: Write a Simple Parallel.For Loop</span></span>](how-to-write-a-simple-parallel-for-loop.md)|<span data-ttu-id="5d3a2-130">描述如何编写遍历任何数组或可变址 <xref:System.Collections.Generic.IEnumerable%601> 源集合的 <xref:System.Threading.Tasks.Parallel.For%2A> 循环。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-130">Describes how to write a <xref:System.Threading.Tasks.Parallel.For%2A> loop over any array or indexable <xref:System.Collections.Generic.IEnumerable%601> source collection.</span></span>|  
|[<span data-ttu-id="5d3a2-131">如何：编写简单的 Parallel.ForEach 循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-131">How to: Write a Simple Parallel.ForEach Loop</span></span>](how-to-write-a-simple-parallel-foreach-loop.md)|<span data-ttu-id="5d3a2-132">描述如何编写遍历任何 <xref:System.Collections.Generic.IEnumerable%601> 源集合的 <xref:System.Threading.Tasks.Parallel.ForEach%2A> 循环。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-132">Describes how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop over any <xref:System.Collections.Generic.IEnumerable%601> source collection.</span></span>|  
|<span data-ttu-id="5d3a2-133">[如何：从 Parallel.For 循环停止或中断](/previous-versions/dotnet/netframework-4.0/dd460721(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="5d3a2-133">[How to: Stop or Break from a Parallel.For Loop](/previous-versions/dotnet/netframework-4.0/dd460721(v=vs.100))</span></span>|<span data-ttu-id="5d3a2-134">描述如何停止或中断并行循环，以便所有线程都获得该操作的通知。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-134">Describes how to stop or break from a parallel loop so that all threads are informed of the action.</span></span>|  
|[<span data-ttu-id="5d3a2-135">如何：编写具有线程局部变量的 Parallel.For 循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-135">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](how-to-write-a-parallel-for-loop-with-thread-local-variables.md)|<span data-ttu-id="5d3a2-136">描述如何编写 <xref:System.Threading.Tasks.Parallel.For%2A> 循环，该循环中每个线程都维持有对其它任何线程不可见的私有变量，以及如何在循环完成时，同步所有线程的结果。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-136">Describes how to write a <xref:System.Threading.Tasks.Parallel.For%2A> loop in which each thread maintains a private variable that is not visible to any other threads, and how to synchronize the results from all threads when the loop completes.</span></span>|  
|[<span data-ttu-id="5d3a2-137">如何：使用分区本地变量编写 Parallel.ForEach 循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-137">How to: Write a Parallel.ForEach Loop with Partition-Local Variables</span></span>](how-to-write-a-parallel-foreach-loop-with-partition-local-variables.md)|<span data-ttu-id="5d3a2-138">描述如何编写 <xref:System.Threading.Tasks.Parallel.ForEach%2A> 循环，该循环中每个线程都维持有对其它任何线程不可见的私有变量，以及如何在循环完成时，同步所有线程的结果。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-138">Describes how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop in which each thread maintains a private variable that is not visible to any other threads, and how to synchronize the results from all threads when the loop completes.</span></span>|  
|[<span data-ttu-id="5d3a2-139">如何：取消 Parallel.For 或 ForEach 循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-139">How to: Cancel a Parallel.For or ForEach Loop</span></span>](how-to-cancel-a-parallel-for-or-foreach-loop.md)|<span data-ttu-id="5d3a2-140">描述如何通过使用 <xref:System.Threading.CancellationToken?displayProperty=nameWithType> 取消并行循环</span><span class="sxs-lookup"><span data-stu-id="5d3a2-140">Describes how to cancel a parallel loop by using a <xref:System.Threading.CancellationToken?displayProperty=nameWithType></span></span>|  
|[<span data-ttu-id="5d3a2-141">如何：加快小型循环主体的速度</span><span class="sxs-lookup"><span data-stu-id="5d3a2-141">How to: Speed Up Small Loop Bodies</span></span>](how-to-speed-up-small-loop-bodies.md)|<span data-ttu-id="5d3a2-142">描述在循环主体极小时加快执行速度的方法。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-142">Describes one way to speed up execution when a loop body is very small.</span></span>|  
|[<span data-ttu-id="5d3a2-143">任务并行库 (TPL)</span><span class="sxs-lookup"><span data-stu-id="5d3a2-143">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)|<span data-ttu-id="5d3a2-144">提供任务并行库的概述。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-144">Provides an overview of the Task Parallel Library.</span></span>|  
|[<span data-ttu-id="5d3a2-145">并行编程</span><span class="sxs-lookup"><span data-stu-id="5d3a2-145">Parallel Programming</span></span>](index.md)|<span data-ttu-id="5d3a2-146">介绍.NET Framework 中的并行编程。</span><span class="sxs-lookup"><span data-stu-id="5d3a2-146">Introduces Parallel Programming in the .NET Framework.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="5d3a2-147">请参阅</span><span class="sxs-lookup"><span data-stu-id="5d3a2-147">See also</span></span>

- [<span data-ttu-id="5d3a2-148">并行编程</span><span class="sxs-lookup"><span data-stu-id="5d3a2-148">Parallel Programming</span></span>](index.md)
